<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼«ç”»ãƒãƒ¼ãƒ ã‚¨ãƒ‡ã‚£ã‚¿</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®é«˜ã•ã«åˆã‚ã›ã‚‹ */
            display: flex;
            flex-direction: column;
            background-color: #e0e0e0;
            overflow: hidden; /* å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ç¦æ­¢ (ã‚«ãƒ©ãƒ ã‚¹ãƒ©ã‚¤ãƒ‰ã®ãŸã‚) */
        }

        /* PCç‰ˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆ4ã‚«ãƒ©ãƒ è¡¨ç¤ºï¼‰ */
        .columns-wrapper { /* ã‚«ãƒ©ãƒ å…¨ä½“ã‚’åŒ…ã‚€ãƒ©ãƒƒãƒ‘ãƒ¼ */
            flex-grow: 1;
            display: flex;
            width: 100%; /* PCã§ã¯100%å¹… */
            padding-top: 0;
            padding-bottom: 0;
            box-sizing: border-box;
            overflow-x: auto; /* PCã§ã¯æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ */
            transition: none; /* PCã§ã¯ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã— */
        }

        .column {
            flex-shrink: 0; /* ã‚«ãƒ©ãƒ ãŒç¸®ã¾ãªã„ã‚ˆã†ã« */
            width: 25%; /* PCã§ã¯4åˆ†å‰² */
            height: 100%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ccc;
            box-sizing: border-box;
        }

        .column:last-child {
            border-right: none;
        }

        .column-header {
            background-color: #f4f4f4;
            padding: 10px;
            border-bottom: 1px solid #ccc;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* ãƒ˜ãƒƒãƒ€ãƒ¼ãŒç¸®ã¾ãªã„ã‚ˆã†ã« */
        }

        .column-header .controls {
            display: flex;
            gap: 5px;
        }

        .column-header button, .section-header button {
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
            font-size: 0.8em;
            white-space: nowrap; /* ãƒœã‚¿ãƒ³å†…ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ˜ã‚Šè¿”ã•ãªã„ */
        }

        .column-header button:hover, .section-header button:hover {
            background-color: #e0e0e0;
        }

        .column-content {
            flex-grow: 1;
            overflow-y: auto; /* ã‚«ãƒ©ãƒ å†…éƒ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            padding: 10px;
            box-sizing: border-box;
        }

        textarea {
            width: calc(100% - 20px); /* å·¦å³ã®paddingåˆ†ã‚’å¼•ã */
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical; /* ç¸¦æ–¹å‘ã®ã¿ãƒªã‚µã‚¤ã‚ºå¯èƒ½ */
            min-height: 50px;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap; /* æ”¹è¡Œã¨ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¶­æŒ */
            word-wrap: break-word; /* é•·ã„å˜èªã‚’æŠ˜ã‚Šè¿”ã™ */
            line-height: 1.5;
            box-sizing: border-box; /* paddingã¨borderã‚’widthã«å«ã‚ã‚‹ */
            background-color: #fff;
        }

        /* Section Container Styles */
        .section-container {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
            overflow: hidden; /* toggleã§éš ã‚ŒãŸéƒ¨åˆ†ã‚’éš ã™ãŸã‚ */
        }

        .section-header {
            background-color: #f9f9f9;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; /* ãƒ˜ãƒƒãƒ€ãƒ¼å…¨ä½“ã‚’ã‚«ãƒ¼ã‚½ãƒ«ã§ç¤ºå”† */
        }

        .section-header .title {
            flex-grow: 1;
        }

        .section-content {
            padding: 10px;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 500px; /* åˆæœŸè¡¨ç¤ºã®æœ€å¤§é«˜ã• */
            opacity: 1;
            box-sizing: border-box;
        }

        .section-content.hidden {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
        }

        /* File input hidden */
        #fileInput {
            display: none;
        }

        /* Scene Item Styles */
        .scene-item-container, .page-item-container {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: border-color 0.2s, box-shadow 0.2s;
            position: relative; /* ãƒãƒƒã‚¸ã®ä½ç½®æ±ºã‚ã®ãŸã‚ */
        }

        .scene-item-container.active, .page-item-container.active, .dialogue-content.active {
            border-color: #007bff;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.4);
        }

        .scene-item-container .scene-header, .page-item-container .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .scene-item-container .scene-header .title-badge,
        .page-item-container .page-header .title-badge {
            background-color: #6c757d;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .scene-item-container .delete-btn, .page-item-container .delete-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            margin-left: 10px;
        }

        .scene-item-container textarea, .page-item-container textarea {
            width: 100%; /* è¦ªè¦ç´ ã®paddingã‚’è€ƒæ…®ã—ã¦èª¿æ•´ */
            margin-bottom: 0; /* è¦ªè¦ç´ ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã«ä»»ã›ã‚‹ */
            resize: none; /* è‡ªå‹•ãƒªã‚µã‚¤ã‚ºã®ãŸã‚æ‰‹å‹•ãƒªã‚µã‚¤ã‚ºã¯ç¦æ­¢ */
        }

        /* ã‚·ãƒ¼ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã®èƒŒæ™¯è‰² */
        .scene-item-container.scene-color-0 { background-color: #e6f7ff; } /* Light Blue */
        .scene-item-container.scene-color-1 { background-color: #fff2e6; } /* Light Orange */
        .scene-item-container.scene-color-2 { background-color: #e9ffe6; } /* Light Green */
        .scene-item-container.scene-color-3 { background-color: #f7e6ff; } /* Light Purple */
        .scene-item-container.scene-color-4 { background-color: #fffbe6; } /* Light Yellow */

        /* ãƒšãƒ¼ã‚¸ã‚¢ã‚¤ãƒ†ãƒ ã®è¿½åŠ ãƒœã‚¿ãƒ³ */
        .add-page-to-scene-btn-wrapper {
            text-align: center;
            margin-top: -5px; /* ä¸Šã®ãƒšãƒ¼ã‚¸ã‚¢ã‚¤ãƒ†ãƒ ã¨ã®é–“éš”ã‚’è©°ã‚ã‚‹ */
            margin-bottom: 10px; /* æ¬¡ã®è¦ç´ ã¨ã®é–“éš” */
        }

        .add-page-to-scene-btn {
            background-color: #28a745;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }

        .add-page-to-scene-btn:hover {
            background-color: #218838;
        }

        /* Dialogue Column Specific Styles */
        .serif-page-group-container {
            background-color: #f0f0f0;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 8px;
            margin-bottom: 10px;
        }

        .serif-page-group-container .page-title-in-serif {
            font-weight: bold;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px dotted #ccc;
        }

        .dialogue-content {
            background-color: #fff;
            padding: 8px;
            margin-bottom: 5px;
            border: 1px solid #eee;
            border-radius: 3px;
            font-size: 0.9em;
            line-height: 1.4;
            white-space: pre-wrap; /* æ”¹è¡Œã¨ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¶­æŒ */
            word-wrap: break-word; /* é•·ã„å˜èªã‚’æŠ˜ã‚Šè¿”ã™ */
            cursor: pointer; /* ã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹ãŸã‚ */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .dialogue-content:last-child {
            margin-bottom: 0;
        }


        /* ===================================================================== */
        /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        /* ===================================================================== */
        @media (max-width: 768px) {
            body {
                /* ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã®é«˜ã•ã«åˆã‚ã›ã¦bodyã®paddingã‚’èª¿æ•´ */
                padding-bottom: 60px; /* ãƒ•ãƒƒã‚¿ãƒ¼ã®é«˜ã• + ä½™ç™½ */
            }

            .columns-wrapper {
                width: 400vw; /* 4ã‚«ãƒ©ãƒ ãŒæ¨ªã«ä¸¦ã¶ã‚ˆã†ã« */
                overflow-x: hidden; /* ã‚¹ãƒ¯ã‚¤ãƒ—ã¯JSã§åˆ¶å¾¡ã™ã‚‹ãŸã‚ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã¯éè¡¨ç¤º */
                scroll-behavior: smooth; /* ã‚¹ãƒ ãƒ¼ã‚ºãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆJSã§åˆ¶å¾¡ã•ã‚Œã‚‹ãŒå¿µã®ãŸã‚ï¼‰ */
                transition: transform 0.3s ease-out; /* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            }

            .column {
                width: 100vw; /* å„ã‚«ãƒ©ãƒ ãŒç”»é¢å¹…ã„ã£ã±ã„ã« */
                border-right: none; /* ã‚¹ãƒãƒ›ã§ã¯ã‚«ãƒ©ãƒ é–“ã®å¢ƒç•Œç·šã‚’éè¡¨ç¤º */
            }

            .column-header {
                flex-direction: column; /* ãƒ˜ãƒƒãƒ€ãƒ¼è¦ç´ ã‚’ç¸¦ã«ä¸¦ã¹ã‚‹ */
                align-items: flex-start; /* å·¦å¯„ã› */
                padding: 8px;
            }

            .column-header h2 {
                margin-bottom: 5px; /* ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒœã‚¿ãƒ³ã®é–“ã«å°‘ã—ã‚¹ãƒšãƒ¼ã‚¹ */
            }

            .column-header .controls {
                width: 100%; /* ãƒœã‚¿ãƒ³ç¾¤ã‚’æ¨ªå¹…ã„ã£ã±ã„ã«åºƒã’ã‚‹ */
                justify-content: space-around; /* ãƒœã‚¿ãƒ³ã‚’å‡ç­‰ã«é…ç½® */
                flex-wrap: wrap; /* ãƒœã‚¿ãƒ³ãŒå¤šã„å ´åˆã¯æŠ˜ã‚Šè¿”ã™ */
                gap: 8px; /* ãƒœã‚¿ãƒ³é–“ã®éš™é–“ */
            }

            .column-header button {
                flex-grow: 1; /* ãƒœã‚¿ãƒ³ã®å¹…ã‚’å‡ç­‰ã«åºƒã’ã‚‹ */
                min-width: 80px; /* ãƒœã‚¿ãƒ³ã®æœ€å°å¹… */
                font-size: 0.9em;
                padding: 8px 5px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
            }

            .column-content {
                padding: 8px; /* ã‚«ãƒ©ãƒ å†…å®¹ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
            }

            .section-header {
                padding: 6px 8px;
            }

            .section-content {
                padding: 8px;
            }

            textarea {
                width: calc(100% - 16px); /* å·¦å³ã®paddingåˆ†ã‚’å¼•ã */
                padding: 6px;
                font-size: 0.9em;
            }

            /* ã‚¹ãƒãƒ›ç”¨ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
            #footer-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 55px; /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®é«˜ã• */
                background-color: #333;
                justify-content: space-around;
                align-items: center;
                box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
                z-index: 1000; /* ä»–ã®è¦ç´ ã®ä¸Šã«è¡¨ç¤º */
            }

            #footer-nav button {
                background-color: transparent;
                border: none;
                color: #f4f4f4;
                font-size: 0.8em;
                padding: 5px 0;
                flex-grow: 1;
                text-align: center;
                cursor: pointer;
                outline: none;
                transition: background-color 0.2s, color 0.2s;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            #footer-nav button:hover {
                background-color: #555;
            }

            #footer-nav button.active {
                color: #007bff; /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒœã‚¿ãƒ³ã®è‰² */
                font-weight: bold;
            }
            
            #footer-nav button.active .nav-icon {
                color: #007bff;
            }

            .nav-icon {
                font-size: 1.5em; /* ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚µã‚¤ã‚º */
                margin-bottom: 2px;
                /* ä¾‹ã¨ã—ã¦Font Awesomeã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ãŒã€
                   ã“ã“ã§ã¯ãƒ†ã‚­ã‚¹ãƒˆã§è¡¨ç¾ã—ã¾ã™ */
            }
            
            /* è¡Œç•ªå·ä»˜ããƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚¹ãƒãƒ›èª¿æ•´ */
            .numbered-textarea-wrapper {
                display: flex;
                position: relative;
                width: 100%;
            }

            .line-numbers {
                background-color: #f0f0f0;
                color: #888;
                padding: 8px 5px; /* ã‚¹ãƒãƒ›å‘ã‘ã«èª¿æ•´ */
                font-size: 0.8em; /* ã‚¹ãƒãƒ›å‘ã‘ã«èª¿æ•´ */
                text-align: right;
                border-right: 1px solid #ccc;
                user-select: none;
                flex-shrink: 0; /* ç¸®ã¾ãªã„ã‚ˆã†ã« */
                line-height: 1.5; /* textareaã¨åˆã‚ã›ã‚‹ */
                min-width: 30px; /* æœ€å°å¹…ã‚’è¨­å®š */
            }

            .main-textarea {
                flex-grow: 1;
                width: calc(100% - 40px); /* line-numbersã®å¹…ã‚’è€ƒæ…® */
                padding-left: 8px; /* è¡Œç•ªå·ã¨ã®éš™é–“ */
            }

            @media (max-width: 480px) {
                textarea {
                    font-size: 0.85em; /* ã•ã‚‰ã«å°ã•ã„ç”»é¢å‘ã‘ã«èª¿æ•´ */
                }
                .line-numbers {
                    font-size: 0.75em;
                    min-width: 25px;
                }
            }
        }
    </style>
</head>
<body>
    <div class="columns-wrapper">
        <div class="column" id="main-column">
            <div class="column-header">
                <h2>ãƒ¡ã‚¤ãƒ³</h2>
                <div class="controls">
                    <button id="newBtn">æ–°è¦</button>
                    <input type="file" id="fileInput" accept=".txt">
                    <button id="openBtn">é–‹ã</button>
                    <button id="saveBtn">ä¿å­˜</button>
                    <button id="saveAsBtn">åˆ¥åä¿å­˜</button>
                    <button id="undoBtn">æˆ»ã‚‹</button>
                    <button id="redoBtn">é€²ã‚€</button>
                </div>
            </div>
            <div class="column-content" id="main-column-content">
                <div class="section-container" id="outline-section">
                    <div class="section-header">
                        <span class="title">ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³</span>
                        <button class="toggle-btn">â–²</button>
                    </div>
                    <div class="section-content">
                        <textarea id="outlineEditor" placeholder="ã“ã“ã«ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚"></textarea>
                    </div>
                </div>

                <div class="section-container" id="character-section">
                    <div class="section-header">
                        <span class="title">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</span>
                        <div class="controls">
                            <button id="addCharBtn">è¿½åŠ </button>
                            <button class="toggle-btn">â–²</button>
                        </div>
                    </div>
                    <div class="section-content">
                        <textarea id="characterEditor" placeholder="ã“ã“ã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚"></textarea>
                    </div>
                </div>

                <div class="section-container" id="main-xml-section">
                    <div class="section-header">
                        <span class="title">ãƒãƒ¼ãƒ æœ¬ä½“ (XML)</span>
                        <button class="toggle-btn">â–²</button>
                    </div>
                    <div class="section-content">
                        <div class="numbered-textarea-wrapper">
                            <div class="line-numbers" id="lineNumbers"></div>
                            <textarea id="mainEditor" class="main-textarea" placeholder="ã“ã“ã«ãƒãƒ¼ãƒ ã‚’XMLå½¢å¼ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
ä¾‹:
<root>
    <ã‚·ãƒ¼ãƒ³ ã‚·ãƒ¼ãƒ³å='å­¦æ ¡ç”Ÿæ´»'>
        <ã‚·ãƒ¼ãƒ³èª¬æ˜>ä¸»äººå…¬ãŒå­¦æ ¡ã§æ—¥å¸¸ã‚’éã”ã™æ§˜å­</ã‚·ãƒ¼ãƒ³èª¬æ˜>
        <ãƒšãƒ¼ã‚¸ ãƒšãƒ¼ã‚¸ç•ªå·='1'>
            <ãƒšãƒ¼ã‚¸èª¬æ˜>æœã€ç™»æ ¡ä¸­ã®ä¸»äººå…¬</ãƒšãƒ¼ã‚¸èª¬æ˜>
            <ã‚»ãƒªãƒ• ã‚­ãƒ£ãƒ©='ä¸»äººå…¬'>ã€Œä»Šæ—¥ã‚‚ã„ã„å¤©æ°—ã ãªï¼ã€</ã‚»ãƒªãƒ•>
            <ã‚»ãƒªãƒ• ã‚­ãƒ£ãƒ©='ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³'>ï¼ˆæ–°ã—ã„ä¸€æ—¥ã®å§‹ã¾ã‚Šã ï¼‰</ã‚»ãƒªãƒ•>
        </ãƒšãƒ¼ã‚¸>
        <ãƒšãƒ¼ã‚¸ ãƒšãƒ¼ã‚¸ç•ªå·='2'>
            <ãƒšãƒ¼ã‚¸èª¬æ˜>æˆæ¥­ä¸­ã®æ§˜å­</ãƒšãƒ¼ã‚¸èª¬æ˜>
            <ã‚»ãƒªãƒ• ã‚­ãƒ£ãƒ©='å…ˆç”Ÿ'>ã€Œæ¬¡ã®å•é¡Œã€ã‚ã‹ã‚‹äººï¼Ÿã€</ã‚»ãƒªãƒ•>
            <ã‚»ãƒªãƒ• ã‚­ãƒ£ãƒ©='ä¸»äººå…¬'>ã€Œã¯ã„ã£ï¼ã€</ã‚»ãƒªãƒ•>
        </ãƒšãƒ¼ã‚¸>
    </ã‚·ãƒ¼ãƒ³>
    <ã‚·ãƒ¼ãƒ³ ã‚·ãƒ¼ãƒ³å='æ”¾èª²å¾Œã®å‡ºä¼šã„'>
        <ã‚·ãƒ¼ãƒ³èª¬æ˜>å¶ç„¶ã®å‡ºä¼šã„ã‹ã‚‰ç‰©èªãŒå§‹ã¾ã‚‹</ã‚·ãƒ¼ãƒ³èª¬æ˜>
        <ãƒšãƒ¼ã‚¸ ãƒšãƒ¼ã‚¸ç•ªå·='3'>
            <ãƒšãƒ¼ã‚¸èª¬æ˜>ä¸‹æ ¡ä¸­ã«è¬ã®å°‘å¥³ã¨é­é‡</ãƒšãƒ¼ã‚¸èª¬æ˜>
            <ã‚»ãƒªãƒ• ã‚­ãƒ£ãƒ©='è¬ã®å°‘å¥³'>ã€Œã­ã‡ã€ã‚ãªãŸ...ã€</ã‚»ãƒªãƒ•>
            <ã‚»ãƒªãƒ• ã‚­ãƒ£ãƒ©='ä¸»äººå…¬'>ã€Œãˆã€èª°ï¼Ÿã€</ã‚»ãƒªãƒ•>
        </ãƒšãƒ¼ã‚¸>
    </ã‚·ãƒ¼ãƒ³>
</root>"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="column" id="scene-column">
            <div class="column-header">
                <h2>ã‚·ãƒ¼ãƒ³</h2>
                <div class="controls">
                    <button id="addSceneBtn">ã‚·ãƒ¼ãƒ³è¿½åŠ </button>
                </div>
            </div>
            <div class="column-content" id="scene-list">
                </div>
        </div>

        <div class="column" id="page-column">
            <div class="column-header">
                <h2>ãƒšãƒ¼ã‚¸</h2>
                <div class="controls">
                    </div>
            </div>
            <div class="column-content" id="page-list">
                </div>
        </div>

        <div class="column" id="serif-column">
            <div class="column-header">
                <h2>ã‚»ãƒªãƒ•</h2>
                <div class="controls">
                    <button id="exportDialogueBtn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                </div>
            </div>
            <div class="column-content" id="dialogue-list">
                </div>
        </div>
    </div>

    <footer id="footer-nav">
        <button id="nav-main">
            <span class="nav-icon">ğŸ“–</span>
            <span>ãƒ¡ã‚¤ãƒ³</span>
        </button>
        <button id="nav-scene">
            <span class="nav-icon">ğŸï¸</span>
            <span>ã‚·ãƒ¼ãƒ³</span>
        </button>
        <button id="nav-page">
            <span class="nav-icon">ğŸ“„</span>
            <span>ãƒšãƒ¼ã‚¸</span>
        </button>
        <button id="nav-serif">
            <span class="nav-icon">ğŸ’¬</span>
            <span>ã‚»ãƒªãƒ•</span>
        </button>
    </footer>


    <script>
        const columnsWrapper = document.querySelector('.columns-wrapper');
        const columns = document.querySelectorAll('.column');
        const mainEditor = document.getElementById('mainEditor');
        const outlineEditor = document.getElementById('outlineEditor');
        const characterEditor = document.getElementById('characterEditor');
        const lineNumbers = document.getElementById('lineNumbers');
        const sceneList = document.getElementById('scene-list');
        const pageList = document.getElementById('page-list');
        const dialogueList = document.getElementById('dialogue-list');

        const newBtn = document.getElementById('newBtn');
        const openBtn = document.getElementById('openBtn');
        const fileInput = document.getElementById('fileInput');
        const saveBtn = document.getElementById('saveBtn');
        const saveAsBtn = document.getElementById('saveAsBtn');
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        const addSceneBtn = document.getElementById('addSceneBtn');
        const exportDialogueBtn = document.getElementById('exportDialogueBtn');

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³
        document.querySelectorAll('.section-header .toggle-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation(); // è¦ªè¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãªã„ã‚ˆã†ã«
                const sectionContent = e.target.closest('.section-container').querySelector('.section-content');
                sectionContent.classList.toggle('hidden');
                e.target.textContent = sectionContent.classList.contains('hidden') ? 'â–¼' : 'â–²';
            });
        });

        // ==========================================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ==========================================================
        let currentColumnIndex = 0; // ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚«ãƒ©ãƒ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        let touchStartX = 0;
        let touchEndX = 0;
        let fileHandle = null; // File System Access APIã§é–‹ã„ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒ³ãƒ‰ãƒ«ã‚’ä¿æŒ
        let undoRedoHistory = [];
        let historyPointer = -1;
        const HISTORY_LIMIT = 50; // å±¥æ­´ã®æœ€å¤§æ•°

        // ==========================================================
        // åˆæœŸåŒ–å‡¦ç†
        // ==========================================================
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            updateLineNumbers();
            autoResizeAllTextareas();
            syncColumnsFromMainEditor(); // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«UIã‚’åŒæœŸ

            // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã¯ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ãƒœã‚¿ãƒ³ã‚’åˆæœŸçŠ¶æ…‹ã«è¨­å®š
            if (window.innerWidth <= 768) {
                updateFooterNavActiveButton(currentColumnIndex);
            }
        });

        // ==========================================================
        // ã‚«ãƒ©ãƒ è¡¨ç¤ºåˆ¶å¾¡
        // ==========================================================
        function showColumn(index) {
            if (index < 0 || index >= columns.length) return;

            currentColumnIndex = index;
            // PCã®å ´åˆã¯é€šå¸¸ã®è¡¨ç¤ºã€ã‚¹ãƒãƒ›ã®å ´åˆã¯ã‚¹ãƒ©ã‚¤ãƒ‰
            if (window.innerWidth > 768) {
                columnsWrapper.style.transform = `translateX(0)`; // PCã§ã¯ã‚¹ãƒ©ã‚¤ãƒ‰ã•ã›ãªã„
                columns.forEach((col, i) => {
                    col.style.display = 'flex'; // å…¨ã¦ã®ã‚«ãƒ©ãƒ ã‚’è¡¨ç¤º
                });
            } else {
                columnsWrapper.style.transform = `translateX(-${index * 100}vw)`;
                // ã‚¹ãƒ¯ã‚¤ãƒ—ã«ã‚ˆã‚‹ã‚¹ãƒ ãƒ¼ã‚ºãªç§»å‹•ã®ãŸã‚ã€transitionã¯CSSã§ç®¡ç†
                // columnsWrapper.style.transition = 'transform 0.3s ease-out';
            }
            updateFooterNavActiveButton(index); // ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            saveState(); // ã‚«ãƒ©ãƒ ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’ä¿å­˜
        }

        // ==========================================================
        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢é–¢é€£
        // ==========================================================
        function updateLineNumbers() {
            const lines = mainEditor.value.split('\n');
            lineNumbers.innerHTML = lines.map((_, i) => `<span>${i + 1}</span>`).join('');

            // è¡Œç•ªå·ã®é«˜ã•ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’åŒæœŸ
            // textareaã®scrollHeightã«åŸºã¥ã„ã¦lineNumbersã®é«˜ã•ã‚’èª¿æ•´
            lineNumbers.style.height = `${mainEditor.scrollHeight}px`;
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto'; // ä¸€åº¦é«˜ã•ã‚’ãƒªã‚»ãƒƒãƒˆ
            textarea.style.height = textarea.scrollHeight + 'px'; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸã«åˆã‚ã›ã¦é«˜ã•ã‚’è¨­å®š
        }

        function autoResizeAllTextareas() {
            document.querySelectorAll('textarea').forEach(textarea => {
                autoResizeTextarea(textarea);
            });
        }

        mainEditor.addEventListener('input', () => {
            updateLineNumbers();
            debouncedUpdateUI(); // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã•ã‚ŒãŸUIæ›´æ–°
            addHistory(); // å±¥æ­´ã«è¿½åŠ 
        });

        // ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¨ãƒ‡ã‚£ã‚¿ã®å¤‰æ›´ã‚‚ãƒ‡ãƒã‚¦ãƒ³ã‚¹æ›´æ–°ã«å«ã‚ã‚‹
        outlineEditor.addEventListener('input', () => {
            autoResizeTextarea(outlineEditor);
            debouncedUpdateUI();
            addHistory(); // å±¥æ­´ã«è¿½åŠ 
        });
        characterEditor.addEventListener('input', () => {
            autoResizeTextarea(characterEditor);
            debouncedUpdateUI();
            addHistory(); // å±¥æ­´ã«è¿½åŠ 
        });


        // ==========================================================
        // XMLè§£æã¨UIåŒæœŸ
        // ==========================================================
        function parseXml(xmlString) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, "text/xml");

                if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                    console.error("XML Parse Error:", xmlDoc.getElementsByTagName("parsererror")[0].textContent);
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã™ã‚‹ãªã©ã®å‡¦ç†ã‚’è¿½åŠ 
                    return null;
                }
                return xmlDoc;
            } catch (e) {
                console.error("XML Parsing failed:", e);
                return null;
            }
        }

        let updateUITimer;
        function debouncedUpdateUI() {
            clearTimeout(updateUITimer);
            updateUITimer = setTimeout(() => {
                syncColumnsFromMainEditor();
                autoResizeAllTextareas();
            }, 500); // 500msã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹
        }

        function syncColumnsFromMainEditor() {
            const xmlString = mainEditor.value.trim(); // ç©ºç™½ã‚’ãƒˆãƒªãƒ 
            if (!xmlString) { // XMLæ–‡å­—åˆ—ãŒç©ºã®å ´åˆ
                console.warn("Main editor is empty. Clearing columns.");
                sceneList.innerHTML = '';
                pageList.innerHTML = '';
                dialogueList.innerHTML = '';
                return; // å‡¦ç†ã‚’ä¸­æ–­
            }

            const xmlDoc = parseXml(xmlString);

            if (!xmlDoc) {
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¯ãƒªã‚¢
                sceneList.innerHTML = '';
                pageList.innerHTML = '';
                dialogueList.innerHTML = '';
                return;
            }

            // ã‚·ãƒ¼ãƒ³ã®æ›´æ–°
            updateSceneColumn(xmlDoc);

            // ãƒšãƒ¼ã‚¸ã®æ›´æ–°
            updatePageColumn(xmlDoc);

            // ã‚»ãƒªãƒ•ã®æ›´æ–°
            updateDialogueColumn(xmlDoc);

            // å…¨ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´
            autoResizeAllTextareas();
        }

        function updateSceneColumn(xmlDoc) {
            sceneList.innerHTML = '';
            const scenes = xmlDoc.querySelectorAll('ã‚·ãƒ¼ãƒ³');
            scenes.forEach((sceneElement, sceneIndex) => {
                const sceneName = sceneElement.getAttribute('ã‚·ãƒ¼ãƒ³å') || `ã‚·ãƒ¼ãƒ³${sceneIndex + 1}`;
                const sceneDesc = sceneElement.querySelector('ã‚·ãƒ¼ãƒ³èª¬æ˜')?.textContent || '';

                const sceneItem = document.createElement('div');
                sceneItem.className = `scene-item-container scene-color-${sceneIndex % 5}`;
                sceneItem.dataset.sceneIndex = sceneIndex; // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿æŒ

                sceneItem.innerHTML = `
                    <div class="scene-header">
                        <span class="title-badge">${sceneName}</span>
                        <button class="delete-btn" data-type="scene">&times;</button>
                    </div>
                    <textarea class="scene-desc-textarea" placeholder="ã‚·ãƒ¼ãƒ³èª¬æ˜">${sceneDesc}</textarea>
                `;
                sceneList.appendChild(sceneItem);

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ 
                sceneItem.querySelector('.scene-desc-textarea').addEventListener('input', (e) => {
                    const editorXmlDoc = parseXml(mainEditor.value);
                    if (editorXmlDoc) {
                        const targetScene = editorXmlDoc.querySelectorAll('ã‚·ãƒ¼ãƒ³')[sceneIndex];
                        if (targetScene) {
                            let descElement = targetScene.querySelector('ã‚·ãƒ¼ãƒ³èª¬æ˜');
                            if (!descElement) {
                                descElement = editorXmlDoc.createElement('ã‚·ãƒ¼ãƒ³èª¬æ˜');
                                targetScene.prepend(descElement); // ã‚·ãƒ¼ãƒ³åã®ç›´å¾Œã«æŒ¿å…¥
                            }
                            descElement.textContent = e.target.value;
                            mainEditor.value = new XMLSerializer().serializeToString(editorXmlDoc);
                            updateLineNumbers();
                            autoResizeTextarea(e.target);
                            addHistory();
                        }
                    }
                });

                sceneItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                    if (confirm(`ã€Œ${sceneName}ã€ã‚·ãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        const editorXmlDoc = parseXml(mainEditor.value);
                        if (editorXmlDoc) {
                            const targetScene = editorXmlDoc.querySelectorAll('ã‚·ãƒ¼ãƒ³')[sceneIndex];
                            if (targetScene) {
                                targetScene.parentNode.removeChild(targetScene);
                                mainEditor.value = new XMLSerializer().serializeToString(editorXmlDoc);
                                updateLineNumbers();
                                debouncedUpdateUI(); // UIå…¨ä½“ã‚’å†åŒæœŸ
                                addHistory();
                            }
                        }
                    }
                });

                // ã‚·ãƒ¼ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã‚¯ãƒªãƒƒã‚¯ã§XMLå†…ã®è©²å½“ã‚·ãƒ¼ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                sceneItem.addEventListener('click', (e) => {
                    highlightElementInEditor(sceneElement);
                });
            });
        }

        function updatePageColumn(xmlDoc) {
            pageList.innerHTML = '';
            const pages = xmlDoc.querySelectorAll('ãƒšãƒ¼ã‚¸');
            pages.forEach((pageElement, pageIndex) => {
                const pageNumber = pageElement.getAttribute('ãƒšãƒ¼ã‚¸ç•ªå·') || `ãƒšãƒ¼ã‚¸${pageIndex + 1}`;
                const pageDesc = pageElement.querySelector('ãƒšãƒ¼ã‚¸èª¬æ˜')?.textContent || '';
                const dialogues = Array.from(pageElement.querySelectorAll('ã‚»ãƒªãƒ•')).map(s => s.textContent).join('\n');

                const pageItem = document.createElement('div');
                pageItem.className = 'page-item-container';
                pageItem.dataset.pageIndex = pageIndex; // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿æŒ

                // ã‚·ãƒ¼ãƒ³åã‚’å–å¾—ã—ã€ãƒšãƒ¼ã‚¸ã«è¡¨ç¤º
                const parentScene = pageElement.closest('ã‚·ãƒ¼ãƒ³');
                const sceneName = parentScene ? parentScene.getAttribute('ã‚·ãƒ¼ãƒ³å') : 'ä¸æ˜ãªã‚·ãƒ¼ãƒ³';

                pageItem.innerHTML = `
                    <div class="page-header">
                        <span class="title-badge">${sceneName} - ${pageNumber}</span>
                        <button class="delete-btn" data-type="page">&times;</button>
                    </div>
                    <textarea class="page-content-textarea" placeholder="ãƒšãƒ¼ã‚¸èª¬æ˜ã¨ã‚»ãƒªãƒ•">${pageDesc}\n${dialogues}</textarea>
                `;
                pageList.appendChild(pageItem);

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ 
                pageItem.querySelector('.page-content-textarea').addEventListener('input', (e) => {
                    const editorXmlDoc = parseXml(mainEditor.value);
                    if (editorXmlDoc) {
                        const targetPage = editorXmlDoc.querySelectorAll('ãƒšãƒ¼ã‚¸')[pageIndex];
                        if (targetPage) {
                            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å†…å®¹ã‚’ã€Œãƒšãƒ¼ã‚¸èª¬æ˜ã€ã¨ã€Œã‚»ãƒªãƒ•ã€ã«åˆ†å‰²ã—ã¦XMLã‚’æ›´æ–°
                            const lines = e.target.value.split('\n');
                            let currentDesc = '';
                            let currentDialogues = [];

                            // ãƒšãƒ¼ã‚¸èª¬æ˜ã¯æœ€åˆã®ç©ºè¡Œã¾ã§ã€ã¾ãŸã¯ã‚»ãƒªãƒ•è¦ç´ ã¾ã§ã¨ä»®å®š
                            let isDescription = true;
                            lines.forEach(line => {
                                if (line.trim() === '' && isDescription) {
                                    isDescription = false; // æœ€åˆã®ç©ºè¡Œã§ãƒšãƒ¼ã‚¸èª¬æ˜ã¯çµ‚äº†
                                } else if (isDescription) {
                                    currentDesc += line + '\n';
                                } else {
                                    currentDialogues.push(line);
                                }
                            });
                            // æœ€å¾Œã®æ”¹è¡Œã‚’å‰Šé™¤
                            currentDesc = currentDesc.trim();

                            let descElement = targetPage.querySelector('ãƒšãƒ¼ã‚¸èª¬æ˜');
                            if (!descElement) {
                                descElement = editorXmlDoc.createElement('ãƒšãƒ¼ã‚¸èª¬æ˜');
                                targetPage.prepend(descElement);
                            }
                            descElement.textContent = currentDesc;

                            // æ—¢å­˜ã®ã‚»ãƒªãƒ•ã‚’ã™ã¹ã¦å‰Šé™¤
                            targetPage.querySelectorAll('ã‚»ãƒªãƒ•').forEach(s => s.parentNode.removeChild(s));

                            // æ–°ã—ã„ã‚»ãƒªãƒ•ã‚’è¿½åŠ 
                            currentDialogues.forEach(dialogueText => {
                                if (dialogueText.trim() !== '') {
                                    const serifElement = editorXmlDoc.createElement('ã‚»ãƒªãƒ•');
                                    serifElement.textContent = dialogueText.trim();
                                    targetPage.appendChild(serifElement);
                                }
                            });

                            mainEditor.value = new XMLSerializer().serializeToString(editorXmlDoc);
                            updateLineNumbers();
                            autoResizeTextarea(e.target);
                            addHistory();
                        }
                    }
                });

                pageItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                    if (confirm(`ã€Œ${pageNumber}ã€ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        const editorXmlDoc = parseXml(mainEditor.value);
                        if (editorXmlDoc) {
                            const targetPage = editorXmlDoc.querySelectorAll('ãƒšãƒ¼ã‚¸')[pageIndex];
                            if (targetPage) {
                                targetPage.parentNode.removeChild(targetPage);
                                mainEditor.value = new XMLSerializer().serializeToString(editorXmlDoc);
                                updateLineNumbers();
                                debouncedUpdateUI(); // UIå…¨ä½“ã‚’å†åŒæœŸ
                                addHistory();
                            }
                        }
                    }
                });

                // ãƒšãƒ¼ã‚¸ã‚¢ã‚¤ãƒ†ãƒ ã‚¯ãƒªãƒƒã‚¯ã§XMLå†…ã®è©²å½“ãƒšãƒ¼ã‚¸ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                pageItem.addEventListener('click', (e) => {
                    highlightElementInEditor(pageElement);
                });
            });
        }


        function updateDialogueColumn(xmlDoc) {
            dialogueList.innerHTML = '';
            const scenes = xmlDoc.querySelectorAll('ã‚·ãƒ¼ãƒ³');

            scenes.forEach(sceneElement => {
                const sceneName = sceneElement.getAttribute('ã‚·ãƒ¼ãƒ³å') || 'ç„¡é¡Œã®ã‚·ãƒ¼ãƒ³';
                const pagesInScene = sceneElement.querySelectorAll('ãƒšãƒ¼ã‚¸');

                pagesInScene.forEach(pageElement => {
                    const pageNumber = pageElement.getAttribute('ãƒšãƒ¼ã‚¸ç•ªå·') || 'ç„¡é¡Œã®ãƒšãƒ¼ã‚¸';
                    const dialogues = pageElement.querySelectorAll('ã‚»ãƒªãƒ•');

                    if (dialogues.length > 0) {
                        const pageGroup = document.createElement('div');
                        pageGroup.className = 'serif-page-group-container';
                        pageGroup.innerHTML = `<div class="page-title-in-serif">${sceneName} - ${pageNumber}</div>`;

                        dialogues.forEach((dialogueElement, dialogueIndex) => {
                            const character = dialogueElement.getAttribute('ã‚­ãƒ£ãƒ©') || 'ä¸æ˜';
                            const dialogueText = dialogueElement.textContent;

                            const dialogueDiv = document.createElement('div');
                            dialogueDiv.className = 'dialogue-content';
                            dialogueDiv.innerHTML = `<strong>${character}:</strong> ${dialogueText}`;
                            pageGroup.appendChild(dialogueDiv);

                            // ã‚»ãƒªãƒ•ã‚¢ã‚¤ãƒ†ãƒ ã‚¯ãƒªãƒƒã‚¯ã§XMLå†…ã®è©²å½“ã‚»ãƒªãƒ•ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                            dialogueDiv.addEventListener('click', (e) => {
                                highlightElementInEditor(dialogueElement);
                            });
                        });
                        dialogueList.appendChild(pageGroup);
                    }
                });
            });
        }

        function highlightElementInEditor(xmlElement) {
            const xmlString = mainEditor.value;
            const lines = xmlString.split('\n');
            let startIndex = -1;
            let endIndex = -1;

            // ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ã§å…ƒã®XMLè¦ç´ ã®æ–‡å­—åˆ—è¡¨ç¾ã‚’å–å¾—
            const serializer = new XMLSerializer();
            const elementString = serializer.serializeToString(xmlElement);
            const startTag = `<${xmlElement.tagName}`;
            const endTag = `</${xmlElement.tagName}>`;

            let accumulatedLength = 0;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const lineLength = line.length + 1; // +1 for newline character

                // é–‹å§‹ã‚¿ã‚°ã®æ¤œç´¢
                if (startIndex === -1 && line.includes(startTag)) {
                    const tagIndexInLine = line.indexOf(startTag);
                    if (elementString.startsWith(line.substring(tagIndexInLine))) {
                        startIndex = accumulatedLength + tagIndexInLine;
                    }
                }

                // çµ‚äº†ã‚¿ã‚°ã®æ¤œç´¢
                if (startIndex !== -1 && endIndex === -1 && line.includes(endTag)) {
                    // ã“ã“ã§ã€ç¾åœ¨ã®è¡ŒãŒhighlightã—ãŸã„è¦ç´ ã®çµ‚äº†ã‚¿ã‚°ã‚’å«ã‚“ã§ã„ã‚‹ã‹ã‚’ç¢ºèª
                    // ã‚·ãƒ³ãƒ—ãƒ«ãªè¦ç´ ã®å ´åˆ (ä¾‹: <ã‚»ãƒªãƒ•>ãƒ†ã‚­ã‚¹ãƒˆ</ã‚»ãƒªãƒ•>)ã€é–‹å§‹è¡Œã¨çµ‚äº†è¡ŒãŒåŒã˜å ´åˆãŒã‚ã‚‹
                    // ãã®å ´åˆã¯ã€é–‹å§‹ä½ç½®ã‹ã‚‰elementStringã®é•·ã•ã§ç¯„å›²ã‚’æ±ºã‚ã‚‹
                    if (elementString.includes(line)) { // elementStringãŒç¾åœ¨ã®è¡Œã«å«ã¾ã‚Œã¦ã„ã‚‹
                        endIndex = startIndex + elementString.length;
                    } else { // è¤‡æ•°è¡Œã«ã¾ãŸãŒã‚‹å ´åˆ
                        const tagIndexInLine = line.indexOf(endTag);
                        // çµ‚äº†ã‚¿ã‚°ã®ç›´å¾Œã¾ã§ã‚’é¸æŠç¯„å›²ã«å«ã‚ã‚‹
                        endIndex = accumulatedLength + tagIndexInLine + endTag.length;
                    }
                }
                
                // é–‹å§‹ã‚¿ã‚°ã¨çµ‚äº†ã‚¿ã‚°ãŒåŒã˜è¡Œã«ã‚ã‚‹å˜ä¸€è¡Œè¦ç´ ã®å ´åˆã®å¯¾å¿œ
                if (startIndex !== -1 && endIndex === -1 && elementString.includes(line) && !line.includes(endTag) && elementString.indexOf(line) === 0) {
                     endIndex = startIndex + elementString.length;
                }


                // æ¤œç´¢æ¸ˆã¿ã®å ´åˆã¯ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                if (startIndex !== -1 && endIndex !== -1) {
                    break;
                }

                accumulatedLength += lineLength;
            }

            if (startIndex !== -1 && endIndex !== -1) {
                mainEditor.focus();
                mainEditor.setSelectionRange(startIndex, endIndex);

                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è¡¨ç¤ºç¯„å›²ã«å…¥ã‚Œã‚‹
                const startLine = xmlString.substring(0, startIndex).split('\n').length - 1;
                const endLine = xmlString.substring(0, endIndex).split('\n').length - 1;
                
                const lineHeight = parseFloat(getComputedStyle(mainEditor).lineHeight) || 18; // CSSã‹ã‚‰è¡Œã®é«˜ã•ã‚’å–å¾—ã€ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                const editorHeight = mainEditor.clientHeight;
                
                const scrollTargetTop = startLine * lineHeight;
                const scrollTargetBottom = (endLine + 1) * lineHeight;

                if (scrollTargetTop < mainEditor.scrollTop || scrollTargetBottom > mainEditor.scrollTop + editorHeight) {
                    // è¦ç´ å…¨ä½“ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’èª¿æ•´
                    mainEditor.scrollTop = scrollTargetTop - (editorHeight / 4); // å°‘ã—ä¸Šã«ä½™ç™½ã‚’æŒãŸã›ã‚‹
                }
            } else {
                console.warn("Could not find element in editor:", xmlElement.tagName, xmlElement.outerHTML);
            }

            // UIä¸Šã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ›´æ–°
            document.querySelectorAll('.scene-item-container, .page-item-container, .dialogue-content').forEach(el => el.classList.remove('active'));
            
            // XMLè¦ç´ ã®ãƒ‘ã‚¹ã‚’è¾¿ã£ã¦UIè¦ç´ ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            let currentXmlEl = xmlElement;
            while(currentXmlEl && currentXmlEl.tagName !== 'root') {
                if (currentXmlEl.tagName === 'ã‚»ãƒªãƒ•') {
                    const parentPage = currentXmlEl.closest('ãƒšãƒ¼ã‚¸');
                    const parentScene = currentXmlEl.closest('ã‚·ãƒ¼ãƒ³');
                    if (parentPage && parentScene) {
                        const pageNumber = parentPage.getAttribute('ãƒšãƒ¼ã‚¸ç•ªå·');
                        const sceneName = parentScene.getAttribute('ã‚·ãƒ¼ãƒ³å');
                        // ã‚»ãƒªãƒ•ã®è¦ªã§ã‚ã‚‹ãƒšãƒ¼ã‚¸ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ¢ã™
                        const targetPageGroup = Array.from(dialogueList.querySelectorAll('.serif-page-group-container')).find(group => {
                            return group.querySelector('.page-title-in-serif').textContent.includes(sceneName) &&
                                   group.querySelector('.page-title-in-serif').textContent.includes(pageNumber);
                        });
                        if (targetPageGroup) {
                            const dialogueContents = Array.from(targetPageGroup.querySelectorAll('.dialogue-content'));
                            // XMLè¦ç´ ã®ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã§ä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’æ¢ã™ï¼ˆå®Œå…¨ä¸€è‡´ã§ã¯ãªã„å¯èƒ½æ€§ã‚ã‚Šï¼‰
                            const targetDialogueDiv = dialogueContents.find(div => div.textContent.includes(currentXmlEl.textContent));
                            if (targetDialogueDiv) {
                                targetDialogueDiv.classList.add('active');
                                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è¡¨ç¤º
                                targetDialogueDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            }
                        }
                    }
                } else if (currentXmlEl.tagName === 'ãƒšãƒ¼ã‚¸') {
                    const targetPageItem = Array.from(pageList.querySelectorAll('.page-item-container')).find(item => 
                        item.dataset.pageIndex == Array.from(xmlElement.ownerDocument.querySelectorAll('ãƒšãƒ¼ã‚¸')).indexOf(currentXmlEl)
                    );
                    if (targetPageItem) {
                        targetPageItem.classList.add('active');
                        targetPageItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                } else if (currentXmlEl.tagName === 'ã‚·ãƒ¼ãƒ³') {
                    const targetSceneItem = Array.from(sceneList.querySelectorAll('.scene-item-container')).find(item => 
                        item.dataset.sceneIndex == Array.from(xmlElement.ownerDocument.querySelectorAll('ã‚·ãƒ¼ãƒ³')).indexOf(currentXmlEl)
                    );
                    if (targetSceneItem) {
                        targetSceneItem.classList.add('active');
                        targetSceneItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
                currentXmlEl = currentXmlEl.parentElement;
            }
        }


        // ==========================================================
        // ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ (æ–°è¦ã€é–‹ãã€ä¿å­˜ã€åˆ¥åä¿å­˜)
        // ==========================================================
        newBtn.addEventListener('click', () => {
            if (confirm('ç¾åœ¨ã®å†…å®¹ã‚’ç ´æ£„ã—ã¦ã€æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) {
                mainEditor.value = `
<root>
    <ã‚·ãƒ¼ãƒ³ ã‚·ãƒ¼ãƒ³å='æ–°ã—ã„ã‚·ãƒ¼ãƒ³'>
        <ã‚·ãƒ¼ãƒ³èª¬æ˜>ã“ã“ã«ã‚·ãƒ¼ãƒ³ã®èª¬æ˜ã‚’è¨˜è¿°ã—ã¾ã™</ã‚·ãƒ¼ãƒ³èª¬æ˜>
        <ãƒšãƒ¼ã‚¸ ãƒšãƒ¼ã‚¸ç•ªå·='1'>
            <ãƒšãƒ¼ã‚¸èª¬æ˜>ã“ã“ã«æ–°ã—ã„ãƒšãƒ¼ã‚¸ã®èª¬æ˜ã‚’è¨˜è¿°ã—ã¾ã™</ãƒšãƒ¼ã‚¸èª¬æ˜>
            <ã‚»ãƒªãƒ• ã‚­ãƒ£ãƒ©='ã‚­ãƒ£ãƒ©å'>ã€Œã‚»ãƒªãƒ•ã€</ã‚»ãƒªãƒ•>
        </ãƒšãƒ¼ã‚¸>
    </ã‚·ãƒ¼ãƒ³>
</root>`.trim();
                outlineEditor.value = '';
                characterEditor.value = '';
                fileHandle = null;
                undoRedoHistory = [];
                historyPointer = -1;
                addHistory(); // åˆæœŸçŠ¶æ…‹ã‚’å±¥æ­´ã«è¿½åŠ 
                debouncedUpdateUI();
                alert('æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸã€‚');
            }
        });

        openBtn.addEventListener('click', () => {
            fileInput.click(); // éš ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯
        });

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                // File System Access APIã§ãƒãƒ³ãƒ‰ãƒ«ã‚’å–å¾— (Chromeãªã©)
                if ('showOpenFilePicker' in window) {
                    const [handle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'Text Files',
                            accept: { 'text/plain': ['.txt'] },
                        }],
                        multiple: false
                    });
                    fileHandle = handle;
                    const fileContents = await fileHandle.getFile();
                    const text = await fileContents.text();
                    loadContentFromFile(text);
                } else { // Fallback for browsers without File System Access API
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        loadContentFromFile(event.target.result);
                    };
                    reader.readAsText(file);
                }
            } catch (error) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        });

        function loadContentFromFile(text) {
            // å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹å§‹ã‚¿ã‚°ã¨çµ‚äº†ã‚¿ã‚°ã‚’å®šç¾©
            const outlineTag = '[ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³:]';
            const charTag = '[ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:]';
            const xmlTag = '[ãƒãƒ¼ãƒ æœ¬ä½“(XML):]';
            // å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’æŠ½å‡º
            let outlineContent = '';
            let characterContent = '';
            let xmlContent = '';

            const lines = text.split('\n');
            let currentSection = '';

            lines.forEach(line => {
                if (line.startsWith(outlineTag)) {
                    currentSection = 'outline';
                } else if (line.startsWith(charTag)) {
                    currentSection = 'character';
                } else if (line.startsWith(xmlTag)) {
                    currentSection = 'xml';
                } else {
                    if (currentSection === 'outline') {
                        outlineContent += line + '\n';
                    } else if (currentSection === 'character') {
                        characterContent += line + '\n';
                    } else if (currentSection === 'xml') {
                        xmlContent += line + '\n';
                    }
                }
            });

            outlineEditor.value = outlineContent.trim();
            characterEditor.value = characterContent.trim();
            mainEditor.value = xmlContent.trim();

            undoRedoHistory = [];
            historyPointer = -1;
            addHistory(); // æ–°ã—ã„å†…å®¹ã‚’å±¥æ­´ã«è¿½åŠ 
            debouncedUpdateUI();
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚');
        }

        saveBtn.addEventListener('click', async () => {
            if (fileHandle) {
                try {
                    const writable = await fileHandle.createWritable();
                    await writable.write(generateFileContent());
                    await writable.close();
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
                } catch (error) {
                    console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    fileHandle = null; // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯ãƒãƒ³ãƒ‰ãƒ«ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã€Œåˆ¥åä¿å­˜ã€ã‚’ä¿ƒã™
                }
            } else {
                saveAsBtn.click(); // ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ«ãŒãªã„å ´åˆã¯ã€Œåˆ¥åä¿å­˜ã€ã‚’å®Ÿè¡Œ
            }
        });

        saveAsBtn.addEventListener('click', async () => {
            try {
                const handle = await window.showSaveFilePicker({
                    types: [{
                        description: 'Text Files',
                        accept: { 'text/plain': ['.txt'] },
                    }],
                    suggestedName: 'untitled.txt'
                });
                const writable = await handle.createWritable();
                await writable.write(generateFileContent());
                await writable.close();
                fileHandle = handle; // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ«ã‚’ä¿å­˜
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ¥åã§ä¿å­˜ã—ã¾ã—ãŸã€‚');
            } catch (error) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        });

        function generateFileContent() {
            let content = '';
            if (outlineEditor.value.trim()) {
                content += '[ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³:]\n' + outlineEditor.value.trim() + '\n\n';
            }
            if (characterEditor.value.trim()) {
                content += '[ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:]\n' + characterEditor.value.trim() + '\n\n';
            }
            if (mainEditor.value.trim()) {
                content += '[ãƒãƒ¼ãƒ æœ¬ä½“(XML):]\n' + mainEditor.value.trim() + '\n\n';
            }
            // ã‚»ãƒªãƒ•ã¯æŠ½å‡ºã—ã¦è¡¨ç¤ºã™ã‚‹ã ã‘ãªã®ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯å«ã‚ãªã„
            // å¿…è¦ã§ã‚ã‚Œã°ã€[ã‚»ãƒªãƒ•ä¸€è¦§:]ãªã©ã¨ã—ã¦å«ã‚ã‚‹ã“ã¨ã‚‚å¯èƒ½ã ãŒã€ä»Šå›ã¯ä¸è¦ã¨åˆ¤æ–­
            return content.trim();
        }

        // ==========================================================
        // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
        // ==========================================================
        const mainColumnContent = document.getElementById('main-column-content');
        mainColumnContent.addEventListener('dragover', (e) => {
            e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æŒ™å‹•ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            e.stopPropagation();
            mainColumnContent.style.backgroundColor = '#f0f8ff'; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦–è¦šçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        });

        mainColumnContent.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            mainColumnContent.style.backgroundColor = ''; // èƒŒæ™¯è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
        });

        mainColumnContent.addEventListener('drop', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            mainColumnContent.style.backgroundColor = ''; // èƒŒæ™¯è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                    try {
                        // File System Access APIã§ãƒãƒ³ãƒ‰ãƒ«ã‚’å–å¾— (Chromeãªã©)
                        if ('showOpenFilePicker' in window) {
                             const [handle] = await window.showOpenFilePicker({
                                types: [{
                                    description: 'Text Files',
                                    accept: { 'text/plain': ['.txt'] },
                                }],
                                multiple: false
                            });
                            fileHandle = handle;
                            const fileContents = await fileHandle.getFile();
                            const text = await fileContents.text();
                            loadContentFromFile(text);
                        } else { // Fallback for browsers without File System Access API
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                loadContentFromFile(event.target.result);
                            };
                            reader.readAsText(file);
                        }
                    } catch (error) {
                        console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                } else {
                    alert('ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.txtï¼‰ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚');
                }
            }
        });


        // ==========================================================
        // å±¥æ­´ç®¡ç† (Undo/Redo)
        // ==========================================================
        function addHistory() {
            const currentState = {
                main: mainEditor.value,
                outline: outlineEditor.value,
                character: characterEditor.value,
            };

            // ç¾åœ¨ã®ãƒã‚¤ãƒ³ã‚¿ã‚ˆã‚Šæ–°ã—ã„å±¥æ­´ã‚’ç ´æ£„
            undoRedoHistory = undoRedoHistory.slice(0, historyPointer + 1);
            // æ–°ã—ã„çŠ¶æ…‹ã‚’è¿½åŠ 
            undoRedoHistory.push(currentState);

            if (undoRedoHistory.length > HISTORY_LIMIT) {
                undoRedoHistory.shift(); // å¤ã„å±¥æ­´ã‚’å‰Šé™¤
            }
            historyPointer = undoRedoHistory.length - 1;
            updateUndoRedoButtons();
            saveState(); // å±¥æ­´ã®çŠ¶æ…‹ã‚‚ä¿å­˜
        }

        function undo() {
            if (historyPointer > 0) {
                historyPointer--;
                applyHistoryState(undoRedoHistory[historyPointer]);
                updateUndoRedoButtons();
            }
        }

        function redo() {
            if (historyPointer < undoRedoHistory.length - 1) {
                historyPointer++;
                applyHistoryState(undoRedoHistory[historyPointer]);
                updateUndoRedoButtons();
            }
        }

        function applyHistoryState(state) {
            mainEditor.value = state.main;
            outlineEditor.value = state.outline;
            characterEditor.value = state.character;
            updateLineNumbers();
            debouncedUpdateUI(); // UIã‚‚æ›´æ–°
        }

        function updateUndoRedoButtons() {
            undoBtn.disabled = historyPointer <= 0;
            redoBtn.disabled = historyPointer >= undoRedoHistory.length - 1;
        }

        undoBtn.addEventListener('click', undo);
        redoBtn.addEventListener('click', redo);

        // ==========================================================
        // ã‚·ãƒ¼ãƒ³ã€ãƒšãƒ¼ã‚¸ã€ã‚»ãƒªãƒ•ã®è¿½åŠ ãƒ»å‰Šé™¤
        // ==========================================================
        addSceneBtn.addEventListener('click', () => {
            const xmlString = mainEditor.value;
            const xmlDoc = parseXml(xmlString);

            if (xmlDoc) {
                const root = xmlDoc.querySelector('root');
                if (!root) {
                    alert('XMLã«<root>è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }

                const newScene = xmlDoc.createElement('ã‚·ãƒ¼ãƒ³');
                const sceneCount = xmlDoc.querySelectorAll('ã‚·ãƒ¼ãƒ³').length;
                newScene.setAttribute('ã‚·ãƒ¼ãƒ³å', `æ–°ã—ã„ã‚·ãƒ¼ãƒ³${sceneCount + 1}`);

                const newSceneDesc = xmlDoc.createElement('ã‚·ãƒ¼ãƒ³èª¬æ˜');
                newSceneDesc.textContent = 'ã“ã“ã«æ–°ã—ã„ã‚·ãƒ¼ãƒ³ã®èª¬æ˜ã‚’è¨˜è¿°ã—ã¾ã™';
                newScene.appendChild(newSceneDesc);

                const newPage = xmlDoc.createElement('ãƒšãƒ¼ã‚¸');
                newPage.setAttribute('ãƒšãƒ¼ã‚¸ç•ªå·', '1');

                const newPageDesc = xmlDoc.createElement('ãƒšãƒ¼ã‚¸èª¬æ˜');
                newPageDesc.textContent = 'ã“ã“ã«æ–°ã—ã„ãƒšãƒ¼ã‚¸ã®èª¬æ˜ã‚’è¨˜è¿°ã—ã¾ã™';
                newPage.appendChild(newPageDesc);

                const newSerif = xmlDoc.createElement('ã‚»ãƒªãƒ•');
                newSerif.setAttribute('ã‚­ãƒ£ãƒ©', 'ã‚­ãƒ£ãƒ©å');
                newSerif.textContent = 'ã€Œã‚»ãƒªãƒ•ã€';
                newPage.appendChild(newSerif);

                newScene.appendChild(newPage);
                root.appendChild(newScene);

                mainEditor.value = new XMLSerializer().serializeToString(xmlDoc);
                updateLineNumbers();
                debouncedUpdateUI();
                addHistory();
            }
        });

        // å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ã€ŒAdd Page to Sceneã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        // è¦ªè¦ç´ ã«ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²
        pageList.addEventListener('click', (e) => {
            if (e.target.classList.contains('add-page-to-scene-btn')) {
                const targetSceneIndex = e.target.dataset.sceneIndex;
                if (targetSceneIndex === undefined) return;

                const xmlString = mainEditor.value;
                const xmlDoc = parseXml(xmlString);

                if (xmlDoc) {
                    const targetScene = xmlDoc.querySelectorAll('ã‚·ãƒ¼ãƒ³')[targetSceneIndex];
                    if (!targetScene) return;

                    const pageCountInScene = targetScene.querySelectorAll('ãƒšãƒ¼ã‚¸').length;
                    const newPage = xmlDoc.createElement('ãƒšãƒ¼ã‚¸');
                    newPage.setAttribute('ãƒšãƒ¼ã‚¸ç•ªå·', `${pageCountInScene + 1}`);

                    const newPageDesc = xmlDoc.createElement('ãƒšãƒ¼ã‚¸èª¬æ˜');
                    newPageDesc.textContent = 'ã“ã“ã«æ–°ã—ã„ãƒšãƒ¼ã‚¸ã®èª¬æ˜ã‚’è¨˜è¿°ã—ã¾ã™';
                    newPage.appendChild(newPageDesc);

                    const newSerif = xmlDoc.createElement('ã‚»ãƒªãƒ•');
                    newSerif.setAttribute('ã‚­ãƒ£ãƒ©', 'ã‚­ãƒ£ãƒ©å');
                    newSerif.textContent = 'ã€Œã‚»ãƒªãƒ•ã€';
                    newPage.appendChild(newSerif);

                    targetScene.appendChild(newPage);

                    mainEditor.value = new XMLSerializer().serializeToString(xmlDoc);
                    updateLineNumbers();
                    debouncedUpdateUI();
                    addHistory();
                }
            }
        });

        exportDialogueBtn.addEventListener('click', () => {
            let exportText = '';
            const dialogues = document.querySelectorAll('.dialogue-content');
            dialogues.forEach(dialogueDiv => {
                const pageGroup = dialogueDiv.closest('.serif-page-group-container');
                const pageTitle = pageGroup ? pageGroup.querySelector('.page-title-in-serif').textContent + '\n' : '';
                
                // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ãŒå‰ã®ã‚»ãƒªãƒ•ã‚°ãƒ«ãƒ¼ãƒ—ã¨åŒã˜å ´åˆã¯å‡ºåŠ›ã—ãªã„ã‚ˆã†ã«èª¿æ•´
                if (!exportText.endsWith(pageTitle) && pageTitle.trim() !== '') {
                    exportText += `--- ${pageTitle.trim()} ---\n`;
                }
                
                exportText += dialogueDiv.textContent + '\n';
            });

            if (exportText) {
                const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'dialogues.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            } else {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã‚»ãƒªãƒ•ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            }
        });

        // ==========================================================
        // Local Storage
        // ==========================================================
        function saveState() {
            const state = {
                mainEditorContent: mainEditor.value,
                outlineEditorContent: outlineEditor.value,
                characterEditorContent: characterEditor.value,
                fileHandleName: fileHandle ? fileHandle.name : null, // FileHandleã¯ä¿å­˜ã§ããªã„ã®ã§åå‰ã ã‘
                history: undoRedoHistory,
                historyPointer: historyPointer,
                currentColumnIndex: currentColumnIndex,
                sectionVisibility: {
                    outline: !document.getElementById('outline-section').querySelector('.section-content').classList.contains('hidden'),
                    character: !document.getElementById('character-section').querySelector('.section-content').classList.contains('hidden'),
                    xml: !document.getElementById('main-xml-section').querySelector('.section-content').classList.contains('hidden'),
                }
            };
            localStorage.setItem('mangaNameEditorState', JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem('mangaNameEditorState');
            let editorContentLoaded = false; // ã‚¨ãƒ‡ã‚£ã‚¿å†…å®¹ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    mainEditor.value = state.mainEditorContent || ''; // null/undefinedã®å ´åˆã¯ç©ºæ–‡å­—åˆ—ã«
                    outlineEditor.value = state.outlineEditorContent || '';
                    characterEditor.value = state.characterEditorContent || '';
                    
                    // mainEditorã®å†…å®¹ãŒç©ºã§ãªã‘ã‚Œã°ã€ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã¨ã™ã‚‹
                    if (mainEditor.value.trim() !== '') {
                        editorContentLoaded = true;
                    }

                    undoRedoHistory = state.history || [];
                    historyPointer = state.historyPointer !== undefined ? state.historyPointer : -1;
                    currentColumnIndex = state.currentColumnIndex !== undefined ? state.currentColumnIndex : 0;

                    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’å¾©å…ƒ
                    document.getElementById('outline-section').querySelector('.section-content').classList.toggle('hidden', !state.sectionVisibility.outline);
                    document.getElementById('outline-section').querySelector('.toggle-btn').textContent = state.sectionVisibility.outline ? 'â–²' : 'â–¼';
                    document.getElementById('character-section').querySelector('.section-content').classList.toggle('hidden', !state.sectionVisibility.character);
                    document.getElementById('character-section').querySelector('.toggle-btn').textContent = state.sectionVisibility.character ? 'â–²' : 'â–¼';
                    document.getElementById('main-xml-section').querySelector('.section-content').classList.toggle('hidden', !state.sectionVisibility.xml);
                    document.getElementById('main-xml-section').querySelector('.toggle-btn').textContent = state.sectionVisibility.xml ? 'â–²' : 'â–¼';

                } catch (e) {
                    console.error("Failed to parse saved state from localStorage:", e);
                    // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€æ–°è¦ã¨ã—ã¦æ‰±ã†
                    localStorage.removeItem('mangaNameEditorState');
                }
            }

            // mainEditorã®å†…å®¹ãŒç©ºã®å ´åˆã€ã¾ãŸã¯åˆå›ãƒ­ãƒ¼ãƒ‰ã®å ´åˆã«åˆæœŸXMLã‚’è¨­å®š
            if (!editorContentLoaded || mainEditor.value.trim() === '') {
                mainEditor.value = `
<root>
    <ã‚·ãƒ¼ãƒ³ ã‚·ãƒ¼ãƒ³å='æ–°ã—ã„ã‚·ãƒ¼ãƒ³'>
        <ã‚·ãƒ¼ãƒ³èª¬æ˜>ã“ã“ã«ã‚·ãƒ¼ãƒ³ã®èª¬æ˜ã‚’è¨˜è¿°ã—ã¾ã™</ã‚·ãƒ¼ãƒ³èª¬æ˜>
        <ãƒšãƒ¼ã‚¸ ãƒšãƒ¼ã‚¸ç•ªå·='1'>
            <ãƒšãƒ¼ã‚¸èª¬æ˜>ã“ã“ã«æ–°ã—ã„ãƒšãƒ¼ã‚¸ã®èª¬æ˜ã‚’è¨˜è¿°ã—ã¾ã™</ãƒšãƒ¼ã‚¸èª¬æ˜>
            <ã‚»ãƒªãƒ• ã‚­ãƒ£ãƒ©='ã‚­ãƒ£ãƒ©å'>ã€Œã‚»ãƒªãƒ•ã€</ã‚»ãƒªãƒ•>
        </ãƒšãƒ¼ã‚¸>
    </ã‚·ãƒ¼ãƒ³>
</root>`.trim();
                undoRedoHistory = []; // åˆæœŸXMLã®å ´åˆã¯å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
                historyPointer = -1;
            }

            // çŠ¶æ…‹ãŒãƒ­ãƒ¼ãƒ‰ã¾ãŸã¯åˆæœŸåŒ–ã•ã‚ŒãŸå¾Œã€UIã‚’æ›´æ–°
            updateUndoRedoButtons();
            updateLineNumbers();
            debouncedUpdateUI(); // UIã‚’å®Œå…¨ã«åŒæœŸ
            showColumn(currentColumnIndex); // ä¿å­˜ã•ã‚ŒãŸã‚«ãƒ©ãƒ ã‚’è¡¨ç¤º
            
            // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã€ã¾ãŸã¯çŠ¶æ…‹ãŒãªã„å ´åˆã®ã¿å±¥æ­´ã«è¿½åŠ 
            if (historyPointer === -1) {
                addHistory(); // åˆæœŸçŠ¶æ…‹ã‚’å±¥æ­´ã«è¿½åŠ 
            }
        }

        // ==========================================================
        // ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã¨ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        // ==========================================================
        const footerNav = document.getElementById('footer-nav');
        const navButtons = {
            main: document.getElementById('nav-main'),
            scene: document.getElementById('nav-scene'),
            page: document.getElementById('nav-page'),
            serif: document.getElementById('nav-serif')
        };
        const columnMap = {
            'main': 0,
            'scene': 1,
            'page': 2,
            'serif': 3
        };
        const columnNames = ['main', 'scene', 'page', 'serif'];

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        Object.keys(navButtons).forEach(key => {
            navButtons[key].addEventListener('click', () => {
                showColumn(columnMap[key]);
            });
        });

        function updateFooterNavActiveButton(activeIndex) {
            Object.keys(navButtons).forEach(key => {
                navButtons[key].classList.remove('active');
            });
            if (columnNames[activeIndex]) {
                navButtons[columnNames[activeIndex]].classList.add('active');
            }
        }

        // æ—¢å­˜ã®ã‚¹ãƒ¯ã‚¤ãƒ—å‡¦ç†
        columnsWrapper.addEventListener('touchstart', (e) => {
            if (window.innerWidth <= 768) {
                touchStartX = e.touches[0].clientX;
                columnsWrapper.style.transition = 'none'; // ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã¯ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã‚’ä¸€æ™‚åœæ­¢
            }
        }, { passive: false });

        columnsWrapper.addEventListener('touchmove', (e) => {
            if (window.innerWidth <= 768) {
                touchEndX = e.touches[0].clientX;
                const diff = touchEndX - touchStartX;
                const newTransform = -currentColumnIndex * window.innerWidth + diff;
                columnsWrapper.style.transform = `translateX(${newTransform}px)`; // pxæŒ‡å®šã«å¤‰æ›´
            }
        }, { passive: false });

        columnsWrapper.addEventListener('touchend', (e) => { 
            if (window.innerWidth <= 768) {
                const diff = touchEndX - touchStartX;
                const swipeThreshold = window.innerWidth * 0.15; // ä¾‹: 15%ã«èª¿æ•´

                let newColumnIndex = currentColumnIndex;
                if (diff < -swipeThreshold) { // å·¦æ–¹å‘ã¸ã®ã‚¹ãƒ¯ã‚¤ãƒ—
                    newColumnIndex = Math.min(columns.length - 1, currentColumnIndex + 1);
                } else if (diff > swipeThreshold) { // å³æ–¹å‘ã¸ã®ã‚¹ãƒ¯ã‚¤ãƒ—
                    newColumnIndex = Math.max(0, currentColumnIndex - 1);
                } else {
                    // é–¾å€¤ä»¥ä¸‹ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã®å ´åˆã€ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚«ãƒ©ãƒ ã«ç•™ã¾ã‚‹
                    newColumnIndex = currentColumnIndex;
                }
                
                columnsWrapper.style.transition = 'transform 0.3s ease-out'; // ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã‚’å†é©ç”¨
                showColumn(newColumnIndex); // ä¿®æ­£å¾Œã®newColumnIndexã‚’æ¸¡ã™
            }
        }, { passive: false }); 

        // ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆã§ã‚«ãƒ©ãƒ è¡¨ç¤ºã‚’èª¿æ•´
        window.addEventListener('resize', () => {
            showColumn(currentColumnIndex); 
            autoResizeAllTextareas(); 
            // ãƒ¢ãƒã‚¤ãƒ«ã‹ã‚‰PCã€PCã‹ã‚‰ãƒ¢ãƒã‚¤ãƒ«ã¸ã®åˆ‡ã‚Šæ›¿ãˆã§ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡
            if (window.innerWidth > 768) {
                footerNav.style.display = 'none';
                document.body.style.paddingBottom = '0';
            } else {
                footerNav.style.display = 'flex';
                document.body.style.paddingBottom = '60px'; // ãƒ•ãƒƒã‚¿ãƒ¼ã®é«˜ã•ã«åˆã‚ã›ã¦èª¿æ•´
            }
        });

        // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚‚ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¦ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã®è¡¨ç¤ºã‚’åˆ¶å¾¡
        window.dispatchEvent(new Event('resize'));

    </script>
</body>
</html>

function loadState() {
            const savedState = localStorage.getItem('mangaNameEditorState');
            let editorContentLoaded = false; // エディタ内容がロードされたかどうかのフラグ

            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    mainEditor.value = state.mainEditorContent || ''; // null/undefinedの場合は空文字列に
                    outlineEditor.value = state.outlineEditorContent || '';
                    characterEditor.value = state.characterEditorContent || '';
                    
                    // mainEditorの内容が空でなければ、ロード済みとする
                    if (mainEditor.value.trim() !== '') {
                        editorContentLoaded = true;
                    }

                    undoRedoHistory = state.history || [];
                    historyPointer = state.historyPointer !== undefined ? state.historyPointer : -1;
                    currentColumnIndex = state.currentColumnIndex !== undefined ? state.currentColumnIndex : 0;

                    // セクションの表示状態を復元
                    document.getElementById('outline-section').querySelector('.section-content').classList.toggle('hidden', !state.sectionVisibility.outline);
                    document.getElementById('outline-section').querySelector('.toggle-btn').textContent = state.sectionVisibility.outline ? '▲' : '▼';
                    document.getElementById('character-section').querySelector('.section-content').classList.toggle('hidden', !state.sectionVisibility.character);
                    document.getElementById('character-section').querySelector('.toggle-btn').textContent = state.sectionVisibility.character ? '▲' : '▼';
                    document.getElementById('main-xml-section').querySelector('.section-content').classList.toggle('hidden', !state.sectionVisibility.xml);
                    document.getElementById('main-xml-section').querySelector('.toggle-btn').textContent = state.sectionVisibility.xml ? '▲' : '▼';

                } catch (e) {
                    console.error("Failed to parse saved state from localStorage:", e);
                    // エラー発生時は状態をリセットし、新規として扱う
                    localStorage.removeItem('mangaNameEditorState');
                }
            }

            // mainEditorの内容が空の場合、または初回ロードの場合に初期XMLを設定
            if (!editorContentLoaded || mainEditor.value.trim() === '') {
                mainEditor.value = `
<root>
    <シーン シーン名='新しいシーン'>
        <シーン説明>ここにシーンの説明を記述します</シーン説明>
        <ページ ページ番号='1'>
            <ページ説明>ここに新しいページの説明を記述します</ページ説明>
            <セリフ キャラ='キャラ名'>「セリフ」</セリフ>
        </ページ>
    </シーン>
</root>`.trim();
                undoRedoHistory = []; // 初期XMLの場合は履歴をリセット
                historyPointer = -1;
            }

            // 状態がロードまたは初期化された後、UIを更新
            updateUndoRedoButtons();
            updateLineNumbers();
            debouncedUpdateUI(); // UIを完全に同期
            showColumn(currentColumnIndex); // 保存されたカラムを表示
            
            // 初回ロード時、または状態がない場合のみ履歴に追加
            if (historyPointer === -1) {
                addHistory(); // 初期状態を履歴に追加
            }
        }

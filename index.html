<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- <head>ã‚¿ã‚°å†…ã«è¿½åŠ  -->
    <!-- <head>ã‚¿ã‚°å†…ã«è¿½åŠ  -->
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon192.png">
    <!-- iOSç”¨ã®è¤‡æ•°ã‚µã‚¤ã‚ºå¯¾å¿œ -->
    <link rel="apple-touch-icon" sizes="180x180" href="./icon180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./icon152.png">
    <link rel="apple-touch-icon" sizes="120x120" href="./icon120.png">
        <!-- ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ -->
    <link rel="icon" type="image/png" sizes="32x32" href="./icon32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icon16.png">
    <meta charset="UTF-8">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¼«ç”»ãƒãƒ¼ãƒ ã‚¨ãƒ‡ã‚£ã‚¿hikaku2</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®é«˜ã•ã«åˆã‚ã›ã‚‹ */
            display: flex;
            flex-direction: column;
            background-color: #e0e0e0;
            overflow: hidden; /* å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ç¦æ­¢ (ã‚«ãƒ©ãƒ ã‚¹ãƒ©ã‚¤ãƒ‰ã®ãŸã‚) */

            touch-action: pan-y;
        }

        /* PCç‰ˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆ4ã‚«ãƒ©ãƒ è¡¨ç¤ºï¼‰ */
        .columns-wrapper { /* ã‚«ãƒ©ãƒ å…¨ä½“ã‚’åŒ…ã‚€ãƒ©ãƒƒãƒ‘ãƒ¼ */
            flex-grow: 1;
            display: flex;
            width: 100%; /* PCã§ã¯100%å¹… */
            padding-top: 0; /* ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å‰Šé™¤ã—ãŸã®ã§0 */
            padding-bottom: 0; /* ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚’å‰Šé™¤ã—ãŸã®ã§0 */
            box-sizing: border-box;
            overflow-x: auto; /* PCã§ã¯æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ */
            transition: none; /* PCã§ã¯ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã— */
        }

        .column {
            width: 25vw; /* å„ã‚«ãƒ©ãƒ ã®å¹…ã‚’ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®25%ã« */
            flex-shrink: 0; /* ã‚«ãƒ©ãƒ ãŒç¸®ã¾ãªã„ã‚ˆã†ã« */
            background-color: #fff;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #eee; /* å„ã‚«ãƒ©ãƒ ã®å³å´ã«å¢ƒç•Œç·š */
            box-sizing: border-box;
            overflow: hidden; /* ã‚«ãƒ©ãƒ è‡ªä½“ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’æŒãŸãªã„ */
        }
        .column:last-child {
            border-right: none; /* æœ€å¾Œã®ã‚«ãƒ©ãƒ ã«ã¯å¢ƒç•Œç·šä¸è¦ */
        }


        /* å„ã‚«ãƒ©ãƒ ãƒ˜ãƒƒãƒ€å†…ã®ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å®šç¾© */
        .column-header {
            background-color: #34495e;
            color: white;
            padding: 10px;
            font-weight: bold;
            text-align: center;
            flex-shrink: 0;
            position: sticky; /* ã‚«ãƒ©ãƒ å†…ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚å›ºå®š */
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .column-header .header-title {
            flex-shrink: 0;
            margin-right: auto;
        }

        .column-header .controls {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: flex-end;
            align-items: center;
        }

        .column-header .controls button {
            background-color: #6c757d;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
            margin-left: 5px;
        }

        .column-header .controls button#undoBtn,
        .column-header .controls button#redoBtn {
            background-color: #5a6268;
        }

        .column-header .controls button:hover {
            background-color: #5a6268;
        }
        
        .column-header .controls button#undoBtn:hover,
        .column-header .controls button#redoBtn:hover {
            background-color: #4a5157;
        }


        .column-header .controls button:disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        .column-content {
            flex-grow: 1;
            overflow-y: auto; /* ã“ã®é ˜åŸŸã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ */
            padding: 10px;
            /*display: flex;*/
            flex-direction: column;
            gap: 10px;
        }

        textarea {
            width: 100%;
            height: auto; /* è‡ªå‹•ãƒªã‚µã‚¤ã‚ºã®ãŸã‚ã«autoã« */
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Meiryo', 'Hiragino Kaku Gothic ProN', 'BIZ UDPGothic', sans-serif;
            font-size: 1em;
            line-height: 1.6;
            resize: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãªã— */
            box-sizing: border-box;
            min-height: 50px;
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã¯è¡¨ç¤ºã—ãªã„ */
        }

        .main-textarea {
            flex-grow: 1;
            min-height: 150px;
            resize: vertical; /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ã‚‚ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒªã‚µã‚¤ã‚ºå¯èƒ½ã« */
        }

        .outline-textarea {
            min-height: 50px;
            max-height: none; /* max-heightã‚’å‰Šé™¤ (è‡ªå‹•ã§ä¼¸ã³ã‚‹) */
            resize: vertical; 
        }

        .character-textarea { 
            min-height: 70vh; 
            max-height: none; /* max-heightã‚’å‰Šé™¤ (è‡ªå‹•ã§ä¼¸ã³ã‚‹) */
            resize: vertical; 
            overflow-y: auto; /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯å†…å®¹ãŒå¤šã„ã®ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨±å¯ */
        }
        
        /* ã‚·ãƒ¼ãƒ³/ãƒšãƒ¼ã‚¸/ã‚»ãƒªãƒ•ã®å‹•çš„è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .item-wrapper {
            display: flex;
            align-items: flex-start;
            padding: 2px 0;
            border-bottom: 1px dashed #eee;
            margin-bottom: 2px;
            font-family: 'Meiryo', 'Hiragino Kaku Gothic ProN', 'BIZ UDPGothic', sans-serif;
            font-size: 0.95em;
            line-height: 1.6;
            box-sizing: border-box;
            flex-shrink: 0;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .item-wrapper textarea {
            flex-grow: 1;
            margin: 0;
            padding: 0;
            border: none;
            background: transparent;
            font-size: 1em;
            line-height: inherit;
            resize: none;
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã¯è¡¨ç¤ºã—ãªã„ */
            height: auto;
            box-sizing: border-box;
        }

        /* ã‚·ãƒ¼ãƒ³ã®textarea */
        .scene-item-container textarea {
            width: 100%;
            border: 1px solid #ddd;
            border-top: none;
            padding: 5px;
            box-sizing: border-box;
            background-color: white;
            border-radius: 0;
            padding: 5px;
            overflow: hidden; 
            min-height: 40px; /* ã‚·ãƒ¼ãƒ³èª¬æ˜ã®æœ€å°ã®é«˜ã• */
            max-height: none; 
            resize: none; 
            height: auto; 
        }
        
        /* ãƒšãƒ¼ã‚¸ã¨ã‚»ãƒªãƒ•ã®textarea */
        .page-item-container textarea{ /*,}.dialogue-content textarea { */
            width: 100%;
            border: 1px solid #ddd;
            padding: 5px;
            box-sizing: border-box;
            background-color: white;
            border-radius: 0;
            overflow: hidden; 
            min-height: 40px; /* ãƒšãƒ¼ã‚¸èª¬æ˜ãƒ»ã‚»ãƒªãƒ•ã®æœ€å°ã®é«˜ã• */
            max-height: none; 
            resize: none; 
            height: auto; 
        }


        .item-wrapper .content-display {
            flex-grow: 1;
            margin: 0;
            padding: 0;
            border: none;
            background: transparent;
            font-size: 1em;
            line-height: inherit;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 1.6em;
        }

        .line-numbers {
            width: 35px;
            text-align: right;
            padding-right: 5px;
            color: #aaa;
            font-size: 0.8em;
            flex-shrink: 0;
            user-select: none;
        }

        /* ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« (ã“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã¯ç›´æ¥è¦‹ãˆãªã„ã‹ã‚‚ã—ã‚Œãªã„) */
        body.drag-over .column.main-column {
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
            border: 2px dashed #007bff;
        }

        /* ã‚·ãƒ¼ãƒ³ã‚«ãƒ©ãƒ å†…ã®è¿½åŠ ãƒœã‚¿ãƒ³ */
        .add-button-container {
            text-align: center;
            margin: 0;
            padding-top: 5px;
            border-top: 1px dashed #eee;
            margin-bottom: 10px;
        }
        .add-button-container button {
            background-color: #17A2B8;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            width: 100%;
            box-sizing: border-box;
            margin: 0 auto;
            display: block;
        }
        .add-button-container button:hover {
            background-color: #138496;
        }

        /* ã‚·ãƒ¼ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã®å…·ä½“çš„ãªã‚¹ã‚¿ã‚¤ãƒ« */
        .scene-item-container {
            border: 1px solid #ccc;
            padding: 0px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªè¦ç´ ã®å¼·èª¿è¡¨ç¤º */
        .scene-item-container.active,
        .page-item-container.active,
        .dialogue-content.active,
        .character-item-container.active { 
            box-shadow: 0 0 8px 3px rgba(0, 123, 255, 0.5);
            border-color: #007bff;
            transform: scale(1.01);
        }

        .page-item-container {
            border: 1px solid #ccc;
            padding: 0px;
            margin: 0;
            margin-bottom: 5px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        /* ã‚·ãƒ¼ãƒ³ã®èƒŒæ™¯è‰²ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ */
        .scene-color-0 { background-color: #e0f7fa; }
        .scene-color-1 { background-color: #f0f4c3; }
        .scene-color-2 { background-color: #ffe0b2; } 
        .scene-color-3 { background-color: #e1bee7; }
        .scene-color-4 { background-color: #b3e5fc; }

        /* ã‚»ãƒªãƒ•è¡¨ç¤ºéƒ¨åˆ†ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .serif-page-group-container {
            border: 1px solid #dcdcdc;
            border-radius: 5px;
            margin-bottom: 15px;
            padding: 10px;
            padding-top: 0;
            background-color: #fffbf0; /* è–„ã„ã‚ªãƒ¬ãƒ³ã‚¸è‰² #fffbf0 ã«å¤‰æ›´ */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            box-sizing: border-box;
            cursor: pointer;
        }


        .dialogue-content {
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            box-sizing: border-box;
            cursor: pointer;
            transition: none;
            flex-grow: 1;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.95em;
            line-height: 1.6;
            font-style:italic; /* è¦ªã®italicã‚’æ‰“ã¡æ¶ˆã™ */
            color: #333;
            background-color: white; /* å„ã‚»ãƒªãƒ•divã®èƒŒæ™¯ã¯ç™½ã« */
            border-radius: 3px;
            width: 100%;
            border: 1px solid #ddd;
            border-left: 3px solid #f9ab00; /* ã‚»ãƒªãƒ•ã®divã«å·¦ãƒœãƒ¼ãƒ€ãƒ¼ã‚’é©ç”¨ */
            padding: 5px; /* ãƒœãƒ¼ãƒ€ãƒ¼åˆ†ã®èª¿æ•´ã¨å†…å®¹ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
        }
        /* ã‚»ãƒªãƒ•ã®divå†…ã®ãƒ†ã‚­ã‚¹ãƒˆã¯ç›´æ¥è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€textareaã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ä¸è¦ */


        .scene-item-header, .page-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px; /* ã‚·ãƒ¼ãƒ³ã¨ãƒšãƒ¼ã‚¸ã§å…±é€šã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
            flex-shrink: 0;
        }

        .scene-title-badge {
            background-color: #007bff;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 1.0em;
            display: inline-block;
        }

        .page-title-badge {
            background-color: #007bff;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 1.0em;
            display: inline-block;
        }

        .scene-item-header .delete-scene-btn, .page-item-header .delete-page-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s;
        }

        .scene-item-header .delete-scene-btn:hover, .page-item-header .delete-page-btn:hover {
            background-color: #c82333;
        }

        .section-container {
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            background-color: #f8f8f8;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .section-header {
            background-color: #f0f0f0;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            flex-shrink: 0;
            cursor: pointer;
        }

        .section-header h3 {
            margin: 0;
            font-size: 1em;
            color: #333;
            flex-grow: 1;
        }

        .toggle-btn, .add-character-btn {
            background-color: #6c757d;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s;
            margin-left: 5px;
        }

        .toggle-btn:hover, .add-character-btn:hover {
            background-color: #5a6268;
        }

        .section-content {
            padding: 10px;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease-out;
            overflow-y: auto; 
            max-height: none; 
            opacity: 1;
            box-sizing: border-box;
        }

        .section-content.hidden {
            max-height: 0 !important;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
            visibility: hidden;
        }

        /* .character-textarea, .outline-textarea, .main-textarea ã¯å€‹åˆ¥ã® max-height ã‚’æŒã¤ */
        .character-textarea, .outline-textarea, .main-textarea {
            border: none;
            min-height: 50px;
            background-color: white;
            border-radius: 0;
            padding: 5px;
        }

        .main-textarea {
            min-height: 150px;
        }

        /* å€‹åˆ¥ã®ã‚·ãƒ¼ãƒ³å†…ã§ãƒšãƒ¼ã‚¸ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã®ãƒœã‚¿ãƒ³ */
        .add-page-to-scene-btn {
            background-color: #34495e;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            width: calc(100% - 20px); /* Paddingåˆ†ã‚’è€ƒæ…® */
            box-sizing: border-box;
            margin: 10px; /* ã‚·ãƒ¼ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã®ä¸‹ã«å°‘ã—ãƒãƒ¼ã‚¸ãƒ³ */
            display: block;
            text-align: center;
        }
        .add-page-to-scene-btn:hover {
            background-color: #2c3e50; /* ãƒ›ãƒãƒ¼æ™‚ã®è‰² */
        }
/*ã‚¿ãƒ–ãƒãƒ¼*/
        .tab-bar {
            display: none; /* PCã§ã¯éè¡¨ç¤º */
            background:white;
            border-top:1px solid #ddd;
            flex-shrink: 0;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05 );
            z-index:1000; /* æœ€å‰é¢ã«è¡¨ç¤º */
            position: fixed; /* ç”»é¢ä¸‹éƒ¨ã«å›ºå®š */
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px; /* ã‚¿ãƒ–ãƒãƒ¼ã®é«˜ã• */
            box-sizing: border-box;
        }
        .tab-item {
            flex: 1;
            padding: 8px 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            color: #666;
        }
        
        .tab-item:active {
            background: #f0f0f0;
        }
        
        .tab-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 10%;
            right: 10%;
            height: 3px;
            background: #1a73e8;
            border-radius: 0 0 3px 3px;
        }
        
        .tab-icon {
            font-size: 22px;
        }
        
        .tab-label {
            font-size: 10px;
        }
        
        .tab-item.active {
            color: #1a73e8;
        }


        /* --- ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å¯¾å¿œã®ãŸã‚ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª --- */
        @media (max-width: 768px) {
            body {
                overflow-y: hidden; /* å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ (æ¨ªã‚¹ãƒ©ã‚¤ãƒ‰ã®ãŸã‚) */
                padding-bottom:60px;/*ã‚¿ãƒ–ãƒãƒ¼ã®é«˜ã•åˆ†ã€bodyã«ä½™ç™½ã‚’è¨­ã‘ã‚‹*/
            }
            .tab-bar {
                display: flex; /* ã‚¹ãƒãƒ›ã®æ™‚ã ã‘è¡¨ç¤º */
            }
            .columns-wrapper {
                width: 400vw; /* 4ã‚«ãƒ©ãƒ åˆ†ã®å¹… */
                transform: translateX(0vw); /* åˆæœŸè¡¨ç¤ºã¯JSã§è¨­å®š */
                transition: transform 0.3s ease-in-out; /* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
                padding-top: 0; /* ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å‰Šé™¤ã—ãŸã®ã§0 */
                padding-bottom: 0; /* ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚’å‰Šé™¤ã—ãŸã®ã§0 */
                box-sizing: border-box;
                overflow-x: hidden; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ (JSã§åˆ¶å¾¡ã™ã‚‹ãŸã‚) */
            }

            .column {
                width: 100vw; /* å„ã‚«ãƒ©ãƒ ã®å¹…ã‚’ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®å¹…ã« */
                border-right: none; /* ã‚¹ãƒãƒ›ã§ã¯ã‚«ãƒ©ãƒ é–“ã®å¢ƒç•Œç·šã¯ä¸è¦ */
            }

            .column-header {
                flex-direction: column;
                align-items: flex-start;
                padding: 8px;
            }

            .column-header .header-title {
                margin-right: 0;
                margin-bottom: 5px;
            }

            .column-header .controls {
                width: 100%;
                justify-content: space-around;
                gap: 5px;
            }

            .column-header .controls button {
                flex-grow: 1;
                margin-left: 0;
                padding: 8px 5px;
                font-size: 1em;
            }

            .column-content {
                padding: 8px;
            }

            /* ã‚¹ãƒãƒ›æ™‚ã®section-contentã®max-heightã‚‚èª¿æ•´ */
            .section-content {
                max-height: none; /* ã‚¹ãƒãƒ›ã§ã‚‚å†…éƒ¨ã®textareaãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ã‚ˆã†ã« */
            }
        }

        @media (max-width: 480px) {
            .column-header .controls button {
                font-size: 0.9em;
                padding: 6px 3px;
            }

            .section-header h3 {
                font-size: 0.9em;
            }
            .toggle-btn, .add-character-btn {
                font-size: 0.7em;
                padding: 3px 6px;
            }
            
            textarea {
                font-size: 0.9em;
            }
            .line-numbers {
                width: 25px;
                font-size: 0.7em;
            }

            .section-content {
                max-height: none; /* ã‚¹ãƒãƒ›ã§ã‚‚å†…éƒ¨ã®textareaãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ã‚ˆã†ã« */
            }
        }
    </style>
</head>
<body>
    <div class="columns-wrapper" id="columnsWrapper">
        <div class="column main-column" data-column-id="main">
            <div class="column-header">
                <span class="header-title">ãƒ¡ã‚¤ãƒ³</span>
                <div class="controls">
                    <button id="newBtn">æ–°è¦</button>
                    <button id="openBtn">é–‹ã</button>
                    <input type="file" id="fileInput" style="display: none;">
                    <button id="saveBtn">ä¿å­˜</button>
                    <button id="saveAsBtn">åˆ¥åä¿å­˜</button>
                    <button id="undoBtn">â†¶</button>
                    <button id="redoBtn">â†·</button>
                </div>
            </div>
            <div class="column-content">
                <div class="section-container" id="outlineSection">
                    <div class="section-header">
                        <h3>ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³</h3>
                        <button class="toggle-btn" data-target="outlineContent">éš ã™</button>
                    </div>
                    <div class="section-content" id="outlineContent">
                        <textarea id="outlineEditor" class="outline-textarea" placeholder="ã“ã“ã«ç‰©èªã®ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚"></textarea>
                    </div>
                </div>
                
                <div class="section-container" id="characterSection">
                    <div class="section-header">
                        <h3>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</h3>
                        <div class="controls">
                            <button class="add-character-btn" id="addCharacterBtn">è¿½åŠ </button>
                            <button class="toggle-btn" data-target="characterContent">éš ã™</button>
                        </div>
                    </div>
                    <div class="section-content" id="characterContent">
                        <textarea id="characterEditor" class="character-textarea"></textarea>
                    </div>
                </div>

                <div class="section-container" id="mainEditorSection">
                    <div class="section-header">
                        <h3>ãƒãƒ¼ãƒ æœ¬ä½“ (XML)</h3>
                        <button class="toggle-btn" data-target="mainEditorContent">éš ã™</button>
                    </div>
                    <div class="section-content" id="mainEditorContent">
                        <textarea id="mainEditor" class="main-textarea" placeholder="XMLå½¢å¼ã§ãƒãƒ¼ãƒ ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚ä¾‹ï¼š
<root><ã‚·ãƒ¼ãƒ³><ã‚·ãƒ¼ãƒ³èª¬æ˜>æ–°ã—ã„ã‚·ãƒ¼ãƒ³</ã‚·ãƒ¼ãƒ³èª¬æ˜><ãƒšãƒ¼ã‚¸><ãƒšãƒ¼ã‚¸èª¬æ˜>æ–°ã—ã„ãƒšãƒ¼ã‚¸</ãƒšãƒ¼ã‚¸èª¬æ˜><ã‚»ãƒªãƒ•>ã‚»ãƒªãƒ•A</ã‚»ãƒªãƒ•></ãƒšãƒ¼ã‚¸></ã‚·ãƒ¼ãƒ³></root>">
</textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="column scene-column" data-column-id="scene">
            <div class="column-header">
                <span class="header-title">ã‚·ãƒ¼ãƒ³</span>
                <div class="controls">
                    <button id="addSceneBtn">ã‚·ãƒ¼ãƒ³è¿½åŠ </button>
                </div>
            </div>
            <div class="column-content" id="sceneContent">
                <p>ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã‹ã‚‰ã‚·ãƒ¼ãƒ³ã‚’æŠ½å‡ºã—ã¾ã™ã€‚</p>
            </div>
        </div>

        <div class="column page-column" data-column-id="page">
            <div class="column-header">
                <span class="header-title">ãƒšãƒ¼ã‚¸</span>
            </div>
            <div class="column-content" id="pageContent">
                <p>ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã‹ã‚‰ãƒšãƒ¼ã‚¸ã‚’æŠ½å‡ºã—ã¾ã™ã€‚</p>
            </div>
        </div>

        <div class="column serif-column" data-column-id="serif">
            <div class="column-header">
                <span class="header-title">ã‚»ãƒªãƒ•</span>
                <div class="controls">
                    <button id="exportDialogueBtn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                </div>
            </div>
            <div class="column-content" id="dialogueContent">
                <p>ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã‹ã‚‰ã‚»ãƒªãƒ•ã‚’æŠ½å‡ºã—ã¾ã™ã€‚</p>
            </div>
        </div>
    </div>

<!-- ã‚¿ãƒ–ãƒãƒ¼ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰ -->
    <div class="tab-bar">
        <div class="tab-item active" data-page="0" onclick="switchToPage(0)">
            <span class="tab-icon">ğŸ“</span>
            <span class="tab-label">ãƒ¡ã‚¤ãƒ³</span>
        </div>
        <div class="tab-item" data-page="1" onclick="switchToPage(1)">
            <span class="tab-icon">ğŸ¬</span>
            <span class="tab-label">ã‚·ãƒ¼ãƒ³</span>
        </div>
        <div class="tab-item" data-page="2" onclick="switchToPage(2)">
            <span class="tab-icon">ğŸ“„</span>
            <span class="tab-label">ãƒšãƒ¼ã‚¸</span>
        </div>
        <div class="tab-item" data-page="3" onclick="switchToPage(3)">
            <span class="tab-icon">ğŸ’¬</span>
            <span class="tab-label">ã‚»ãƒªãƒ•</span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const outlineEditor = document.getElementById('outlineEditor');
            const characterEditor = document.getElementById('characterEditor');
            const mainEditor = document.getElementById('mainEditor');

            const sceneContentDiv = document.getElementById('sceneContent');
            const pageContentDiv = document.getElementById('pageContent');
            const dialogueContentDiv = document.getElementById('dialogueContent');

            const newBtn = document.getElementById('newBtn');
            const openBtn = document.getElementById('openBtn');
            const saveBtn = document.getElementById('saveBtn');
            const saveAsBtn = document.getElementById('saveAsBtn');
            const fileInput = document.getElementById('fileInput');
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');

            const outlineContentDiv = document.getElementById('outlineContent');
            const characterContentDiv = document.getElementById('characterContent');
            const mainEditorContentDiv = document.getElementById('mainEditorContent');

            const toggleButtons = document.querySelectorAll('.toggle-btn');

            const addSceneBtn = document.getElementById('addSceneBtn'); 
            const addCharacterBtn = document.getElementById('addCharacterBtn');
            const exportDialogueBtn = document.getElementById('exportDialogueBtn');

            const columnsWrapper = document.getElementById('columnsWrapper');
            
            let currentFileName = 'æ–°è¦ãƒãƒ¼ãƒ .txt';
            let history = [''];
            let historyIndex = 0;
            const MAX_HISTORY = 100;
            let updateTimeout;
            const DEBOUNCE_DELAY = 300; 
            let currentXmlDoc = null;
            let currentFileHandle = null;

            const xmlParser = new DOMParser();
            // const xmlSerializer = new XMLSerializer(); // XMLSerializerã¯ä½¿ç”¨ã—ãªã„

            let nodeIdCounter = 0; 

            // XMLãƒãƒ¼ãƒ‰ã¨DOMè¦ç´ ã®é–¢é€£ä»˜ã‘ç”¨ãƒãƒƒãƒ—
            const sceneNodeIdToDomElementMap = new Map();
            const pageNodeIdToDomElementMap = new Map();
            const sceneNodeIdToFirstPageDomElementMap = new Map();
            const dialogueNodeIdToDomElementMap = new Map(); 

            let activeSceneElement = null;
            let activePageElement = null;
            let activeDialogueElement = null; // å€‹åˆ¥ã®ã‚»ãƒªãƒ•è¦ç´ 

            // --- ã‚«ãƒ©ãƒ è¡¨ç¤ºåˆ¶å¾¡ç”¨ã®å¤‰æ•° ---            
            let currentColumnIndex = 0; // 0:ãƒ¡ã‚¤ãƒ³, 1:ã‚·ãƒ¼ãƒ³, 2:ãƒšãƒ¼ã‚¸, 3:ã‚»ãƒªãƒ•
            const columns = document.querySelectorAll('.column');
            let startX = 0;
            let currentTranslateX = 0;
            let isDragging = false;

            function showColumn(index) {
                if (index < 0 || index >= columns.length) return;
                currentColumnIndex = index;
                saveState(); // ã‚«ãƒ©ãƒ ç§»å‹•æ™‚ã«ã‚‚çŠ¶æ…‹ã‚’ä¿å­˜

                if (window.innerWidth <= 768) {
                    columnsWrapper.style.transform = `translateX(-${index * 100}vw)`;
                    
                    // --- ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–° ---
                    const tabs = document.querySelectorAll('.tab-item');
                    tabs.forEach(tab => tab.classList.remove('active'));
                    const activeTab = document.querySelector(`.tab-item[data-page='${index}']`);
                    if (activeTab) {
                        activeTab.classList.add('active');
                    }
                    // --- ã“ã“ã¾ã§è¿½åŠ  ---

                } else {
                    // PCè¡¨ç¤ºæ™‚ã®æŒ™å‹• (å¤‰æ›´ãªã—)
                    columnsWrapper.style.transform = `translateX(0)`; 
                    columnsWrapper.style.scrollBehavior = 'smooth'; 
                    columnsWrapper.scrollLeft = columns[index].offsetLeft;
                }
            }

            function switchToPage(index) {
                if (window.innerWidth > 768) {
                    // PCè¡¨ç¤ºã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ã‹ã€ã‚‚ã—ãã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç§»å‹•
                    columnsWrapper.style.scrollBehavior = 'smooth'; 
                    columns[index].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
                    return;
                }
                // ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºã®å ´åˆã¯ã‚«ãƒ©ãƒ ã‚’ã‚¹ãƒ©ã‚¤ãƒ‰
                showColumn(index);
            }

            function undo() {
                if (historyIndex > 0) {
                    historyIndex--;
                    mainEditor.value = history[historyIndex];
                    updateUIImmediate(); // UIã‚’å³åº§ã«æ›´æ–°
                }
            }

            function redo() {
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    mainEditor.value = history[historyIndex];
                    updateUIImmediate(); // UIã‚’å³åº§ã«æ›´æ–°
                }
            }

            function saveState() {
                const state = {
                    outlineContent: outlineEditor.value,
                    characterContent: characterEditor.value,
                    mainContent: mainEditor.value,
                    fileName: currentFileName,
                    history: history,
                    historyIndex: historyIndex,
                    outlineHidden: outlineContentDiv.classList.contains('hidden'),
                    characterHidden: characterContentDiv.classList.contains('hidden'),
                    mainEditorHidden: mainEditorContentDiv.classList.contains('hidden'),
                    currentColumnIndex: currentColumnIndex 
                };
                localStorage.setItem('comicNameEditorState', JSON.stringify(state));
                console.log('State saved.');
            }

            function clearAllEditors() {
                outlineEditor.value = '';
                characterEditor.value = `*ä¸»äººå…¬ï¼ˆåå‰ï¼šèª­ã¿æ–¹ã€æ„›ç§°ï¼‰ç”·å¥³ã€æ­³
*é–¢ä¿‚æ€§
*è¦‹ãŸç›®ã€èº«ä½“çš„ç‰¹å¾´ã€æœè£…
*æ€§æ ¼ãƒ»è£æ€§æ ¼
*ç’°å¢ƒãƒ»ç”Ÿã„ç«‹ã¡
â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•
*ãƒ’ãƒ­ã‚¤ãƒ³ï¼ˆåå‰ï¼šèª­ã¿æ–¹ã€æ„›ç§°ï¼‰ç”·å¥³ã€æ­³
*é–¢ä¿‚æ€§
*è¦‹ãŸç›®ã€èº«ä½“çš„ç‰¹å¾´ã€æœè£…
*æ€§æ ¼ãƒ»è£æ€§æ ¼
*ç’°å¢ƒãƒ»ç”Ÿã„ç«‹ã¡
â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•
*ãƒ©ã‚¤ãƒãƒ«ï¼ˆåå‰ï¼šèª­ã¿æ–¹ã€æ„›ç§°ï¼‰ç”·å¥³ã€æ­³
*é–¢ä¿‚æ€§
*è¦‹ãŸç›®ã€èº«ä½“çš„ç‰¹å¾´ã€æœè£…
*æ€§æ ¼ãƒ»è£æ€§æ ¼
*ç’°å¢ƒãƒ»ç”Ÿã„ç«‹ã¡`;

                // æ–°è¦ä½œæˆæ™‚ã®XMLåˆæœŸå€¤ã«ã€ç©ºã®ã‚»ãƒªãƒ•è¦ç´ ã‚‚å«ã‚€ã‚ˆã†ã«å¤‰æ›´
                mainEditor.value = `<root><ã‚·ãƒ¼ãƒ³><ã‚·ãƒ¼ãƒ³èª¬æ˜>æ–°ã—ã„ã‚·ãƒ¼ãƒ³</ã‚·ãƒ¼ãƒ³èª¬æ˜><ãƒšãƒ¼ã‚¸><ãƒšãƒ¼ã‚¸èª¬æ˜>æ–°ã—ã„ãƒšãƒ¼ã‚¸</ãƒšãƒ¼ã‚¸èª¬æ˜></ãƒšãƒ¼ã‚¸></ã‚·ãƒ¼ãƒ³></root>`; 
                currentFileName = 'æ–°è¦ãƒãƒ¼ãƒ .txt';
                currentFileHandle = null;
                history = [mainEditor.value];
                historyIndex = 0;
                localStorage.removeItem('comicNameEditorState');
                
                setSectionVisibility(outlineContentDiv, false);
                setSectionVisibility(characterContentDiv, false);
                setSectionVisibility(mainEditorContentDiv, true);

                currentColumnIndex = 0; 
                showColumn(currentColumnIndex); 
                updateUIImmediate();
                alert('æ–°ã—ã„ãƒãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚');
            }


            function loadState() {
                const savedState = localStorage.getItem('comicNameEditorState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    outlineEditor.value = state.outlineContent || '';
                    characterEditor.value = state.characterContent || '';
                    mainEditor.value = state.mainContent || '';
                    currentFileName = state.fileName || 'æ–°è¦ãƒãƒ¼ãƒ .txt';
                    history = state.history || [''];
                    historyIndex = state.historyIndex || 0;

                    setSectionVisibility(outlineContentDiv, state.outlineHidden || false);
                    setSectionVisibility(characterContentDiv, state.characterHidden || false);
                    setSectionVisibility(mainEditorContentDiv, state.mainEditorHidden || false);
                    
                    currentColumnIndex = state.currentColumnIndex !== undefined ? state.currentColumnIndex : 0; 
                    console.log('State loaded.');
                } else {
                    outlineEditor.value = '';
                    characterEditor.value = `*ä¸»äººå…¬ï¼ˆåå‰ï¼šèª­ã¿æ–¹ã€æ„›ç§°ï¼‰ç”·å¥³ã€æ­³
*é–¢ä¿‚æ€§
*è¦‹ãŸç›®ã€èº«ä½“çš„ç‰¹å¾´ã€æœè£…
*æ€§æ ¼ãƒ»è£æ€§æ ¼
*ç’°å¢ƒãƒ»ç”Ÿã„ç«‹ã¡
â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•
*ãƒ’ãƒ­ã‚¤ãƒ³ï¼ˆåå‰ï¼šèª­ã¿æ–¹ã€æ„›ç§°ï¼‰ç”·å¥³ã€æ­³
*é–¢ä¿‚æ€§
*è¦‹ãŸç›®ã€èº«ä½“çš„ç‰¹å¾´ã€æœè£…
*æ€§æ ¼ãƒ»è£æ€§æ ¼
*ç’°å¢ƒãƒ»ç”Ÿã„ç«‹ã¡
â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•
*ãƒ©ã‚¤ãƒãƒ«ï¼ˆåå‰ï¼šèª­ã¿æ–¹ã€æ„›ç§°ï¼‰ç”·å¥³ã€æ­³
*é–¢ä¿‚æ€§
*è¦‹ãŸç›®ã€èº«ä½“çš„ç‰¹å¾´ã€æœè£…
*æ€§æ ¼ãƒ»è£æ€§æ ¼
*ç’°å¢ƒãƒ»ç”Ÿã„ç«‹ã¡`;

                    // åˆæœŸXMLå€¤ã‚‚ã‚»ãƒªãƒ•ãŒç©ºã§ã‚‚ã‚¿ã‚°ãŒã‚ã‚‹ã‚ˆã†ã«å¤‰æ›´
mainEditor.value = `<root><ã‚·ãƒ¼ãƒ³><ã‚·ãƒ¼ãƒ³èª¬æ˜>æ–°ã—ã„ã‚·ãƒ¼ãƒ³</ã‚·ãƒ¼ãƒ³èª¬æ˜><ãƒšãƒ¼ã‚¸><ãƒšãƒ¼ã‚¸èª¬æ˜>æ–°ã—ã„ãƒšãƒ¼ã‚¸</ãƒšãƒ¼ã‚¸èª¬æ˜></ãƒšãƒ¼ã‚¸></ã‚·ãƒ¼ãƒ³></root>`; 
                    history = [mainEditor.value];
                    historyIndex = 0;

                    setSectionVisibility(outlineContentDiv, false);
                    setSectionVisibility(characterContentDiv, false);
                    setSectionVisibility(mainEditorContentDiv, true);
                    currentColumnIndex = 0; 
                }
                showColumn(currentColumnIndex); 
                updateUIImmediate();
                // autoResizeAllTextareas(); // ã“ã‚Œã¯updateUIImmediateå†…ã§setTimeoutã§å‘¼ã³å‡ºã™
            }

            function setSectionVisibility(contentDiv, isHidden) {
                const toggleBtn = contentDiv.previousElementSibling.querySelector('.toggle-btn');
                const addCharBtn = contentDiv.previousElementSibling.querySelector('.add-character-btn');
                if (isHidden) {
                    contentDiv.classList.add('hidden');
                    if (toggleBtn) toggleBtn.textContent = 'é–‹ã';
                    if (addCharBtn) addCharBtn.style.display = 'none';
                } else {
                    contentDiv.classList.remove('hidden');
                    if (toggleBtn) toggleBtn.textContent = 'éš ã™';
                    if (addCharBtn) addCharBtn.style.display = 'inline-block';
                }
                if (!isHidden && contentDiv.querySelector('textarea')) { 
                    autoResizeTextArea(contentDiv.querySelector('textarea'));
                }
            }

            function updateUI() {
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(() => {
                    updateUndoRedoButtons();
                    syncColumnsFromMainEditor();
                    setTimeout(autoResizeAllTextareas, 50); // Small delay
                    saveState();
                    console.log('UI updated and State saved (debounced).');
                }, DEBOUNCE_DELAY);
            }

            function updateUIImmediate() {
                updateUndoRedoButtons();
                syncColumnsFromMainEditor();
                setTimeout(autoResizeAllTextareas, 50); // Small delay to ensure DOM is rendered before resizing
                saveState();
                console.log('UI updated and State saved (immediate).');
            }

            function updateUndoRedoButtons() {
                undoBtn.disabled = historyIndex === 0;
                redoBtn.disabled = historyIndex === history.length - 1;
            }

            function addToHistory(content) {
                if (history.length > 0 && history[historyIndex] === content) {
                    return;
                }
                if (historyIndex < history.length - 1) {
                    history = history.slice(0, historyIndex + 1);
                }
                history.push(content);
                if (history.length > MAX_HISTORY) {
                    history.shift();
                } else {
                    historyIndex++;
                }
                updateUndoRedoButtons();
            }

            openBtn.addEventListener('click', async () => {
                try {
                    const [fileHandle] = await window.showOpenFilePicker({
                        types: [
                            {
                                description: 'Text Files',
                                accept: {
                                    'text/plain': ['.txt'],
                                },
                            },
                        ],
                    });
                    const file = await fileHandle.getFile();
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        extractAndSetSeparateContents(event.target.result);
                        currentFileName = file.name;
                        currentFileHandle = fileHandle;
                        history = [mainEditor.value];
                        historyIndex = 0;
                        updateUIImmediate();
                    };
                    reader.onerror = () => {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    };
                    reader.readAsText(file);
                } catch (err) {
                    if (err.name === 'AbortError') {
                        console.log('File picker was cancelled.');
                    } else {
                        console.error('Error opening file:', err);
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚ªãƒ¼ãƒ—ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                    }
                }
            });

            async function saveContentToDisk(handle = null, silent = false) { // silentå¼•æ•°ã‚’è¿½åŠ 
                const xmlContent = mainEditor.value;
                const fullContentToSave = `[ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³:]\n${outlineEditor.value}\n\n` +
                                          `[ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:]\n${characterEditor.value}\n\n` +
                                          `[ãƒãƒ¼ãƒ æœ¬ä½“(XML):]\n${xmlContent}\n\n` +
                                          `[ã‚»ãƒªãƒ•ä¸€è¦§(ä»Šå¾Œå»ƒæ­¢):]\n`;

                try {
                    if (handle) { // fileHandleãŒæ¸¡ã•ã‚ŒãŸå ´åˆï¼ˆç°¡æ˜“ä¿å­˜ï¼‰
                        try {
                            const writable = await handle.createWritable();
                            await writable.write(fullContentToSave);
                            await writable.close();
                            if (!silent) { // silentãŒtrueã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã•ãªã„
                                alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ: ${handle.name}`);
                            }
                            currentFileHandle = handle; // æˆåŠŸã—ãŸãƒãƒ³ãƒ‰ãƒ«ã‚’ç¾åœ¨ã®ãƒãƒ³ãƒ‰ãƒ«ã¨ã—ã¦ä¿æŒ
                            currentFileName = handle.name;
                            return true; // æˆåŠŸã—ãŸã‚‰trueã‚’è¿”ã™
                        } catch (writeError) {
                            console.warn('ç°¡æ˜“ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥åä¿å­˜ã‚’è©¦ã¿ã¾ã™:', writeError); // ãƒ•ã‚¡ã‚¤ãƒ«ãŒç§»å‹•ã•ã‚ŒãŸãªã©ã§ä¸Šæ›¸ãä¿å­˜ã§ããªã„å ´åˆã¯ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§åˆ¥åä¿å­˜
                        }
                    }

                    // handleãŒnullã®å ´åˆã€ã¾ãŸã¯ç°¡æ˜“ä¿å­˜ã«å¤±æ•—ã—ãŸå ´åˆ
                    const newHandle = await window.showSaveFilePicker({
                        types: [
                            {
                                description: 'Text Files',
                                accept: {
                                    'text/plain': ['.txt'],
                                },
                            },
                        ],
                        suggestedName: currentFileName
                    });
                    const writable = await newHandle.createWritable();
                    await writable.write(fullContentToSave);
                    await writable.close();
                    if (!silent) { // silentãŒtrueã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã•ãªã„
                        alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ: ${newHandle.name}`);
                    }
                    currentFileHandle = newHandle; // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ«ã‚’ä¿å­˜
                    currentFileName = newHandle.name; // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä¿å­˜
                    return true; // æˆåŠŸã—ãŸã‚‰trueã‚’è¿”ã™
                } catch (err) {
                    if (err.name === 'AbortError') {
                        console.log('Save operation was cancelled.');
                    } else {
                        console.error('Error saving file:', err);
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                    }
                    return false; // å¤±æ•—ã—ãŸã‚‰falseã‚’è¿”ã™
                }
            }

            saveBtn.addEventListener('click', async () => {
                if (currentFileHandle) { // æ—¢ã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
                    const overwriteConfirmed = confirm(`ã€Œ${currentFileName}ã€ã«ä¸Šæ›¸ãä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ\n\nã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’é¸ã¶ã¨ã€åå‰ã‚’å¤‰ãˆã¦ä¿å­˜ã™ã‚‹ã‹é¸æŠã§ãã¾ã™ã€‚`);
                    if (overwriteConfirmed) { // ã¯ã„ï¼ˆä¸Šæ›¸ãï¼‰
                        await saveContentToDisk(currentFileHandle, false); // silentã‚’falseã«ã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™
                    } else { // ã„ã„ãˆï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰ -> åå‰ã‚’å¤‰ãˆã¦ä¿å­˜ã™ã‚‹ã‹å°‹ã­ã‚‹
                        const saveAsConfirmed = confirm('åå‰ã‚’å¤‰ãˆã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ');
                        if (saveAsConfirmed) { // ã¯ã„ï¼ˆåå‰ã‚’å¤‰ãˆã¦ä¿å­˜ï¼‰
                            await saveContentToDisk(null, false); // silentã‚’falseã«ã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™
                        }
                        // ã„ã„ãˆï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰ -> ä½•ã‚‚ã—ãªã„
                    }
                } else { // ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ«ãŒã¾ã å­˜åœ¨ã—ãªã„å ´åˆï¼ˆåˆå›ä¿å­˜ï¼‰
                    await saveContentToDisk(null, false); // silentã‚’falseã«ã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™
                }
            });

            saveAsBtn.addEventListener('click', async () => {
                // å¸¸ã«åˆ¥åä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
                await saveContentToDisk(null, false); // silentã‚’falseã«ã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™
            });

            const mainColumn = document.querySelector('.column.main-column');
            document.body.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (window.innerWidth > 768) {
                    document.body.classList.add('drag-over');
                }
            });

            document.body.addEventListener('dragleave', (e) => {
                if (window.innerWidth > 768) {
                    if (!mainColumn.contains(e.relatedTarget) && e.relatedTarget !== null) {
                        document.body.classList.remove('drag-over');
                    }
                }
            });

            mainColumn.addEventListener('drop', async (e) => {
                e.preventDefault();
                document.body.classList.remove('drag-over');

                const file = e.dataTransfer.files[0];
                if (file && file.type === 'text/plain') {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        extractAndSetSeparateContents(event.target.result);
                        currentFileName = file.name;
                        currentFileHandle = null; // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§é–‹ã„ãŸå ´åˆã¯ãƒãƒ³ãƒ‰ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                        history = [mainEditor.value];
                        historyIndex = 0;
                        updateUIImmediate();
                    };
                    reader.onerror = () => {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    };
                    reader.readAsText(file);
                }
            });

            function extractAndSetSeparateContents(fullText) {
                const extracted = { outline: '', character: '', main: '' };

                const outlineMatch = fullText.match(/\[ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³:\]\n([\s\S]*?)(?=\n*\[ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:\]|\n*\[ãƒãƒ¼ãƒ æœ¬ä½“\(XML\):\]|\n*\[ã‚»ãƒªãƒ•ä¸€è¦§\(ä»Šå¾Œå»ƒæ­¢\):\]|$)/);
                if (outlineMatch) extracted.outline = outlineMatch[1].trim();
                else if (fullText.includes('[ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³:]')) extracted.outline = ''; // ã‚¿ã‚°ã¯ã‚ã‚‹ãŒå†…å®¹ãŒãªã„å ´åˆ

                const characterMatch = fullText.match(/\[ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:\]\n([\s\S]*?)(?=\n*\[ãƒãƒ¼ãƒ æœ¬ä½“\(XML\):\]|\n*\[ã‚»ãƒªãƒ•ä¸€è¦§\(ä»Šå¾Œå»ƒæ­¢\):\]|$)/);
                if (characterMatch) extracted.character = characterMatch[1].trim();
                else if (fullText.includes('[ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:]')) extracted.character = ''; // ã‚¿ã‚°ã¯ã‚ã‚‹ãŒå†…å®¹ãŒãªã„å ´åˆ

                const mainXmlMatch = fullText.match(/\[ãƒãƒ¼ãƒ æœ¬ä½“\(XML\):\]\n([\s\S]*?)(?=\n*\[ã‚»ãƒªãƒ•ä¸€è¦§\(ä»Šå¾Œå»ƒæ­¢\):\]|$)/);
                if (mainXmlMatch) extracted.main = mainXmlMatch[1].trim();
                else if (fullText.includes('[ãƒãƒ¼ãƒ æœ¬ä½“(XML):]')) extracted.main = ''; // ã‚¿ã‚°ã¯ã‚ã‚‹ãŒå†…å®¹ãŒãªã„å ´åˆ
                
                // ã©ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚°ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã¯ã€mainEditorã«å…¨ã¦å…¥ã‚Œã‚‹
                if (!outlineMatch && !characterMatch && !mainXmlMatch) {
                    extracted.main = fullText;
                }

                outlineEditor.value = extracted.outline;
                characterEditor.value = extracted.character;
                mainEditor.value = extracted.main;
            }

            // ã‚«ã‚¹ã‚¿ãƒ XMLã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºé–¢æ•°
            function serializeXmlToCompactString(node) {
                let result = '';

                if (!node) {
                    return result;
                }

                if (node.nodeType === Node.ELEMENT_NODE) {
                    result += `<${node.tagName}>`;
                    for (let child of node.childNodes) {
                        result += serializeXmlToCompactString(child);
                    }
                    result += `</${node.tagName}>`;
                } else if (node.nodeType === Node.TEXT_NODE) {
                    // XMLã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
                    result += node.textContent
                                .replace(/&/g, '&amp;')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;')
                                .replace(/"/g, '&quot;')
                                .replace(/'/g, '&apos;');
                } else if (node.nodeType === Node.CDATA_SECTION_NODE) {
                    result += `<![CDATA[${node.textContent}]]>`;
                } else if (node.nodeType === Node.COMMENT_NODE) {
                    result += ``;
                }
                // ä»–ã®ãƒãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã¯ç„¡è¦–
                return result;
            }


            function syncColumnsFromMainEditor() {
                const mainText = mainEditor.value;

                // ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†æ§‹ç¯‰
                sceneNodeIdToDomElementMap.clear();
                pageNodeIdToDomElementMap.clear();
                sceneNodeIdToFirstPageDomElementMap.clear();
                dialogueNodeIdToDomElementMap.clear();
                nodeIdCounter = 0; // ãƒãƒ¼ãƒ‰IDã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ

                try {
                    let textToParse = mainText.trim();
                    if (!textToParse.startsWith('<root>') || !textToParse.endsWith('</root>')) {
                        // rootã‚¿ã‚°ãŒãªã„å ´åˆã§ã‚‚ãƒ‘ãƒ¼ã‚¹ã‚’è©¦ã¿ã‚‹ãŒã€ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å¯èƒ½æ€§ã‚’è€ƒæ…®
                        textToParse = `<root>${textToParse}</root>`; 
                    }
                    currentXmlDoc = xmlParser.parseFromString(textToParse, 'application/xml');

                    const parserError = currentXmlDoc.querySelector('parsererror');
                    if (parserError) {
                        console.error('XML Parsing Error:', parserError.textContent);
                        const errorMessage = '<p style="color: red;">XMLãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ã®è¨˜è¿°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
                        sceneContentDiv.innerHTML = errorMessage;
                        pageContentDiv.innerHTML = errorMessage;
                        dialogueContentDiv.innerHTML = errorMessage;
                        return; // <--- IMPORTANT: Returns here on parse error.
                    }
                } catch (e) {
                    console.error('Failed to parse XML:', e);
                    const errorMessage = '<p style="color: red;">XMLãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
                    sceneContentDiv.innerHTML = errorMessage;
                    pageContentDiv.innerHTML = errorMessage;
                    dialogueContentDiv.innerHTML = errorMessage;
                    return; // <--- IMPORTANT: Returns here on parse error.
                }

                const scenes = currentXmlDoc.querySelectorAll('ã‚·ãƒ¼ãƒ³');
                const sceneItems = [];
                scenes.forEach((sceneElement, index) => {
                    const nodeId = `node-${nodeIdCounter++}`; 
                    sceneItems.push({
                        title: `ã‚·ãƒ¼ãƒ³${index + 1}`,
                        text: sceneElement.querySelector('ã‚·ãƒ¼ãƒ³èª¬æ˜')?.textContent || '',
                        nodeId: nodeId, 
                        rawNode: sceneElement, 
                        sceneIndex: index
                    });
                });
                renderSceneColumnContent(sceneContentDiv, sceneItems);

                // --- ãƒšãƒ¼ã‚¸ã‚«ãƒ©ãƒ ã®æç”» ---
                pageContentDiv.innerHTML = '';
                let globalPageIndex = 1;
                if (scenes.length === 0) {
                    const p = document.createElement('p');
                    p.textContent = `ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã‹ã‚‰ãƒšãƒ¼ã‚¸ã‚’æŠ½å‡ºã—ã¾ã™ã€‚`;
                    pageContentDiv.appendChild(p);
                } else {
                    scenes.forEach((sceneElement, sceneIndex) => {
                        const sceneNodeIdForDom = [...sceneNodeIdToDomElementMap.keys()].find(key => sceneNodeIdToDomElementMap.get(key).xmlNode === sceneElement);
                        const sceneTitle = `ã‚·ãƒ¼ãƒ³${sceneIndex + 1}`;
                        const sceneColorClass = `scene-color-${sceneIndex % 5}`; 

                        const pagesInScene = sceneElement.querySelectorAll('ãƒšãƒ¼ã‚¸');
                        
                        if (pagesInScene.length === 0) {
                            const p = document.createElement('p');
                            p.textContent = `ã“ã®ã‚·ãƒ¼ãƒ³ã«ã¯ãƒšãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`;
                            p.style.fontSize = '0.9em';
                            p.style.color = '#777';
                            p.style.marginLeft = '10px';
                            p.style.marginBottom = '10px';
                            pageContentDiv.appendChild(p);
                        } 
                        
                        pagesInScene.forEach((pageElement, pageIndexInScene) => { // pageIndexInSceneã‚’è¿½åŠ 
                            const nodeId = `node-${nodeIdCounter++}`;
                            const pageItemContainer = document.createElement('div');
                            pageItemContainer.classList.add('page-item-container');
                            pageItemContainer.setAttribute('data-node-id', nodeId); 
                            pageItemContainer.xmlNode = pageElement; // XMLãƒãƒ¼ãƒ‰ã‚’DOMè¦ç´ ã«ç´ä»˜ã‘
                            pageItemContainer.setAttribute('data-parent-scene-id', sceneNodeIdForDom); // è¦ªã‚·ãƒ¼ãƒ³ã®DOM IDã‚’ä¿æŒ
                            pageItemContainer.setAttribute('data-scene-index', sceneIndex); // ã‚·ãƒ¼ãƒ³ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                            pageItemContainer.setAttribute('data-page-index-in-scene', pageIndexInScene); // ã‚·ãƒ¼ãƒ³å†…ã®ãƒšãƒ¼ã‚¸ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                            pageItemContainer.classList.add(sceneColorClass); 
                            
                            pageItemContainer.addEventListener('click', (event) => {
                                setActiveElement(pageItemContainer, 'page');
                                showColumn(2); 
                                if (window.innerWidth > 768) { 
                                    pageItemContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }
                            });

                            const pageHeader = document.createElement('div');
                            pageHeader.classList.add('page-item-header');
                            const pageTitleBadge = document.createElement('span');
                            pageTitleBadge.classList.add('page-title-badge');
                            pageTitleBadge.textContent = `ãƒšãƒ¼ã‚¸${globalPageIndex}`;
                            pageHeader.appendChild(pageTitleBadge);

                            const deleteButton = document.createElement('button');
                            deleteButton.classList.add('delete-page-btn');
                            deleteButton.textContent = 'å‰Šé™¤';
                            deleteButton.addEventListener('click', (e) => {
                                e.stopPropagation(); 
                                deletePage(pageItemContainer.xmlNode, `ãƒšãƒ¼ã‚¸${globalPageIndex}`);
                            });
                            pageHeader.appendChild(deleteButton);
                            pageItemContainer.appendChild(pageHeader);

                            const itemTextArea = document.createElement('textarea');
                            // <ãƒšãƒ¼ã‚¸èª¬æ˜>ã¨<ã‚»ãƒªãƒ•>ã®å†…å®¹ã‚’çµåˆã—ã¦textareaã«è¡¨ç¤º
                            let combinedText = '';
                            pageElement.childNodes.forEach(child => {
                                if (child.nodeType === Node.ELEMENT_NODE) {
                                    if (child.tagName === 'ãƒšãƒ¼ã‚¸èª¬æ˜') {
                                        combinedText += child.textContent;
                                    } else if (child.tagName === 'ã‚»ãƒªãƒ•') {
                                        combinedText += `ã€Œ${child.textContent}ã€`;
                                    }
                                } else if (child.nodeType === Node.TEXT_NODE && child.textContent.trim().length > 0) {
                                    // è¦ç´ é–“ã®ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã‚‚è€ƒæ…®ï¼ˆãŸã ã—ã€ä»Šå›ã®XMLæ§‹é€ ã§ã¯ã‚ã¾ã‚Šç™ºç”Ÿã—ãªã„ã¯ãšï¼‰
                                    combinedText += child.textContent;
                                }
                            });
                            itemTextArea.value = combinedText;

                            itemTextArea.classList.add('page-text'); 
                            itemTextArea.placeholder = 'ãƒšãƒ¼ã‚¸å†…ã®èª¬æ˜ã‚„ã‚»ãƒªãƒ•';
                            itemTextArea.addEventListener('input', (e) => {
                                autoResizeTextArea(e.target);
                                // updatePageContentInXmlã«ã€DOMè¦ç´ ã®å‚ç…§ã¨ãƒ†ã‚­ã‚¹ãƒˆã€ãã—ã¦ã‚·ãƒ¼ãƒ³ã¨ãƒšãƒ¼ã‚¸ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¸¡ã™
                                updatePageContentInXml(
                                    pageItemContainer.getAttribute('data-scene-index'),
                                    pageItemContainer.getAttribute('data-page-index-in-scene'),
                                    e.target.value // å…¥åŠ›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆå…¨ä½“ã‚’æ¸¡ã™
                                );
                            });
                            itemTextArea.addEventListener('change', () => { 
                                updateUIImmediate(); 
                            });
                            pageItemContainer.appendChild(itemTextArea);
                            autoResizeTextArea(itemTextArea); 
                            
                            pageContentDiv.appendChild(pageItemContainer);
                            pageNodeIdToDomElementMap.set(nodeId, pageItemContainer);

                            if (!sceneNodeIdToFirstPageDomElementMap.has(sceneNodeIdForDom)) {
                                sceneNodeIdToFirstPageDomElementMap.set(sceneNodeIdForDom, pageItemContainer);
                            }
                            globalPageIndex++;
                        });
                        
                        const addPageButtonForScene = document.createElement('button');
                        addPageButtonForScene.classList.add('add-page-to-scene-btn');
                        addPageButtonForScene.textContent = `ã€Œ${sceneTitle}ã€ã«ãƒšãƒ¼ã‚¸ã‚’è¿½åŠ `;
                        addPageButtonForScene.setAttribute('data-scene-node-id', sceneNodeIdForDom); 
                        addPageButtonForScene.xmlNode = sceneElement; 
                        addPageButtonForScene.addEventListener('click', (e) => {
                            e.stopPropagation(); 
                            addPageToSpecificScene(sceneElement); 
                        });
                        pageContentDiv.appendChild(addPageButtonForScene);
                    });
                }
                
                // --- ã‚»ãƒªãƒ•ã‚«ãƒ©ãƒ ã®æç”» ---
                dialogueContentDiv.innerHTML = '';
                let globalPageIndexForDialogue = 1; // ã‚»ãƒªãƒ•ã‚«ãƒ©ãƒ æç”»ç”¨ã®ãƒšãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
                if (scenes.length === 0) {
                    const p = document.createElement('p');
                    p.textContent = `ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã‹ã‚‰ã‚»ãƒªãƒ•ã‚’æŠ½å‡ºã—ã¾ã™ã€‚`;
                    dialogueContentDiv.appendChild(p);
                } else {
                    scenes.forEach((sceneElement, sceneIndex) => {
                        const pagesInScene = sceneElement.querySelectorAll('ãƒšãƒ¼ã‚¸');

                        pagesInScene.forEach((pageElement, pageIndexInScene) => {
                            const dialoguesInPage = pageElement.querySelectorAll('ã‚»ãƒªãƒ•');
                            // XMLãƒãƒ¼ãƒ‰ã¨DOMè¦ç´ ã®é–¢é€£ä»˜ã‘ã®ãŸã‚ã«ã€pageElementã®nodeIdã‚’å–å¾—
                            const pageNodeIdForDom = [...pageNodeIdToDomElementMap.keys()].find(key => pageNodeIdToDomElementMap.get(key).xmlNode === pageElement);

                            if (dialoguesInPage.length > 0) {
                                // ãƒšãƒ¼ã‚¸ã”ã¨ã®ã‚»ãƒªãƒ•ã‚’ã¾ã¨ã‚ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠ
                                const serifPageGroupContainer = document.createElement('div');
                                serifPageGroupContainer.classList.add('serif-page-group-container');

                                // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒè¿½åŠ ãƒ»ä¿®æ­£éƒ¨åˆ† â˜…â˜…â˜…
                                // ãƒšãƒ¼ã‚¸ç•ªå·ã‚’è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
                                const pageHeader = document.createElement('p');
                                pageHeader.style.fontWeight = 'bold';
                                pageHeader.style.color = '#333';
                                pageHeader.style.fontSize = '0.9em';
                                pageHeader.style.marginBottom = '5px';
                                pageHeader.style.paddingBottom = '5px';
                                pageHeader.style.borderBottom = '1px dashed #ccc';
                                // ãƒšãƒ¼ã‚¸ã‚«ãƒ©ãƒ ã¨ä¸€è²«æ€§ã‚’æŒãŸã›ã‚‹ãŸã‚ã«ã€é€šã—ç•ªå·ã‚’ä½¿ç”¨
                                pageHeader.textContent = `ãƒšãƒ¼ã‚¸ ${globalPageIndexForDialogue}`;
                                serifPageGroupContainer.appendChild(pageHeader);
                                // â˜…â˜…â˜… ã“ã“ã¾ã§ãŒè¿½åŠ ãƒ»ä¿®æ­£éƒ¨åˆ† â˜…â˜…â˜…

                                dialoguesInPage.forEach((dialogueElement, dialogueIndexInPage) => {
                                    const nodeId = `node-${nodeIdCounter++}`;
                                    const dialogueContentDivItem = document.createElement('div');
                                    dialogueContentDivItem.classList.add('dialogue-content');
                                    dialogueContentDivItem.setAttribute('data-node-id', nodeId);
                                    dialogueContentDivItem.xmlNode = dialogueElement;
                                    dialogueContentDivItem.setAttribute('data-parent-page-id', pageNodeIdForDom);
                                    dialogueContentDivItem.setAttribute('data-scene-index', sceneIndex);
                                    dialogueContentDivItem.setAttribute('data-page-index-in-scene', pageIndexInScene);
                                    dialogueContentDivItem.setAttribute('data-dialogue-index-in-page', dialogueIndexInPage);

                                    dialogueContentDivItem.textContent = dialogueElement.textContent; // divã®textContentã«è¨­å®š
                                    dialogueContentDivItem.style.minHeight = '1.6em'; // æœ€å°ã®é«˜ã•ã‚’ç¢ºä¿
                                    dialogueContentDivItem.style.whiteSpace = 'pre-wrap'; // æ”¹è¡Œã‚’åæ˜ 
                                    dialogueContentDivItem.style.wordWrap = 'break-word'; // é•·ã„å˜èªã®æŠ˜ã‚Šè¿”ã—

                                    dialogueContentDivItem.addEventListener('click', (event) => {
                                        setActiveElement(dialogueContentDivItem, 'dialogue');
                                        showColumn(3);
                                        if (window.innerWidth > 768) {
                                            dialogueContentDivItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        }
                                    });

                                    serifPageGroupContainer.appendChild(dialogueContentDivItem); // ãƒšãƒ¼ã‚¸ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ 
                                    dialogueNodeIdToDomElementMap.set(nodeId, dialogueContentDivItem);
                                });
                                dialogueContentDiv.appendChild(serifPageGroupContainer); // ã‚»ãƒªãƒ•ã‚«ãƒ©ãƒ å…¨ä½“ã«è¿½åŠ 
                            }
                            
                            // ãƒšãƒ¼ã‚¸ã‚’1ã¤å‡¦ç†ã—ãŸã®ã§ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
                            globalPageIndexForDialogue++;
                        });
                    });
                }
                highlightActiveElements();
            }

            function renderSceneColumnContent(container, sceneItems) {
                container.innerHTML = '';
                if (sceneItems.length === 0) {
                    const p = document.createElement('p');
                    p.textContent = `ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã‹ã‚‰ã‚·ãƒ¼ãƒ³ã‚’æŠ½å‡ºã—ã¾ã™ã€‚`;
                    container.appendChild(p);
                    return;
                }

                sceneItems.forEach(item => {
                    const sceneItemContainer = document.createElement('div');
                    sceneItemContainer.classList.add('scene-item-container');
                    sceneItemContainer.classList.add(`scene-color-${item.sceneIndex % 5}`); 
                    sceneItemContainer.setAttribute('data-node-id', item.nodeId); 
                    sceneItemContainer.xmlNode = item.rawNode; 
                    sceneItemContainer.setAttribute('data-scene-index', item.sceneIndex); // ã‚·ãƒ¼ãƒ³ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’DOMã«ä¿æŒ
                    
                    const header = document.createElement('div');
                    header.classList.add('scene-item-header');

                    const titleBadge = document.createElement('span');
                    titleBadge.classList.add('scene-title-badge');
                    titleBadge.textContent = item.title;
                    header.appendChild(titleBadge);

                    const deleteButton = document.createElement('button');
                    deleteButton.classList.add('delete-scene-btn');
                    deleteButton.textContent = 'å‰Šé™¤';
                    deleteButton.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        deleteScene(sceneItemContainer.xmlNode); 
                    });
                    header.appendChild(deleteButton);
                    sceneItemContainer.appendChild(header);

                    const itemTextArea = document.createElement('textarea');
                    itemTextArea.value = item.text;
                    itemTextArea.classList.add('scene-text'); 
                    itemTextArea.placeholder = 'ã‚·ãƒ¼ãƒ³ã®èª¬æ˜';
                    itemTextArea.addEventListener('input', (e) => {
                        autoResizeTextArea(e.target);
                        // updateSceneContentInXmlã«ã‚·ãƒ¼ãƒ³ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¸¡ã™
                        updateSceneContentInXml(sceneItemContainer.getAttribute('data-scene-index'), e.target.value); 
                    });
                    itemTextArea.addEventListener('change', () => { 
                        updateUIImmediate(); 
                    });
                    sceneItemContainer.appendChild(itemTextArea);
                    autoResizeTextArea(itemTextArea); 

                    sceneItemContainer.addEventListener('click', () => {
                        setActiveElement(sceneItemContainer, 'scene');
                        const firstPageElement = sceneNodeIdToFirstPageDomElementMap.get(item.nodeId); 
                        if (firstPageElement) {
                            setActiveElement(firstPageElement, 'page');
                            showColumn(2); 
                            if (window.innerWidth > 768) { 
                                setTimeout(() => {
                                    firstPageElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }, 300); 
                            }
                        } else {
                            showColumn(2);
                        }
                    });
                    
                    container.appendChild(sceneItemContainer);
                    sceneNodeIdToDomElementMap.set(item.nodeId, sceneItemContainer);
                });
            }

            // XMLãƒ„ãƒªãƒ¼ã‚’æ¢ç´¢ã—ã¦å¯¾è±¡ã®ã‚·ãƒ¼ãƒ³è¦ç´ ã‚’ç‰¹å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            function getSceneElementByIndex(sceneIndex) {
                const scenes = currentXmlDoc.querySelectorAll('ã‚·ãƒ¼ãƒ³');
                return scenes[sceneIndex] || null;
            }

            // XMLãƒ„ãƒªãƒ¼ã‚’æ¢ç´¢ã—ã¦å¯¾è±¡ã®ãƒšãƒ¼ã‚¸è¦ç´ ã‚’ç‰¹å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            function getPageElementByIndex(sceneIndex, pageIndexInScene) {
                const sceneElement = getSceneElementByIndex(sceneIndex);
                if (sceneElement) {
                    const pages = sceneElement.querySelectorAll('ãƒšãƒ¼ã‚¸');
                    return pages[pageIndexInScene] || null;
                }
                return null;
            }

            // XMLãƒ„ãƒªãƒ¼ã‚’æ¢ç´¢ã—ã¦å¯¾è±¡ã®ã‚»ãƒªãƒ•è¦ç´ ã‚’ç‰¹å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            function getDialogueElementByIndex(sceneIndex, pageIndexInScene, dialogueIndexInPage) {
                const pageElement = getPageElementByIndex(sceneIndex, pageIndexInScene);
                if (pageElement) {
                    const dialogues = pageElement.querySelectorAll('ã‚»ãƒªãƒ•');
                    return dialogues[dialogueIndexInPage] || null;
                }
                return null;
            }


            // ã‚·ãƒ¼ãƒ³ã®æ›´æ–°é–¢æ•°ã‚’ä¿®æ­£
            function updateSceneContentInXml(sceneIndex, newText) {
                const sceneElement = getSceneElementByIndex(sceneIndex);
                if (sceneElement) {
                    let sceneDescElement = sceneElement.querySelector('ã‚·ãƒ¼ãƒ³èª¬æ˜');
                    if (!sceneDescElement) {
                        sceneDescElement = currentXmlDoc.createElement('ã‚·ãƒ¼ãƒ³èª¬æ˜');
                        sceneElement.insertBefore(sceneDescElement, sceneElement.firstChild);
                    }
                    sceneDescElement.textContent = newText;
                    mainEditor.value = serializeXmlToCompactString(currentXmlDoc.documentElement); // ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ã‚’ä½¿ç”¨
                    addToHistory(mainEditor.value);
                }
            }

            // ãƒšãƒ¼ã‚¸ã®æ›´æ–°é–¢æ•°ã‚’ä¿®æ­£
            function updatePageContentInXml(sceneIndex, pageIndexInScene, fullPageText) { 
                const pageElement = getPageElementByIndex(sceneIndex, pageIndexInScene);
                if (pageElement) {
                    // æ—¢å­˜ã®<ãƒšãƒ¼ã‚¸èª¬æ˜>ã¨<ã‚»ãƒªãƒ•>è¦ç´ ã‚’ã™ã¹ã¦å‰Šé™¤
                    // ã“ã‚Œã«ã‚ˆã‚Šã€æ–°ã—ã„å†…å®¹ã§å®Œå…¨ã«å†æ§‹ç¯‰ã•ã‚Œã‚‹
                    pageElement.querySelectorAll('ãƒšãƒ¼ã‚¸èª¬æ˜, ã‚»ãƒªãƒ•').forEach(el => pageElement.removeChild(el));

                    // æ­£è¦è¡¨ç¾ã§ã€Œã€ã§å›²ã¾ã‚ŒãŸã‚»ãƒªãƒ•ã‚’æŠ½å‡º
                    // å¤‰æ›´ç‚¹: æ”¹è¡Œã‚’å«ã‚€ä»»æ„ã®ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è€ƒæ…®ã§ãã‚‹ã‚ˆã†ã€Œ[^ã€]*ã€ã‚’ã€Œ([\s\S]*?)ã€ã«å¤‰æ›´
                    const dialogueRegex = /ã€Œ([\s\S]*?)ã€/g;
                    let lastIndex = 0;
                    let contentParts = []; // ãƒšãƒ¼ã‚¸èª¬æ˜ã¨ã‚»ãƒªãƒ•ã®é †åºã‚’ä¿æŒã™ã‚‹é…åˆ—

                    let match;
                    while ((match = dialogueRegex.exec(fullPageText)) !== null) {
                        // ã‚»ãƒªãƒ•ã®å‰ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆãƒšãƒ¼ã‚¸èª¬æ˜ã®ä¸€éƒ¨ï¼‰
                        if (match.index > lastIndex) {
                            contentParts.push({ type: 'desc', text: fullPageText.substring(lastIndex, match.index) });
                        }

                        // ã‚»ãƒªãƒ•æœ¬ä½“ï¼ˆã€Œã€ã®ä¸­èº«ï¼‰
                        const dialogueText = match[1]; 
                        contentParts.push({ type: 'dialogue', text: dialogueText });

                        lastIndex = dialogueRegex.lastIndex;
                    }

                    // æ®‹ã‚Šã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæœ€å¾Œã®ã‚»ãƒªãƒ•ã®å¾Œã€ã¾ãŸã¯ã‚»ãƒªãƒ•ãŒãªã„å ´åˆï¼‰
                    if (lastIndex < fullPageText.length) {
                        contentParts.push({ type: 'desc', text: fullPageText.substring(lastIndex) });
                    }
                    
                    // contentPartsã«åŸºã¥ã„ã¦æ–°ã—ã„è¦ç´ ã‚’ä½œæˆã—ã€pageElementã«è¿½åŠ 
                    contentParts.forEach(part => {
                        if (part.type === 'desc') {
                            // ç©ºè¡Œã ã‘ã®ãƒšãƒ¼ã‚¸èª¬æ˜ã¯è¿½åŠ ã—ãªã„ (trim()å¾Œã®é•·ã•ã§åˆ¤æ–­)
                            // ãŸã ã—ã€æ”¹è¡Œè‡ªä½“ã¯ç¶­æŒã™ã‚‹ãŸã‚ã«textContentã«ã¯ãã®ã¾ã¾ã‚»ãƒƒãƒˆ
                            if (part.text.trim().length > 0 || part.text.includes('\n')) { 
                                const newPageDescElement = currentXmlDoc.createElement('ãƒšãƒ¼ã‚¸èª¬æ˜');
                                newPageDescElement.textContent = part.text; 
                                pageElement.appendChild(newPageDescElement); 
                            }
                        } else if (part.type === 'dialogue') {
                            const newDialogueElement = currentXmlDoc.createElement('ã‚»ãƒªãƒ•');
                            newDialogueElement.textContent = part.text;
                            pageElement.appendChild(newDialogueElement);
                        }
                    });

                    mainEditor.value = serializeXmlToCompactString(currentXmlDoc.documentElement); // ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ã‚’ä½¿ç”¨
                    addToHistory(mainEditor.value);
                }
            }


            // ã‚»ãƒªãƒ•ã®æ›´æ–°é–¢æ•°ã¯divã«ãªã£ãŸã®ã§ã€ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿å´ã‹ã‚‰ã¯å¤‰æ›´ã—ãªã„
            // ã‚ˆã£ã¦ã€ã“ã®é–¢æ•°ã¯å‰Šé™¤ã™ã‚‹ã‹ã€ç©ºã«ã™ã‚‹
            function updateDialogueContentInXml(sceneIndex, pageIndexInScene, dialogueIndexInPage, newText) {
                // ã‚»ãƒªãƒ•ã‚«ãƒ©ãƒ ã¯ç·¨é›†ä¸å¯ãªã®ã§ã€ã“ã®é–¢æ•°ã¯å‘¼ã³å‡ºã•ã‚Œã¾ã›ã‚“
                // ã‚‚ã—å°†æ¥çš„ã«ç·¨é›†å¯èƒ½ã«ã™ã‚‹å ´åˆã¯ã€ã“ã“ã§XMLã‚’æ›´æ–°ã™ã‚‹å‡¦ç†ã‚’è¨˜è¿°ã—ã¾ã™
                console.log("Dialogue content updated (ã‚»ãƒªãƒ•ã‚«ãƒ©ãƒ ã¯ç·¨é›†ä¸å¯ã§ã™):", newText);
            }


            function deleteScene(sceneElement) { 
                if (!confirm('ã“ã®ã‚·ãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿï¼ˆã“ã®ã‚·ãƒ¼ãƒ³å†…ã®ãƒšãƒ¼ã‚¸ã¨ã‚»ãƒªãƒ•ã‚‚å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰')) {
                    return;
                }
                if (sceneElement && sceneElement.parentNode) {
                    sceneElement.parentNode.removeChild(sceneElement);
                    mainEditor.value = serializeXmlToCompactString(currentXmlDoc.documentElement); // ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ã‚’ä½¿ç”¨
                    addToHistory(mainEditor.value);
                    updateUIImmediate(); 
                }
            }

            function deletePage(pageElement, pageTitle) { 
                if (!confirm(`ãƒšãƒ¼ã‚¸ ${pageTitle} ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿï¼ˆã“ã®ãƒšãƒ¼ã‚¸å†…ã®ã‚»ãƒªãƒ•ã‚‚å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰`)) {
                    return;
                }
                if (pageElement && pageElement.parentNode) {
                    pageElement.parentNode.removeChild(pageElement);
                    mainEditor.value = serializeXmlToCompactString(currentXmlDoc.documentElement); // ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ã‚’ä½¿ç”¨
                    addToHistory(mainEditor.value);
                    updateUIImmediate();
                }
            }

            function setActiveElement(element, type) {
                document.querySelectorAll('.active').forEach(el => el.classList.remove('active'));

                if (element) {
                    element.classList.add('active');
                }

                if (type === 'scene') {
                    activeSceneElement = element;
                    activePageElement = null; 
                    activeDialogueElement = null;
                } else if (type === 'page') {
                    activePageElement = element;
                    activeDialogueElement = null; 
                    const parentSceneId = element.getAttribute('data-parent-scene-id');
                    if (parentSceneId) {
                        const parentSceneElement = sceneNodeIdToDomElementMap.get(parentSceneId);
                        if (parentSceneElement && parentSceneElement !== activeSceneElement) {
                            parentSceneElement.classList.add('active');
                            activeSceneElement = parentSceneElement;
                        }
                    }
                } else if (type === 'dialogue') {
                    activeDialogueElement = element;
                    const parentPageId = element.getAttribute('data-parent-page-id');
                    if (parentPageId) {
                        const parentPageElement = pageNodeIdToDomElementMap.get(parentPageId);
                        if (parentPageElement && parentPageElement !== activePageElement) {
                            parentPageElement.classList.add('active');
                            activePageElement = parentPageElement;
                        }
                        const parentSceneId = parentPageElement ? parentPageElement.getAttribute('data-parent-scene-id') : null;
                        if (parentSceneId) {
                            const parentSceneElement = sceneNodeIdToDomElementMap.get(parentSceneId);
                            if (parentSceneElement && parentSceneElement !== activeSceneElement) {
                                parentSceneElement.classList.add('active');
                                activeSceneElement = parentSceneElement;
                            }
                        }
                    }
                }
            }

            function highlightActiveElements() {
                document.querySelectorAll('.active').forEach(el => el.classList.remove('active'));

                if (activeSceneElement && sceneNodeIdToDomElementMap.has(activeSceneElement.getAttribute('data-node-id'))) {
                    sceneNodeIdToDomElementMap.get(activeSceneElement.getAttribute('data-node-id')).classList.add('active');
                }
                if (activePageElement && pageNodeIdToDomElementMap.has(activePageElement.getAttribute('data-node-id'))) {
                    pageNodeIdToDomElementMap.get(activePageElement.getAttribute('data-node-id')).classList.add('active');
                }
                if (activeDialogueElement && dialogueNodeIdToDomElementMap.has(activeDialogueElement.getAttribute('data-node-id'))) {
                    dialogueNodeIdToDomElementMap.get(activeDialogueElement.getAttribute('data-node-id')).classList.add('active');
                }
            }

            function autoResizeTextArea(textarea) {
                if (!textarea || textarea.offsetParent === null) { 
                    return; 
                }
                textarea.style.height = 'auto'; 
                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é«˜ã•ã‚’å–å¾—ã—ã€å°‘ã—ä½™è£•ã‚’æŒãŸã›ã‚‹ï¼ˆä¾‹: +2pxï¼‰
                textarea.style.height = (textarea.scrollHeight + 2) + 'px'; 
            }

            function autoResizeAllTextareas() {
                // ã‚»ãƒªãƒ•ã¯textareaã§ã¯ãªã„ã®ã§ã€textareaã®ã¿ã‚’å¯¾è±¡ã¨ã™ã‚‹
                document.querySelectorAll('textarea').forEach(autoResizeTextArea);
            }

            newBtn.addEventListener('click', clearAllEditors);

            undoBtn.addEventListener('click', undo);
            redoBtn.addEventListener('click', redo);

            mainEditor.addEventListener('input', () => {
                autoResizeTextArea(mainEditor);
                addToHistory(mainEditor.value); 
                updateUI(); 
            });
            mainEditor.addEventListener('change', () => { 
                updateUIImmediate(); 
            });

            outlineEditor.addEventListener('input', () => {
                autoResizeTextArea(outlineEditor);
            });
            outlineEditor.addEventListener('change', () => { 
                updateUIImmediate(); 
            });

            characterEditor.addEventListener('input', () => {
                autoResizeTextArea(characterEditor);
            });
            characterEditor.addEventListener('change', () => { 
                updateUIImmediate(); 
            });

            addCharacterBtn.addEventListener('click', () => {
                const newCharacterTemplate = `\n\nâ€•â€•â€•â€•â€•â€•â€•â€•â€•â€•\n*æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆåå‰ï¼šèª­ã¿æ–¹ã€æ„›ç§°ï¼‰ç”·å¥³ã€æ­³\n*é–¢ä¿‚æ€§\n*è¦‹ãŸç›®ã€èº«ä½“çš„ç‰¹å¾´ã€æœè£…\n*æ€§æ ¼ãƒ»è£æ€§æ ¼\n*ç’°å¢ƒãƒ»ç”Ÿã„ç«‹ã¡`;
                characterEditor.value += newCharacterTemplate;
                autoResizeTextArea(characterEditor);
                characterEditor.focus();
                characterEditor.setSelectionRange(characterEditor.value.length, characterEditor.value.length);
                updateUIImmediate(); 
            });

            addSceneBtn.addEventListener('click', () => {
                const rootElement = currentXmlDoc.querySelector('root');
                if (rootElement) {
                    const newSceneElement = currentXmlDoc.createElement('ã‚·ãƒ¼ãƒ³');
                    const newSceneDescElement = currentXmlDoc.createElement('ã‚·ãƒ¼ãƒ³èª¬æ˜');
                    newSceneDescElement.textContent = 'æ–°ã—ã„ã‚·ãƒ¼ãƒ³';
                    newSceneElement.appendChild(newSceneDescElement);
                    
                    const newPageElement = currentXmlDoc.createElement('ãƒšãƒ¼ã‚¸');
                    const newPageDescElement = currentXmlDoc.createElement('ãƒšãƒ¼ã‚¸èª¬æ˜');
                    newPageDescElement.textContent = 'æ–°ã—ã„ãƒšãƒ¼ã‚¸';
                    newPageElement.appendChild(newPageDescElement);
                    newSceneElement.appendChild(newPageElement);

                    rootElement.appendChild(newSceneElement);
                    
                    mainEditor.value = serializeXmlToCompactString(currentXmlDoc.documentElement); // ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ã‚’ä½¿ç”¨
                    addToHistory(mainEditor.value);
                    updateUIImmediate(); 
                    mainEditor.focus();
                } else {
                    alert("XMLã®<root>ã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ§‹é€ ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                }
            });

            function addPageToSpecificScene(sceneElement) { 
                if (sceneElement) {
                    const newPageElement = currentXmlDoc.createElement('ãƒšãƒ¼ã‚¸');
                    const newPageDescElement = currentXmlDoc.createElement('ãƒšãƒ¼ã‚¸èª¬æ˜');
                    newPageDescElement.textContent = 'æ–°ã—ã„ãƒšãƒ¼ã‚¸';
                    newPageElement.appendChild(newPageDescElement);

                    sceneElement.appendChild(newPageElement); 

                    mainEditor.value = serializeXmlToCompactString(currentXmlDoc.documentElement); // ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ã‚’ä½¿ç”¨
                    addToHistory(mainEditor.value);
                    updateUIImmediate(); 
                    mainEditor.focus();
                } else {
                    alert('é¸æŠã•ã‚ŒãŸã‚·ãƒ¼ãƒ³ãŒXMLå†…ã§è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                }
            }


            toggleButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetId = e.target.dataset.target;
                    const targetContent = document.getElementById(targetId);
                    setSectionVisibility(targetContent, !targetContent.classList.contains('hidden'));
                });
            });

            // ã‚»ãƒªãƒ•ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
            exportDialogueBtn.addEventListener('click', async () => {
                const pageDialogues = []; // ãƒšãƒ¼ã‚¸ã”ã¨ã®ã‚»ãƒªãƒ•ã‚’æ ¼ç´ã™ã‚‹é…åˆ—

                // ãƒšãƒ¼ã‚¸ã”ã¨ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—
                const pageGroupContainers = dialogueContentDiv.querySelectorAll('.serif-page-group-container');
                
                if (pageGroupContainers.length === 0) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã‚»ãƒªãƒ•ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }

                // å„ãƒšãƒ¼ã‚¸ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦ã€ãƒšãƒ¼ã‚¸å†…ã®ã‚»ãƒªãƒ•ã‚’åé›†
                pageGroupContainers.forEach(group => {
                    const dialoguesInPage = [];
                    const dialogueElements = group.querySelectorAll('.dialogue-content');
                    dialogueElements.forEach(dialogueEl => {
                        dialoguesInPage.push(dialogueEl.textContent);
                    });
                    // ãƒšãƒ¼ã‚¸å†…ã®ã‚»ãƒªãƒ•ã‚’ã€Œç©ºç™½è¡Œ1ã¤ã€ã§çµåˆã—ã¦é…åˆ—ã«è¿½åŠ 
                    pageDialogues.push(dialoguesInPage.join('\n\n'));
                });

                // å„ãƒšãƒ¼ã‚¸ã®ã‚»ãƒªãƒ•å¡Šã‚’ã€Œç©ºç™½è¡Œ2ã¤ã€ã§çµåˆã—ã¦æœ€çµ‚çš„ãªãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
                const allDialogues = pageDialogues.join('\n\n\n');

                // â†“â†“â†“ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜å‡¦ç†ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ã§ã™ â†“â†“â†“

                // ãƒ•ã‚¡ã‚¤ãƒ«åã«æ—¥ä»˜ã‚’å«ã‚ã‚‹
                const date = new Date();
                const dateString = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}${date.getSeconds().toString().padStart(2, '0')}`;
                const suggestedFileName = `ã‚»ãƒªãƒ•_${dateString}.txt`;

                try {
                    const fileHandle = await window.showSaveFilePicker({
                        types: [{
                                description: 'Text Files',
                                accept: {
                                    'text/plain': ['.txt'],
                                },
                            },],
                        suggestedName: suggestedFileName
                    });

                    const writable = await fileHandle.createWritable();
                    await writable.write(allDialogues);
                    await writable.close();
                    alert(`ã‚»ãƒªãƒ•ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ: ${suggestedFileName}`);
                } catch (err) {
                    if (err.name === 'AbortError') {
                        console.log('Dialogue export was cancelled.');
                    } else {
                        console.error('Error exporting dialogues:', err);
                        alert('ã‚»ãƒªãƒ•ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                    }
                }
            });


            loadState();
            // autoResizeAllTextareas(); // ã“ã‚Œã¯updateUIImmediateå†…ã§setTimeoutã§å‘¼ã³å‡ºã™

            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let isSwiping = false;   // æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
            let isScrolling = false; // ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

            columnsWrapper.addEventListener('touchstart', (e) => {
                if (window.innerWidth > 768) return;

                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                touchEndX = touchStartX; // touchendã§ä½¿ã†ãŸã‚ã«åˆæœŸåŒ–
                isSwiping = false;   // ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                isScrolling = false; // ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ

                columnsWrapper.style.transition = 'none'; 
                currentTranslateX = parseFloat(columnsWrapper.style.transform.replace('translateX(', '').replace('vw)', '') || '0');
                
            }, { passive: true }); // passive: true ã«ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®é–‹å§‹ã‚’å¦¨ã’ãªã„

            columnsWrapper.addEventListener('touchmove', (e) => {
                if (window.innerWidth > 768 || isScrolling) return;

                const moveX = e.touches[0].clientX;
                const moveY = e.touches[0].clientY;
                const diffX = moveX - touchStartX;
                const diffY = moveY - touchStartY;

                // ã¾ã ã‚¹ãƒ¯ã‚¤ãƒ—ã‚‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚‚é–‹å§‹ã—ã¦ã„ãªã„å ´åˆã€æ–¹å‘ã‚’åˆ¤å®š
                if (!isSwiping && !isScrolling) {
                    // å·¦å³ã®å‹•ããŒä¸Šä¸‹ã®å‹•ãã‚ˆã‚Šå¤§ããã€ã‹ã¤ä¸€å®šä»¥ä¸Šå‹•ã„ãŸå ´åˆã€ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’é–‹å§‹
                    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 10) {
                        isSwiping = true;
                    } else if (Math.abs(diffY) > 10) {
                        // ä¸Šä¸‹ã®å‹•ããŒå„ªå‹¢ãªå ´åˆã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ã¿ãªã—ã€ã“ã®å¾Œã®å‡¦ç†ã‚’ãƒ–ãƒ­ãƒƒã‚¯
                        isScrolling = true;
                        return;
                    }
                }
                
                if (isSwiping) {
                    // ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã¨ç¢ºå®šã—ãŸã‚‰ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼ˆç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã©ï¼‰ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    e.preventDefault();
                    
                    touchEndX = moveX;
                    const transformDiff = (diffX / window.innerWidth) * 100;
                    columnsWrapper.style.transform = `translateX(${currentTranslateX + transformDiff}vw)`;
                }

            }, { passive: false }); // preventDefaultã‚’å‘¼ã¶ã®ã§ passive: false ã«ã™ã‚‹

            columnsWrapper.addEventListener('touchend', (e) => { 
                if (window.innerWidth > 768) return;

                // æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã§ãªã‘ã‚Œã°ã€ä½•ã‚‚ã—ãªã„ï¼ˆç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã©ã‚’å¦¨ã’ãªã„ï¼‰
                if (!isSwiping) {
                    // å¾®å¦™ã«å‹•ã„ã¦ã—ã¾ã£ãŸå ´åˆã«å…ƒã®ä½ç½®ã«æˆ»ã™å‡¦ç†
                    columnsWrapper.style.transition = 'transform 0.3s ease-out';
                    showColumn(currentColumnIndex);
                    return;
                }

                const diff = touchEndX - touchStartX;
                // ã‚¹ãƒ¯ã‚¤ãƒ—ã®é–¾å€¤ã‚’ç”»é¢å¹…ã®25%ã«è¨­å®š (æ„Ÿåº¦ã‚’ä¸‹ã’ã‚‹)
                const swipeThreshold = window.innerWidth * 0.25; 

                let newColumnIndex = currentColumnIndex;
                if (diff < -swipeThreshold) { // å·¦æ–¹å‘ã¸ã®ã‚¹ãƒ¯ã‚¤ãƒ—
                    newColumnIndex = Math.min(columns.length - 1, currentColumnIndex + 1);
                } else if (diff > swipeThreshold) { // å³æ–¹å‘ã¸ã®ã‚¹ãƒ¯ã‚¤ãƒ—
                    newColumnIndex = Math.max(0, currentColumnIndex - 1);
                }
                // é–¾å€¤ä»¥ä¸‹ã®å ´åˆã¯å…ƒã®ä½ç½®ã«æˆ»ã‚‹ï¼ˆnewColumnIndexã¯å¤‰æ›´ã•ã‚Œãªã„ï¼‰
                
                columnsWrapper.style.transition = 'transform 0.3s ease-out';
                showColumn(newColumnIndex);
                
                // æœ€å¾Œã«ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                isSwiping = false;
                isScrolling = false;
            }, { passive: true });

            window.addEventListener('resize', () => {
                showColumn(currentColumnIndex); 
                autoResizeAllTextareas(); 
            });

            showColumn(currentColumnIndex);
        });

    </script>
</body>
</html>

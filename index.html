<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Êº´Áîª„Éç„Éº„É†„Ç®„Éá„Ç£„Çø.ver1</title>

    <!-- PWA & Favicon -->
    <link rel="manifest" href="/MNE/manifest.json">
    <link rel="apple-touch-icon" href="/MNE/icon192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/MNE/icon180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/MNE/icon32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/MNE/icon16.png">

    <!-- Viewport -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <style>
        /* Âü∫Êú¨„É¨„Ç§„Ç¢„Ç¶„Éà */
        html {
            height: 100%;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100%; 
            display: flex;
            flex-direction: column;
            background-color: #e0e0e0;
            overflow: hidden;
            touch-action: pan-y; /* Á∏¶„Çπ„ÇØ„É≠„Éº„É´„ÇíÂÑ™ÂÖà */
        }
        .columns-wrapper {
            flex-grow: 1;
            display: flex;
            width: 100%;
            height: 0; /* flex-grow„ÇíÊ≠£„Åó„ÅèÊ©üËÉΩ„Åï„Åõ„Çã„Åü„ÇÅ„ÅÆ„Éè„ÉÉ„ÇØ */
            overflow-x: auto;
            transition: none;
        }
        .column {
            width: 25vw;
            flex-shrink: 0;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #eee;
            box-sizing: border-box;
            height: 100%;
            overflow: hidden;
        }
        .column:last-child {
            border-right: none;
        }
        .column-header {
            background-color: #34495e;
            color: white;
            padding: 10px;
            font-weight: bold;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .column-header .header-title {
            flex-shrink: 0;
            margin-right: auto;
        }
        .column-header .controls {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: flex-end;
            align-items: center;
        }
        .column-header .controls button {
            background-color: #6c757d;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
            margin-left: 5px;
        }
        .column-header .controls button:hover {
            background-color: #5a6268;
        }
        .column-header .controls button:disabled {
            background-color: #999;
            cursor: not-allowed;
        }
        .column-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
        }

        /* „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢ÂÖ±ÈÄö */
        textarea {
            width: 100%;
            height: auto;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Meiryo', 'Hiragino Kaku Gothic ProN', 'BIZ UDPGothic', sans-serif;
            font-size: 1em;
            line-height: 1.6;
            resize: none;
            box-sizing: border-box;
            min-height: 50px;
            overflow: hidden;
        }
        .main-textarea { resize: vertical; }
        .outline-textarea { resize: vertical; }
        .character-textarea { min-height: 70vh; resize: vertical; overflow-y: auto; }

        /* ÂãïÁöÑÁîüÊàêË¶ÅÁ¥† */
        .scene-item-container {
            border: 1px solid #ccc;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }
        .scene-color-0 { background-color: #e0f7fa; }
        .scene-color-1 { background-color: #f0f4c3; }
        .scene-color-2 { background-color: #ffe0b2; }
        .scene-color-3 { background-color: #e1bee7; }
        .scene-color-4 { background-color: #b3e5fc; }

        .page-item-container {
            border: 1px solid #ccc;
            margin-bottom: 5px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: pointer;
        }
        .serif-page-group-container {
            border: 1px solid #dcdcdc;
            border-radius: 5px;
            margin-bottom: 15px;
            padding: 10px;
            padding-top: 0;
            background-color: #fffbf0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .dialogue-content {
            margin-bottom: 8px;
            background-color: white;
            border: 1px solid #ddd;
            border-left: 3px solid #f9ab00;
            padding: 5px;
            border-radius: 3px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.95em;
            line-height: 1.6;
            cursor: pointer;
        }
        .scene-item-header, .page-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
        }
        .scene-title-badge, .page-title-badge {
            background-color: #007bff;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        .delete-scene-btn, .delete-page-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .delete-scene-btn:hover, .delete-page-btn:hover { background-color: #c82333; }
        .add-page-to-scene-btn {
            background-color: #34495e;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            width: calc(100% - 20px);
            box-sizing: border-box;
            margin: 10px;
            text-align: center;
        }
        .add-page-to-scene-btn:hover { background-color: #2c3e50; }

        /* „Çª„ÇØ„Ç∑„Éß„É≥Êäò„Çä„Åü„Åü„Åø */
        .section-container {
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            background-color: #f8f8f8;
            overflow: hidden;
        }
        .section-header {
            background-color: #f0f0f0;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
        }
        .section-header h3 { margin: 0; font-size: 1em; color: #333; flex-grow: 1; }
        .toggle-btn, .add-character-btn {
            background-color: #6c757d;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 5px;
        }
        .toggle-btn:hover, .add-character-btn:hover { background-color: #5a6268; }
        .section-content { padding: 10px; }
        .section-content.hidden { display: none; }

        /* „Ç¢„ÇØ„ÉÜ„Ç£„ÉñË¶ÅÁ¥†„ÅÆ„Éè„Ç§„É©„Ç§„Éà */
        .scene-item-container.active, .page-item-container.active, .dialogue-content.active { 
            box-shadow: 0 0 8px 3px rgba(0, 123, 255, 0.5);
            border-color: #007bff;
        }

        /* „Çø„Éñ„Éê„Éº */
        .tab-bar {
            display: none;
            background: white;
            border-top: 1px solid #ddd;
            flex-shrink: 0;
            height: 60px;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
        }
        .tab-item {
            flex: 1;
            padding: 8px 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            position: relative;
            color: #666;
        }
        .tab-item.active { color: #1a73e8; }
        .tab-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 10%;
            right: 10%;
            height: 3px;
            background: #1a73e8;
            border-radius: 0 0 3px 3px;
        }
        .tab-icon { font-size: 22px; }
        .tab-label { font-size: 10px; }

        /* --- „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥Ë°®Á§∫Áî®„ÅÆ„Çπ„Çø„Ç§„É´Ôºà„ÇØ„É©„ÇπÂà∂Âæ°Ôºâ --- */
        body.mobile-view .tab-bar {
            display: flex;
        }
        body.mobile-view .columns-wrapper {
            width: 100%; /* Ë¶™„ÅØ100%ÂπÖ */
            overflow-x: auto; /* Â≠êË¶ÅÁ¥†„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„ÇíË®±ÂèØ */
            scroll-snap-type: x mandatory; /* „Çπ„ÉØ„Ç§„ÉóÊôÇ„Å´„Ç´„É©„É†„Åß„Éî„Çø„ÉÉ„Å®Ê≠¢„Åæ„Çã */
            -webkit-overflow-scrolling: touch; /* iOS„Åß„ÅÆÊÖ£ÊÄß„Çπ„ÇØ„É≠„Éº„É´ */
        }
        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÇíÈùûË°®Á§∫„Å´„Åô„Çã */
        body.mobile-view .columns-wrapper::-webkit-scrollbar { display: none; }
        body.mobile-view .columns-wrapper { -ms-overflow-style: none; scrollbar-width: none; }
        
        body.mobile-view .column {
            width: 100vw; /* ÂêÑ„Ç´„É©„É†„ÅØÁîªÈù¢ÂπÖ„ÅÑ„Å£„Å±„ÅÑ */
            border-right: none;
            scroll-snap-align: start; /* „Çπ„Éä„ÉÉ„Éó‰ΩçÁΩÆ„Çí„Ç´„É©„É†„ÅÆÈñãÂßãÁÇπ„Å´Ë®≠ÂÆö */
        }
        body.mobile-view .column-header {
            flex-direction: column;
            align-items: flex-start;
            padding: 8px;
        }
        body.mobile-view .column-header .header-title {
            margin-right: 0;
            margin-bottom: 5px;
        }
        body.mobile-view .column-header .controls {
            width: 100%;
            justify-content: space-around;
        }
        body.mobile-view .column-header .controls button {
            flex-grow: 1;
            margin-left: 0;
            padding: 8px 5px;
            font-size: 1em;
        }
        /* „Éú„Çø„É≥„Åå1„Å§„ÅÆ„Éò„ÉÉ„ÉÄ„Éº„Çí1Ë°å„Å´Êàª„Åô */
        body.mobile-view .scene-column .column-header,
        body.mobile-view .serif-column .column-header {
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }
        body.mobile-view .scene-column .column-header .header-title,
        body.mobile-view .serif-column .column-header .header-title {
            margin-bottom: 0;
        }
        body.mobile-view .scene-column .column-header .controls,
        body.mobile-view .serif-column .column-header .controls {
            width: auto;
        }
        body.mobile-view .scene-column .column-header .controls button,
        body.mobile-view .serif-column .column-header .controls button {
            flex-grow: 0;
            padding: 6px 12px;
        }

        /* 480px‰ª•‰∏ã„ÅÆ„Åï„Çâ„Å´Â∞è„Åï„ÅÑÁîªÈù¢„Å∏„ÅÆÂØæÂøú */
        @media (max-width: 480px) {
            .column-header .controls button { font-size: 0.9em; padding: 6px 3px; }
            .section-header h3 { font-size: 0.9em; }
            .toggle-btn, .add-character-btn { font-size: 0.7em; padding: 3px 6px; }
            textarea { font-size: 0.9em; }
        }
    </style>
</head>
<body>
    <div class="columns-wrapper" id="columnsWrapper">
        <div class="column main-column" data-column-id="main">
            <div class="column-header">
                <span class="header-title">„É°„Ç§„É≥</span>
                <div class="controls">
                    <button id="viewModeBtn" title="Ë°®Á§∫„É¢„Éº„Éâ„ÇíÂàá„ÇäÊõø„Åà„Åæ„Åô">Ë°®Á§∫ÂàáÊõø</button>
                    <button id="newBtn">Êñ∞Ë¶è</button>
                    <button id="openBtn">Èñã„Åè</button>
                    <input type="file" id="fileInput" style="display: none;">
                    <button id="saveBtn">‰øùÂ≠ò</button>
                    <button id="saveAsBtn">Âà•Âêç‰øùÂ≠ò</button>
                    <button id="undoBtn">‚Ü∂</button>
                    <button id="redoBtn">‚Ü∑</button>
                </div>
            </div>
            <div class="column-content">
                <div class="section-container" id="outlineSection">
                    <div class="section-header">
                        <h3>„Ç¢„Ç¶„Éà„É©„Ç§„É≥</h3>
                        <button class="toggle-btn" data-target="outlineContent">Èö†„Åô</button>
                    </div>
                    <div class="section-content" id="outlineContent">
                        <textarea id="outlineEditor" class="outline-textarea" placeholder="„Åì„Åì„Å´Áâ©Ë™û„ÅÆ„Ç¢„Ç¶„Éà„É©„Ç§„É≥„ÇíË®òËø∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"></textarea>
                    </div>
                </div>
                
                <div class="section-container" id="characterSection">
                    <div class="section-header">
                        <h3>„Ç≠„É£„É©„ÇØ„Çø„Éº</h3>
                        <div class="controls">
                            <button class="add-character-btn" id="addCharacterBtn">ËøΩÂä†</button>
                            <button class="toggle-btn" data-target="characterContent">Èö†„Åô</button>
                        </div>
                    </div>
                    <div class="section-content" id="characterContent">
                        <textarea id="characterEditor" class="character-textarea"></textarea>
                    </div>
                </div>

                <div class="section-container" id="mainEditorSection">
                    <div class="section-header">
                        <h3>„Éç„Éº„É†Êú¨‰Ωì (XML)</h3>
                        <button class="toggle-btn" data-target="mainEditorContent">Èö†„Åô</button>
                    </div>
                    <div class="section-content" id="mainEditorContent">
                        <textarea id="mainEditor" class="main-textarea" placeholder="XMLÂΩ¢Âºè„Åß„Éç„Éº„É†„ÇíË®òËø∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰æãÔºö<root><„Ç∑„Éº„É≥><„Ç∑„Éº„É≥Ë™¨Êòé>Êñ∞„Åó„ÅÑ„Ç∑„Éº„É≥</„Ç∑„Éº„É≥Ë™¨Êòé><„Éö„Éº„Ç∏><„Éö„Éº„Ç∏Ë™¨Êòé>Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏</„Éö„Éº„Ç∏Ë™¨Êòé><„Çª„É™„Éï>„Çª„É™„ÉïA</„Çª„É™„Éï></„Éö„Éº„Ç∏></„Ç∑„Éº„É≥></root>"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="column scene-column" data-column-id="scene">
            <div class="column-header">
                <span class="header-title">„Ç∑„Éº„É≥</span>
                <div class="controls">
                    <button id="addSceneBtn">„Ç∑„Éº„É≥ËøΩÂä†</button>
                </div>
            </div>
            <div class="column-content" id="sceneContent"></div>
        </div>

        <div class="column page-column" data-column-id="page">
            <div class="column-header">
                <span class="header-title">„Éö„Éº„Ç∏</span>
            </div>
            <div class="column-content" id="pageContent"></div>
        </div>

        <div class="column serif-column" data-column-id="serif">
            <div class="column-header">
                <span class="header-title">„Çª„É™„Éï</span>
                <div class="controls">
                    <button id="exportDialogueBtn">„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                </div>
            </div>
            <div class="column-content" id="dialogueContent"></div>
        </div>
    </div>

    <!-- „Çø„Éñ„Éê„ÉºÔºà„É¢„Éê„Ç§„É´Áî®Ôºâ -->
    <div class="tab-bar">
        <div class="tab-item active" data-page="0">
            <span class="tab-icon">üìù</span>
            <span class="tab-label">„É°„Ç§„É≥</span>
        </div>
        <div class="tab-item" data-page="1">
            <span class="tab-icon">üé¨</span>
            <span class="tab-label">„Ç∑„Éº„É≥</span>
        </div>
        <div class="tab-item" data-page="2">
            <span class="tab-icon">üìÑ</span>
            <span class="tab-label">„Éö„Éº„Ç∏</span>
        </div>
        <div class="tab-item" data-page="3">
            <span class="tab-icon">üí¨</span>
            <span class="tab-label">„Çª„É™„Éï</span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bodyElement = document.body;
            const columnsWrapper = document.getElementById('columnsWrapper');
            const columns = document.querySelectorAll('.column');
            const viewModeBtn = document.getElementById('viewModeBtn');
            const tabItems = document.querySelectorAll('.tab-item');

            const mainEditor = document.getElementById('mainEditor');
            const outlineEditor = document.getElementById('outlineEditor');
            const characterEditor = document.getElementById('characterEditor');
            
            const sceneContentDiv = document.getElementById('sceneContent');
            const pageContentDiv = document.getElementById('pageContent');
            const dialogueContentDiv = document.getElementById('dialogueContent');

            const outlineContentDiv = document.getElementById('outlineContent');
            const characterContentDiv = document.getElementById('characterContent');
            const mainEditorContentDiv = document.getElementById('mainEditorContent');

            // --- Áä∂ÊÖãÁÆ°ÁêÜ ---
            let currentColumnIndex = 0;
            let currentFileName = 'Êñ∞Ë¶è„Éç„Éº„É†.txt';
            let currentFileHandle = null;
            let history = [''];
            let historyIndex = 0;
            const MAX_HISTORY = 100;
            let updateTimeout;
            const DEBOUNCE_DELAY = 300;
            let currentXmlDoc = null;
            const xmlParser = new DOMParser();
            let nodeIdCounter = 0;
            const sceneNodeIdToDomElementMap = new Map();
            const pageNodeIdToDomElementMap = new Map();
            const sceneNodeIdToFirstPageDomElementMap = new Map();
            const dialogueNodeIdToDomElementMap = new Map();
            let activeSceneElement = null;
            let activePageElement = null;
            let activeDialogueElement = null;

            // --- UIÂà∂Âæ° ---
            function showColumn(index, behavior = 'smooth') {
                if (index < 0 || index >= columns.length) return;
                currentColumnIndex = index;
                saveState();

                const targetScrollLeft = columns[index].offsetLeft;
                columnsWrapper.scrollTo({
                    left: targetScrollLeft,
                    behavior: behavior
                });
                
                if (document.body.classList.contains('mobile-view')) {
                    updateActiveTab();
                }
            }
            
            function updateActiveTab() {
                tabItems.forEach(tab => tab.classList.remove('active'));
                const activeTab = document.querySelector(`.tab-item[data-page='${currentColumnIndex}']`);
                if (activeTab) activeTab.classList.add('active');
            }

            // --- Ë°®Á§∫„É¢„Éº„ÉâÂàáÊõø ---
            function applyViewMode() {
                const override = localStorage.getItem('viewModeOverride');
                const isMobile = (override === 'mobile') || (override === null && window.innerWidth <= 768);
                
                if (isMobile) {
                    bodyElement.classList.add('mobile-view');
                } else {
                    bodyElement.classList.remove('mobile-view');
                }

                viewModeBtn.textContent = override ? 'Ëá™Âãï„Å´Êàª„Åô' : 'Ë°®Á§∫ÂàáÊõø';
                viewModeBtn.title = override ? '„Ç¶„Ç£„É≥„Éâ„Ç¶ÂπÖ„Å´Âøú„Åò„ÅüËá™ÂãïË°®Á§∫„Å´Êàª„Åó„Åæ„Åô' : 'ÁèæÂú®„ÅÆË°®Á§∫„ÇíPC‚áî„Çπ„Éû„Éõ„ÅßÂàá„ÇäÊõø„Åà„Åæ„Åô';
                
                showColumn(currentColumnIndex, 'auto'); // „É¢„Éº„ÉâÂ§âÊõ¥ÊôÇ„ÅØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Å™„Åó„ÅßÂç≥ÊôÇÂèçÊò†
                autoResizeAllTextareas();
            }

            viewModeBtn.addEventListener('click', () => {
                const override = localStorage.getItem('viewModeOverride');
                if (override) {
                    localStorage.removeItem('viewModeOverride');
                } else {
                    const isCurrentlyMobile = bodyElement.classList.contains('mobile-view');
                    localStorage.setItem('viewModeOverride', isCurrentlyMobile ? 'pc' : 'mobile');
                }
                applyViewMode();
            });
            
            // --- Undo/Redo & Â±•Ê≠¥ÁÆ°ÁêÜ ---
            function undo() {
                if (historyIndex > 0) {
                    historyIndex--;
                    mainEditor.value = history[historyIndex];
                    updateUIImmediate();
                }
            }
            function redo() {
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    mainEditor.value = history[historyIndex];
                    updateUIImmediate();
                }
            }
            function updateUndoRedoButtons() {
                document.getElementById('undoBtn').disabled = historyIndex === 0;
                document.getElementById('redoBtn').disabled = historyIndex === history.length - 1;
            }
            function addToHistory(content) {
                if (history.length > 0 && history[historyIndex] === content) return;
                if (historyIndex < history.length - 1) {
                    history = history.slice(0, historyIndex + 1);
                }
                history.push(content);
                if (history.length > MAX_HISTORY) {
                    history.shift();
                } else {
                    historyIndex++;
                }
                updateUndoRedoButtons();
            }

            // --- „Éá„Éº„ÇøÊ∞∏Á∂öÂåñ (localStorage) ---
            function saveState() {
                const state = {
                    outlineContent: outlineEditor.value,
                    characterContent: characterEditor.value,
                    mainContent: mainEditor.value,
                    fileName: currentFileName,
                    history: history,
                    historyIndex: historyIndex,
                    outlineHidden: outlineContentDiv.classList.contains('hidden'),
                    characterHidden: characterContentDiv.classList.contains('hidden'),
                    mainEditorHidden: mainEditorContentDiv.classList.contains('hidden'),
                    currentColumnIndex: currentColumnIndex
                };
                localStorage.setItem('comicNameEditorState', JSON.stringify(state));
            }
            function loadState() {
                const savedState = localStorage.getItem('comicNameEditorState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    outlineEditor.value = state.outlineContent || '';
                    characterEditor.value = state.characterContent || '';
                    mainEditor.value = state.mainContent || '';
                    currentFileName = state.fileName || 'Êñ∞Ë¶è„Éç„Éº„É†.txt';
                    history = state.history || [''];
                    historyIndex = state.historyIndex || 0;
                    setSectionVisibility(outlineContentDiv, state.outlineHidden || false);
                    setSectionVisibility(characterContentDiv, state.characterHidden || false);
                    setSectionVisibility(mainEditorContentDiv, state.mainEditorHidden || false);
                    currentColumnIndex = state.currentColumnIndex !== undefined ? state.currentColumnIndex : 0;
                } else {
                    clearAllEditors(false); // „Ç¢„É©„Éº„Éà„Å™„Åó„ÅßÂàùÊúüÂåñ
                }
                updateUIImmediate();
                applyViewMode(); // ÊúÄÂæå„Å´Ë°®Á§∫„É¢„Éº„Éâ„ÇíÈÅ©Áî®
            }
            function setSectionVisibility(contentDiv, isHidden) {
                const toggleBtn = contentDiv.previousElementSibling.querySelector('.toggle-btn');
                if (isHidden) {
                    contentDiv.classList.add('hidden');
                    if (toggleBtn) toggleBtn.textContent = 'Èñã„Åè';
                } else {
                    contentDiv.classList.remove('hidden');
                    if (toggleBtn) toggleBtn.textContent = 'Èö†„Åô';
                }
            }
            
            // --- „Éï„Ç°„Ç§„É´Êìç‰Ωú ---
            function clearAllEditors(showAlert = true) {
                outlineEditor.value = '';
                characterEditor.value = `*‰∏ª‰∫∫ÂÖ¨ÔºàÂêçÂâçÔºöË™≠„ÅøÊñπ„ÄÅÊÑõÁß∞ÔºâÁî∑Â•≥„ÄÅÊ≠≥\n*Èñ¢‰øÇÊÄß\n*Ë¶ã„ÅüÁõÆ„ÄÅË∫´‰ΩìÁöÑÁâπÂæ¥„ÄÅÊúçË£Ö\n*ÊÄßÊ†º„ÉªË£èÊÄßÊ†º\n*Áí∞Â¢É„ÉªÁîü„ÅÑÁ´ã„Å°`;
                mainEditor.value = `<root><„Ç∑„Éº„É≥><„Ç∑„Éº„É≥Ë™¨Êòé>Êñ∞„Åó„ÅÑ„Ç∑„Éº„É≥</„Ç∑„Éº„É≥Ë™¨Êòé><„Éö„Éº„Ç∏><„Éö„Éº„Ç∏Ë™¨Êòé>Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏</„Éö„Éº„Ç∏Ë™¨Êòé></„Éö„Éº„Ç∏></„Ç∑„Éº„É≥></root>`;
                currentFileName = 'Êñ∞Ë¶è„Éç„Éº„É†.txt';
                currentFileHandle = null;
                history = [mainEditor.value];
                historyIndex = 0;
                localStorage.removeItem('comicNameEditorState');
                setSectionVisibility(outlineContentDiv, false);
                setSectionVisibility(characterContentDiv, false);
                setSectionVisibility(mainEditorContentDiv, false);
                currentColumnIndex = 0;
                updateUIImmediate();
                if (showAlert) alert('Êñ∞„Åó„ÅÑ„Éç„Éº„É†„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü„ÄÇ');
            }
            async function openFile() {
                try {
                    const [fileHandle] = await window.showOpenFilePicker({ types: [{ description: 'Text Files', accept: { 'text/plain': ['.txt'] } }] });
                    const file = await fileHandle.getFile();
                    const text = await file.text();
                    extractAndSetSeparateContents(text);
                    currentFileName = file.name;
                    currentFileHandle = fileHandle;
                    history = [mainEditor.value];
                    historyIndex = 0;
                    updateUIImmediate();
                } catch (err) {
                    if (err.name !== 'AbortError') console.error('Error opening file:', err);
                }
            }
            async function saveFile(saveAs = false) {
                const content = `[„Ç¢„Ç¶„Éà„É©„Ç§„É≥:]\n${outlineEditor.value}\n\n[„Ç≠„É£„É©„ÇØ„Çø„Éº:]\n${characterEditor.value}\n\n[„Éç„Éº„É†Êú¨‰Ωì(XML):]\n${mainEditor.value}\n\n`;
                try {
                    let handleToSave = currentFileHandle;
                    if (saveAs || !handleToSave) {
                        handleToSave = await window.showSaveFilePicker({ types: [{ description: 'Text Files', accept: { 'text/plain': ['.txt'] } }], suggestedName: currentFileName });
                    }
                    const writable = await handleToSave.createWritable();
                    await writable.write(content);
                    await writable.close();
                    currentFileHandle = handleToSave;
                    currentFileName = handleToSave.name;
                    alert(`„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü: ${currentFileName}`);
                } catch (err) {
                    if (err.name !== 'AbortError') console.error('Error saving file:', err);
                }
            }
            function handleDrop(e) {
                e.preventDefault();
                document.body.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'text/plain') {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        extractAndSetSeparateContents(event.target.result);
                        currentFileName = file.name;
                        currentFileHandle = null;
                        history = [mainEditor.value];
                        historyIndex = 0;
                        updateUIImmediate();
                    };
                    reader.readAsText(file);
                }
            }
            function extractAndSetSeparateContents(fullText) {
                const extracted = { outline: '', character: '', main: '' };
                const outlineMatch = fullText.match(/\[„Ç¢„Ç¶„Éà„É©„Ç§„É≥:\]\n([\s\S]*?)(?=\n*\[(„Ç≠„É£„É©„ÇØ„Çø„Éº|„Éç„Éº„É†Êú¨‰Ωì\(XML\)):\]|$)/);
                const characterMatch = fullText.match(/\[„Ç≠„É£„É©„ÇØ„Çø„Éº:\]\n([\s\S]*?)(?=\n*\[„Éç„Éº„É†Êú¨‰Ωì\(XML\):\]|$)/);
                const mainXmlMatch = fullText.match(/\[„Éç„Éº„É†Êú¨‰Ωì\(XML\):\]\n([\s\S]*?)$/);
                
                extracted.outline = outlineMatch ? outlineMatch[1].trim() : '';
                extracted.character = characterMatch ? characterMatch[1].trim() : '';
                extracted.main = mainXmlMatch ? mainXmlMatch[1].trim() : (!outlineMatch && !characterMatch ? fullText : '');

                outlineEditor.value = extracted.outline;
                characterEditor.value = extracted.character;
                mainEditor.value = extracted.main;
            }

            // --- UIÊõ¥Êñ∞ & „Éë„Éº„ÇπÂá¶ÁêÜ ---
            function updateUI() {
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(() => {
                    updateUIImmediate(false);
                    saveState();
                }, DEBOUNCE_DELAY);
            }
            function updateUIImmediate(save = true) {
                updateUndoRedoButtons();
                syncColumnsFromMainEditor();
                setTimeout(autoResizeAllTextareas, 50);
                if (save) saveState();
            }
            function autoResizeAllTextareas() {
                document.querySelectorAll('textarea').forEach(textarea => {
                    if (!textarea || textarea.offsetParent === null) return;
                    textarea.style.height = 'auto';
                    textarea.style.height = (textarea.scrollHeight + 2) + 'px';
                });
            }

            function serializeXmlToCompactString(node) {
                let result = '';
                if (!node) return result;

                if (node.nodeType === Node.ELEMENT_NODE) {
                    result += `<${node.tagName}>`;
                    for (let child of node.childNodes) result += serializeXmlToCompactString(child);
                    result += `</${node.tagName}>`;
                } else if (node.nodeType === Node.TEXT_NODE) {
                    result += node.textContent
                                .replace(/&/g, '&')
                                .replace(/</g, '<')
                                .replace(/>/g, '>')
                                .replace(/"/g, '"')
                                .replace(/'/g, ''');
                }
                return result;
            }
            
            function syncColumnsFromMainEditor() {
                sceneNodeIdToDomElementMap.clear();
                pageNodeIdToDomElementMap.clear();
                sceneNodeIdToFirstPageDomElementMap.clear();
                dialogueNodeIdToDomElementMap.clear();
                nodeIdCounter = 0;

                let textToParse = mainEditor.value.trim();
                if (textToParse && (!textToParse.startsWith('<root>') || !textToParse.endsWith('</root>'))) {
                    textToParse = `<root>${textToParse}</root>`;
                } else if (!textToParse) {
                    textToParse = `<root></root>`;
                }

                currentXmlDoc = xmlParser.parseFromString(textToParse, 'application/xml');
                const parserError = currentXmlDoc.querySelector('parsererror');
                if (parserError) {
                    const errorMsg = '<p style="color: red;">XML„Éë„Éº„Çπ„Ç®„É©„Éº</p>';
                    sceneContentDiv.innerHTML = errorMsg;
                    pageContentDiv.innerHTML = errorMsg;
                    dialogueContentDiv.innerHTML = errorMsg;
                    return;
                }
                
                sceneContentDiv.innerHTML = '';
                pageContentDiv.innerHTML = '';
                dialogueContentDiv.innerHTML = '';

                const scenes = currentXmlDoc.querySelectorAll('„Ç∑„Éº„É≥');
                if (scenes.length === 0) {
                    sceneContentDiv.innerHTML = '<p>„Ç∑„Éº„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
                    pageContentDiv.innerHTML = '<p>„Ç∑„Éº„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
                    dialogueContentDiv.innerHTML = '<p>„Ç∑„Éº„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
                }

                let globalPageIndex = 1;
                scenes.forEach((sceneElement, sceneIndex) => {
                    renderSceneItem(sceneElement, sceneIndex);
                    const pagesInScene = sceneElement.querySelectorAll('„Éö„Éº„Ç∏');
                    
                    pagesInScene.forEach((pageElement, pageIndexInScene) => {
                        renderPageItem(pageElement, sceneIndex, pageIndexInScene, globalPageIndex);
                        const dialoguesInPage = pageElement.querySelectorAll('„Çª„É™„Éï');
                        if (dialoguesInPage.length > 0) {
                            renderDialogueGroup(dialoguesInPage, pageElement, sceneIndex, pageIndexInScene, globalPageIndex);
                        }
                        globalPageIndex++;
                    });
                    
                    const addPageButton = document.createElement('button');
                    addPageButton.className = 'add-page-to-scene-btn';
                    addPageButton.textContent = `„Äå„Ç∑„Éº„É≥${sceneIndex + 1}„Äç„Å´„Éö„Éº„Ç∏„ÇíËøΩÂä†`;
                    addPageButton.onclick = () => addPageToSpecificScene(sceneElement);
                    pageContentDiv.appendChild(addPageButton);
                });

                highlightActiveElements();
            }

            // --- ÂãïÁöÑË¶ÅÁ¥†„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞Èñ¢Êï∞Áæ§ ---
            function renderSceneItem(sceneElement, sceneIndex) {
                const nodeId = `node-${nodeIdCounter++}`;
                const sceneItemContainer = document.createElement('div');
                sceneItemContainer.className = `scene-item-container scene-color-${sceneIndex % 5}`;
                sceneItemContainer.dataset.nodeId = nodeId;
                sceneItemContainer.dataset.sceneIndex = sceneIndex;
                sceneItemContainer.onclick = () => {
                    setActiveElement(sceneItemContainer, 'scene');
                    const firstPageElement = sceneNodeIdToFirstPageDomElementMap.get(nodeId);
                    if (firstPageElement) {
                        setActiveElement(firstPageElement, 'page');
                        showColumn(2);
                    } else {
                        showColumn(2);
                    }
                };
                
                const header = document.createElement('div');
                header.className = 'scene-item-header';
                header.innerHTML = `<span class="scene-title-badge">„Ç∑„Éº„É≥${sceneIndex + 1}</span>`;
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-scene-btn';
                deleteBtn.textContent = 'ÂâäÈô§';
                deleteBtn.onclick = (e) => { e.stopPropagation(); deleteScene(sceneElement); };
                header.appendChild(deleteBtn);
                
                const textarea = document.createElement('textarea');
                textarea.value = sceneElement.querySelector('„Ç∑„Éº„É≥Ë™¨Êòé')?.textContent || '';
                textarea.placeholder = '„Ç∑„Éº„É≥„ÅÆË™¨Êòé';
                textarea.oninput = (e) => { autoResizeTextArea(e.target); updateSceneContentInXml(sceneIndex, e.target.value); };
                textarea.onchange = () => updateUIImmediate();
                
                sceneItemContainer.append(header, textarea);
                sceneContentDiv.appendChild(sceneItemContainer);
                sceneNodeIdToDomElementMap.set(nodeId, sceneItemContainer);
            }

            function renderPageItem(pageElement, sceneIndex, pageIndexInScene, globalPageIndex) {
                const nodeId = `node-${nodeIdCounter++}`;
                const parentSceneNodeId = [...sceneNodeIdToDomElementMap.keys()].find(key => sceneNodeIdToDomElementMap.get(key).dataset.sceneIndex == sceneIndex);

                const pageItemContainer = document.createElement('div');
                pageItemContainer.className = `page-item-container scene-color-${sceneIndex % 5}`;
                pageItemContainer.dataset.nodeId = nodeId;
                pageItemContainer.dataset.parentSceneId = parentSceneNodeId;
                pageItemContainer.dataset.sceneIndex = sceneIndex;
                pageItemContainer.dataset.pageIndexInScene = pageIndexInScene;
                pageItemContainer.onclick = () => { setActiveElement(pageItemContainer, 'page'); showColumn(2); };
                
                const header = document.createElement('div');
                header.className = 'page-item-header';
                header.innerHTML = `<span class="page-title-badge">„Éö„Éº„Ç∏${globalPageIndex}</span>`;
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-page-btn';
                deleteBtn.textContent = 'ÂâäÈô§';
                deleteBtn.onclick = (e) => { e.stopPropagation(); deletePage(pageElement); };
                header.appendChild(deleteBtn);
                
                const textarea = document.createElement('textarea');
                let combinedText = '';
                pageElement.childNodes.forEach(child => {
                    if (child.nodeName === '„Éö„Éº„Ç∏Ë™¨Êòé') combinedText += child.textContent;
                    else if (child.nodeName === '„Çª„É™„Éï') combinedText += `„Äå${child.textContent}„Äç`;
                });
                textarea.value = combinedText;
                textarea.placeholder = '„Éö„Éº„Ç∏„ÅÆË™¨Êòé„ÇÑ„Äå„Çª„É™„Éï„Äç';
                textarea.oninput = (e) => { autoResizeTextArea(e.target); updatePageContentInXml(sceneIndex, pageIndexInScene, e.target.value); };
                textarea.onchange = () => updateUIImmediate();
                
                pageItemContainer.append(header, textarea);
                pageContentDiv.appendChild(pageItemContainer);
                pageNodeIdToDomElementMap.set(nodeId, pageItemContainer);
                if (!sceneNodeIdToFirstPageDomElementMap.has(parentSceneNodeId)) {
                    sceneNodeIdToFirstPageDomElementMap.set(parentSceneNodeId, pageItemContainer);
                }
            }

            function renderDialogueGroup(dialoguesInPage, pageElement, sceneIndex, pageIndexInScene, globalPageIndex) {
                const parentPageNodeId = [...pageNodeIdToDomElementMap.keys()].find(key => pageNodeIdToDomElementMap.get(key).dataset.pageIndexInScene == pageIndexInScene && pageNodeIdToDomElementMap.get(key).dataset.sceneIndex == sceneIndex);
                
                const groupContainer = document.createElement('div');
                groupContainer.className = 'serif-page-group-container';
                groupContainer.innerHTML = `<p style="font-weight: bold; font-size: 0.9em; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px dashed #ccc;">„Éö„Éº„Ç∏ ${globalPageIndex}</p>`;
                
                dialoguesInPage.forEach((dialogueElement, dialogueIndexInPage) => {
                    const nodeId = `node-${nodeIdCounter++}`;
                    const dialogueDiv = document.createElement('div');
                    dialogueDiv.className = 'dialogue-content';
                    dialogueDiv.dataset.nodeId = nodeId;
                    dialogueDiv.dataset.parentPageId = parentPageNodeId;
                    dialogueDiv.dataset.sceneIndex = sceneIndex;
                    dialogueDiv.dataset.pageIndexInScene = pageIndexInScene;
                    dialogueDiv.dataset.dialogueIndexInPage = dialogueIndexInPage;
                    dialogueDiv.textContent = dialogueElement.textContent;
                    dialogueDiv.onclick = () => { setActiveElement(dialogueDiv, 'dialogue'); showColumn(3); };
                    
                    groupContainer.appendChild(dialogueDiv);
                    dialogueNodeIdToDomElementMap.set(nodeId, dialogueDiv);
                });
                dialogueContentDiv.appendChild(groupContainer);
            }
            
            function highlightActiveElements() {
                document.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
                if (activeSceneElement) activeSceneElement.classList.add('active');
                if (activePageElement) activePageElement.classList.add('active');
                if (activeDialogueElement) activeDialogueElement.classList.add('active');
            }

            function setActiveElement(element, type) {
                if (type === 'scene') {
                    activeSceneElement = element;
                    activePageElement = null; 
                    activeDialogueElement = null;
                } else if (type === 'page') {
                    activePageElement = element;
                    activeDialogueElement = null;
                    const parentSceneId = element.dataset.parentSceneId;
                    activeSceneElement = parentSceneId ? sceneNodeIdToDomElementMap.get(parentSceneId) : null;
                } else if (type === 'dialogue') {
                    activeDialogueElement = element;
                    const parentPageId = element.dataset.parentPageId;
                    activePageElement = parentPageId ? pageNodeIdToDomElementMap.get(parentPageId) : null;
                    if (activePageElement) {
                        const parentSceneId = activePageElement.dataset.parentSceneId;
                        activeSceneElement = parentSceneId ? sceneNodeIdToDomElementMap.get(parentSceneId) : null;
                    }
                }
                highlightActiveElements();
            }

            // --- XMLÊõ¥Êñ∞Èñ¢Êï∞ ---
            function updateSceneContentInXml(sceneIndex, newText) {
                const sceneElement = currentXmlDoc.querySelectorAll('„Ç∑„Éº„É≥')[sceneIndex];
                if (sceneElement) {
                    let desc = sceneElement.querySelector('„Ç∑„Éº„É≥Ë™¨Êòé');
                    if (!desc) {
                        desc = currentXmlDoc.createElement('„Ç∑„Éº„É≥Ë™¨Êòé');
                        sceneElement.insertBefore(desc, sceneElement.firstChild);
                    }
                    desc.textContent = newText;
                    mainEditor.value = serializeXmlToCompactString(currentXmlDoc.documentElement);
                    addToHistory(mainEditor.value);
                }
            }
            function updatePageContentInXml(sceneIndex, pageIndexInScene, fullPageText) {
                const pageElement = currentXmlDoc.querySelectorAll('„Ç∑„Éº„É≥')[sceneIndex]?.querySelectorAll('„Éö„Éº„Ç∏')[pageIndexInScene];
                if (pageElement) {
                    while (pageElement.firstChild) pageElement.removeChild(pageElement.firstChild);
                    
                    const dialogueRegex = /„Äå([\s\S]*?)„Äç/g;
                    let lastIndex = 0;
                    let match;
                    while ((match = dialogueRegex.exec(fullPageText)) !== null) {
                        if (match.index > lastIndex) {
                            const desc = currentXmlDoc.createElement('„Éö„Éº„Ç∏Ë™¨Êòé');
                            desc.textContent = fullPageText.substring(lastIndex, match.index);
                            pageElement.appendChild(desc);
                        }
                        const dialogue = currentXmlDoc.createElement('„Çª„É™„Éï');
                        dialogue.textContent = match[1];
                        pageElement.appendChild(dialogue);
                        lastIndex = dialogueRegex.lastIndex;
                    }
                    if (lastIndex < fullPageText.length) {
                        const desc = currentXmlDoc.createElement('„Éö„Éº„Ç∏Ë™¨Êòé');
                        desc.textContent = fullPageText.substring(lastIndex);
                        pageElement.appendChild(desc);
                    }
                    mainEditor.value = serializeXmlToCompactString(currentXmlDoc.documentElement);
                    addToHistory(mainEditor.value);
                }
            }
            function addScene() {
                const root = currentXmlDoc.querySelector('root');
                if (root) {
                    const scene = currentXmlDoc.createElement('„Ç∑„Éº„É≥');
                    const desc = currentXmlDoc.createElement('„Ç∑„Éº„É≥Ë™¨Êòé');
                    desc.textContent = 'Êñ∞„Åó„ÅÑ„Ç∑„Éº„É≥';
                    scene.appendChild(desc);
                    root.appendChild(scene);
                    mainEditor.value = serializeXmlToCompactString(currentXmlDoc.documentElement);
                    updateUIImmediate();
                    mainEditor.focus();
                }
            }
            function addPageToSpecificScene(sceneElement) {
                if (sceneElement) {
                    const page = currentXmlDoc.createElement('„Éö„Éº„Ç∏');
                    const desc = currentXmlDoc.createElement('„Éö„Éº„Ç∏Ë™¨Êòé');
                    desc.textContent = 'Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏';
                    page.appendChild(desc);
                    sceneElement.appendChild(page);
                    mainEditor.value = serializeXmlToCompactString(currentXmlDoc.documentElement);
                    updateUIImmediate();
                    mainEditor.focus();
                }
            }
            function deleteScene(sceneElement) {
                if (confirm('„Åì„ÅÆ„Ç∑„Éº„É≥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                    sceneElement.remove();
                    mainEditor.value = serializeXmlToCompactString(currentXmlDoc.documentElement);
                    updateUIImmediate();
                }
            }
            function deletePage(pageElement) {
                if (confirm('„Åì„ÅÆ„Éö„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                    pageElement.remove();
                    mainEditor.value = serializeXmlToCompactString(currentXmlDoc.documentElement);
                    updateUIImmediate();
                }
            }
            function exportDialogues() {
                const allDialogues = Array.from(dialogueContentDiv.querySelectorAll('.serif-page-group-container')).map(group => {
                    return Array.from(group.querySelectorAll('.dialogue-content')).map(d => d.textContent).join('\n\n');
                }).join('\n\n\n');
                
                if (!allDialogues) {
                    alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Çª„É™„Éï„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                    return;
                }
                
                const blob = new Blob([allDialogues], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `„Çª„É™„Éï_${new Date().toISOString().slice(0,19).replace(/[-T:]/g,"")}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }

            // --- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö ---
            document.getElementById('newBtn').onclick = () => clearAllEditors();
            document.getElementById('openBtn').onclick = openFile;
            document.getElementById('saveBtn').onclick = () => saveFile(false);
            document.getElementById('saveAsBtn').onclick = () => saveFile(true);
            document.getElementById('undoBtn').onclick = undo;
            document.getElementById('redoBtn').onclick = redo;
            document.getElementById('addSceneBtn').onclick = addScene;
            document.getElementById('exportDialogueBtn').onclick = exportDialogues;
            document.getElementById('addCharacterBtn').onclick = () => {
                characterEditor.value += `\n\n‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï\n*Êñ∞„Åó„ÅÑ„Ç≠„É£„É©„ÇØ„Çø„Éº`;
                autoResizeTextArea(characterEditor);
            };
            mainEditor.oninput = () => { autoResizeTextArea(mainEditor); updateUI(); };
            mainEditor.onchange = () => { addToHistory(mainEditor.value); updateUIImmediate(); };
            outlineEditor.onchange = saveState;
            characterEditor.onchange = saveState;
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.onclick = (e) => setSectionVisibility(document.getElementById(e.target.dataset.target), !document.getElementById(e.target.dataset.target).classList.contains('hidden')));
            document.body.ondragover = (e) => { e.preventDefault(); document.body.classList.add('drag-over'); };
            document.body.ondragleave = () => document.body.classList.remove('drag-over');
            document.body.ondrop = handleDrop;
            
            tabItems.forEach(tab => {
                tab.addEventListener('click', () => {
                    const pageIndex = parseInt(tab.dataset.page, 10);
                    showColumn(pageIndex);
                });
            });

            // „Çπ„Éû„ÉõË°®Á§∫ÊôÇ„ÅÆ„Çπ„ÉØ„Ç§„ÉóÂÆå‰∫ÜÊ§úÁü•
            let scrollTimeout;
            columnsWrapper.addEventListener('scroll', () => {
                if (!bodyElement.classList.contains('mobile-view')) return;
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const columnWidth = columnsWrapper.offsetWidth;
                    const newIndex = Math.round(columnsWrapper.scrollLeft / columnWidth);
                    if (newIndex !== currentColumnIndex) {
                        currentColumnIndex = newIndex;
                        updateActiveTab();
                        saveState();
                    }
                }, 150);
            });
            
            // --- ÂàùÊúüÂåñ ---
            function adjustHeight() {
                const vh = window.innerHeight;
                bodyElement.style.height = `${vh}px`;
            }
            window.addEventListener('resize', () => { adjustHeight(); applyViewMode(); });
            window.addEventListener('orientationchange', adjustHeight);
            
            // Service Worker„ÅÆÁôªÈå≤
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/MNE/sw.js').catch(err => console.log('ServiceWorker registration failed: ', err));
                });
            }

            adjustHeight();
            loadState();
        });
    </script>
</body>
</html>
